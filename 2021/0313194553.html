<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Redis学习笔记(七)——数据库 | PC&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="前言介绍Redis数据库的实现，解答以下几个问题：  Redis服务器是怎么保存数据库的？客户端又是怎么切换数据库的？ 数据库的增、删、改、查的实现 键的过期时间是怎么保存的，又是如何删除的？怎么判断一个键是否过期？ 过期键的删除策略有哪些？每种策略的优缺点分析？Redis采用的是哪种策略，具体又是怎么实现的？">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis学习笔记(七)——数据库">
<meta property="og:url" content="https://pcj600.github.io/2021/0313194553.html">
<meta property="og:site_name" content="PC&#39;s Blog">
<meta property="og:description" content="前言介绍Redis数据库的实现，解答以下几个问题：  Redis服务器是怎么保存数据库的？客户端又是怎么切换数据库的？ 数据库的增、删、改、查的实现 键的过期时间是怎么保存的，又是如何删除的？怎么判断一个键是否过期？ 过期键的删除策略有哪些？每种策略的优缺点分析？Redis采用的是哪种策略，具体又是怎么实现的？">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-13T11:45:53.000Z">
<meta property="article:modified_time" content="2024-08-18T11:48:11.408Z">
<meta property="article:author" content="PC">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="PC's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">PC&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Life is short, Play more!</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://pcj600.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="next-2021-03-13-redis-note-07-database" class="h-entry article article-type-next" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/0313194553.html" class="article-date">
  <time class="dt-published" datetime="2021-03-13T11:45:53.000Z" itemprop="datePublished">2021-03-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Redis/">Redis</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Redis学习笔记(七)——数据库
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>介绍Redis数据库的实现，解答以下几个问题：</p>
<ul>
<li>Redis服务器是怎么保存数据库的？客户端又是怎么切换数据库的？</li>
<li>数据库的增、删、改、查的实现</li>
<li>键的过期时间是怎么保存的，又是如何删除的？怎么判断一个键是否过期？</li>
<li>过期键的删除策略有哪些？每种策略的优缺点分析？Redis采用的是哪种策略，具体又是怎么实现的？</li>
</ul>
<span id="more"></span>

<h3 id="服务器中的数据库"><a href="#服务器中的数据库" class="headerlink" title="服务器中的数据库"></a>服务器中的数据库</h3><p>Redis将所有数据库都保存在服务器状态 <code>server.h/redisServer</code>结构的db数组中，db数组中的每一项表示一个数据库, dbnum表示数据库个数。 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	redisDb *db;	<span class="comment">// db数组保存所有数据库</span></span><br><span class="line">    <span class="type">int</span> dbnum;		<span class="comment">// 表示数据库个数</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>服务器初始化时，默认创建16个数据库。可以通过修改配置文件的databases选项更改数据库的数量。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># modify /etc/redis/redis.conf</span><br><span class="line">databases 16</span><br></pre></td></tr></table></figure>

<p>客户端可通过<code>config get databases</code>命令查看数据库的数量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get databases</span><br><span class="line">1) &quot;databases&quot;</span><br><span class="line">2) &quot;16&quot;</span><br></pre></td></tr></table></figure>

<h3 id="客户端切换数据库"><a href="#客户端切换数据库" class="headerlink" title="客户端切换数据库"></a>客户端切换数据库</h3><p>每个客户端都有自己的目标数据库，默认情况下客户端的目标数据库为0号数据库。客户端可以通过执行<code>SELECT [dbid]</code> 命令切换目标数据库。</p>
<p>Redis服务器中，使用redisClient结构(6.0版本此结构体名称改为client)表示客户端属性，结构中的db属性表示客户端的目标数据库，如下：;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></span><br><span class="line">	redisDb *db;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125; redisClient;</span><br></pre></td></tr></table></figure>

<p>通过修改db指针，指向redisServer.db数组中的某个元素，来实现目标数据库的切换，源码参考<code>db.c/selectDb</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">selectDb</span><span class="params">(redisClient *c, <span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span> || id &gt;= server.dbnum)</span><br><span class="line">        <span class="keyword">return</span> REDIS_ERR;</span><br><span class="line">    c-&gt;db = &amp;server.db[id];	<span class="comment">// 通过修改db指针，指向redisServer.db数组中的某个元素，实现目标数据库的切换</span></span><br><span class="line">    <span class="keyword">return</span> REDIS_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据库键空间、增删改查操作"><a href="#数据库键空间、增删改查操作" class="headerlink" title="数据库键空间、增删改查操作"></a>数据库键空间、增删改查操作</h3><p>Redis是一个Key-Value型数据库，服务器中的每个数据库都由一个redisDb结构表示，其中redisDb结构的dict字典保存了数据库中的所有键值对，将这个字典称为<strong>键空间</strong>(key space)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">	dict *dict;		<span class="comment">// 数据库键空间，保存数据库中所有键值对</span></span><br><span class="line">	dict *expires;	<span class="comment">// 过期字典</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>以下介绍Redis数据库增、删、改、查操作的实现：</p>
<h4 id="查询键的实现"><a href="#查询键的实现" class="headerlink" title="查询键的实现"></a>查询键的实现</h4><p>在键空间中查询给定键是否存在， 通过lookupKey函数实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">robj *<span class="title function_">lookupKey</span><span class="params">(redisDb *db, robj *key)</span> &#123;</span><br><span class="line">    dictEntry *de = dictFind(db-&gt;dict,key-&gt;ptr);</span><br><span class="line">    <span class="keyword">if</span> (de) &#123;        </span><br><span class="line">        robj *val = dictGetVal(de);  <span class="comment">// 如果键存在，就取出值</span></span><br><span class="line">        <span class="comment">// 更新时间信息（只在不存在子进程时执行，充分利用写时复制机制）</span></span><br><span class="line">        <span class="keyword">if</span> (server.rdb_child_pid == <span class="number">-1</span> &amp;&amp; server.aof_child_pid == <span class="number">-1</span>)</span><br><span class="line">            val-&gt;lru = LRU_CLOCK();</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="增加键的实现"><a href="#增加键的实现" class="headerlink" title="增加键的实现"></a>增加键的实现</h4><p> 将新键值对添加到键空间，通过dbAdd函数实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">dbAdd</span><span class="params">(redisDb *db, robj *key, robj *val)</span> &#123;</span><br><span class="line">    sds copy = sdsdup(key-&gt;ptr);</span><br><span class="line">    <span class="type">int</span> retval = dictAdd(db-&gt;dict, copy, val);	<span class="comment">// 增加键值对</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除键的实现"><a href="#删除键的实现" class="headerlink" title="删除键的实现"></a>删除键的实现</h4><p>删除给定的键，注意需同时删除这个键的过期时间， 通过dbDelete函数实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dbDelete</span><span class="params">(redisDb *db, robj *key)</span> &#123; </span><br><span class="line">    <span class="keyword">if</span> (dictSize(db-&gt;expires) &gt; <span class="number">0</span>) dictDelete(db-&gt;expires,key-&gt;ptr); <span class="comment">// 先删除键的过期时间</span></span><br><span class="line">    <span class="keyword">if</span> (dictDelete(db-&gt;dict,key-&gt;ptr) == DICT_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 删除成功返回1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 删除失败返回0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新键的实现"><a href="#更新键的实现" class="headerlink" title="更新键的实现"></a>更新键的实现</h4><p>通过dbOverwrite函数实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setKey</span><span class="params">(redisDb *db, robj *key, robj *val)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lookupKeyWrite(db,key) == <span class="literal">NULL</span>) &#123;	<span class="comment">// 如果key不存在，新增键值对</span></span><br><span class="line">        dbAdd(db,key,val);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;	<span class="comment">// 如果key已经存在，更新键值对</span></span><br><span class="line">        dbOverwrite(db,key,val);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dbOverwrite</span><span class="params">(redisDb *db, robj *key, robj *val)</span> &#123;</span><br><span class="line">    dictEntry *de = dictFind(db-&gt;dict,key-&gt;ptr);</span><br><span class="line">	redisAssertWithInfo(<span class="literal">NULL</span>,key,de != <span class="literal">NULL</span>);</span><br><span class="line">	dictReplace(db-&gt;dict, key-&gt;ptr, val);	<span class="comment">// 更新键空间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="其他对键空间的操作"><a href="#其他对键空间的操作" class="headerlink" title="其他对键空间的操作"></a>其他对键空间的操作</h4><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="left">FLUSHALL</td>
<td align="left">清空所有数据库</td>
</tr>
<tr>
<td align="left">FLUSHDB</td>
<td align="left">清空目标数据库</td>
</tr>
<tr>
<td align="left">RANDOMKEY</td>
<td align="left">随机返回一个键</td>
</tr>
<tr>
<td align="left">DBSIZE</td>
<td align="left">返回目标数据库的键值对数量</td>
</tr>
<tr>
<td align="left">EXISTS [key]</td>
<td align="left">判断键是否存在</td>
</tr>
</tbody></table>
<h3 id="键的生存时间"><a href="#键的生存时间" class="headerlink" title="键的生存时间"></a>键的生存时间</h3><h4 id="如何设置键的生存时间？"><a href="#如何设置键的生存时间？" class="headerlink" title="如何设置键的生存时间？"></a>如何设置键的生存时间？</h4><p><strong>expire, pexpire</strong>命令以秒&#x2F;毫秒为精度，对数据库的某个键设置生存时间(Time to Live：TTL)。经过指定的时间后，服务器会自动删除生存时间为0的键。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; expire key 5	# 设置生存时间为5秒，5秒后服务器自动删除这个键</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; TTL key			# TTL命令返回这个键的生存时间，单位:秒</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; get key			# 5秒后，键过期，被服务器自动删除</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<p>Redis中，可以使用<strong>expire, pexpire, expireat, pexpireat</strong>设置键的生存时间，用法如下：</p>
<table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="left">expire [key] [ttl]</td>
<td align="left">设置键的生存时间为ttl秒</td>
</tr>
<tr>
<td align="left">pexpire [key] [ttl]</td>
<td align="left">设置键的生存时间为ttl毫秒</td>
</tr>
<tr>
<td align="left">expireat [key] [timestamp]</td>
<td align="left">设置过期时间为秒级时间戳</td>
</tr>
<tr>
<td align="left">pexpireat [key] [timestamp]</td>
<td align="left">设置过期时间为毫秒级时间戳</td>
</tr>
</tbody></table>
<p>Redis源码实现中，expire, pexpire, expireat命令最终都会转化为pexpireat命令，相关源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">expireCommand</span><span class="params">(redisClient *c)</span> &#123;				<span class="comment">// expire 命令</span></span><br><span class="line">    expireGenericCommand(c,mstime(),UNIT_SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">expireatCommand</span><span class="params">(redisClient *c)</span> &#123;				<span class="comment">// expireat 命令</span></span><br><span class="line">    expireGenericCommand(c,<span class="number">0</span>,UNIT_SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pexpireCommand</span><span class="params">(redisClient *c)</span> &#123;				<span class="comment">// pexpire 命令</span></span><br><span class="line">    expireGenericCommand(c,mstime(),UNIT_MILLISECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pexpireatCommand</span><span class="params">(redisClient *c)</span> &#123;				<span class="comment">// pexpireat 命令</span></span><br><span class="line">    expireGenericCommand(c,<span class="number">0</span>,UNIT_MILLISECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">expireGenericCommand</span><span class="params">(redisClient *c, <span class="type">long</span> <span class="type">long</span> basetime, <span class="type">int</span> unit)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="TIME命令介绍"><a href="#TIME命令介绍" class="headerlink" title="TIME命令介绍"></a>TIME命令介绍</h4><p>time命令用于返回当前服务器时间，返回值包含两个字符串，意义如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; TIME</span><br><span class="line">1) &quot;1615638731&quot;			# 表示当前时间，格式为UNIX时间戳</span><br><span class="line">2) &quot;628667&quot;				# 表示当前这一秒中，已经流逝的微秒数，1秒=1000000微妙，这个值总小于1000000</span><br></pre></td></tr></table></figure>

<h4 id="redis如何保存过期时间？"><a href="#redis如何保存过期时间？" class="headerlink" title="redis如何保存过期时间？"></a>redis如何保存过期时间？</h4><p>redisDb结构的expires字典保存了数据库中所有键的过期时间，这个expire字典我们称之为<strong>过期字典</strong>。</p>
<ul>
<li>过期字典的键是一个指针，指向键空间的某个键对象</li>
<li>过期字典的值是一个long long类型整数，毫秒精度的UNIX时间戳。</li>
</ul>
<p>pexpireat命令在过期字典中查找给定键，并设置值为过期时间(格式为UNIX时间戳)；具体实现可参考expireGenericCommand函数。</p>
<h4 id="redis如何移除过期时间？"><a href="#redis如何移除过期时间？" class="headerlink" title="redis如何移除过期时间？"></a>redis如何移除过期时间？</h4><p>persist命令可以移除一个键的过期时间， 效果相当于反向执行pexpireat命令：在过期字典中查找给定键，删除这个键对应的值；具体实现可参考persistCommand函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; EXPIRE key 100		# 设置key的生存时间100秒</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; TTL key				# 返回生存时间</span><br><span class="line">(integer) 97</span><br><span class="line">127.0.0.1:6379&gt; PERSIST key			# 移除key的生存时间</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; TTL key				# 生存时间为-1, 表示为永久键</span><br><span class="line">(integer) -1</span><br></pre></td></tr></table></figure>

<h4 id="怎么判断一个key是否过期"><a href="#怎么判断一个key是否过期" class="headerlink" title="怎么判断一个key是否过期"></a>怎么判断一个key是否过期</h4><p>TTL命令以秒为单位返回键的生存时间，PTTL命令以毫秒为单位返回键的生存时间。</p>
<p>TTL、PTTL命令<strong>通过计算键的过期时间和当前时间的差</strong>来实现。</p>
<p>判断一个key是否过期的步骤如下，具体实现可以参考expireIfNeeded函数：</p>
<ul>
<li>首先，检查给定键是否在过期字典中，如果存在，取得键的过期时间</li>
<li>其次，检查当前UNIX时间戳是否大于键的过期时间，如果大于表示已过期。</li>
</ul>
<h3 id="过期键删除策略"><a href="#过期键删除策略" class="headerlink" title="过期键删除策略"></a>过期键删除策略</h3><p>有三种常见的过期键删除策略，分别如下：</p>
<ul>
<li>定时删除：设置键过期时间的同时创建一个定时器，定时器超时后立即删除该键。</li>
<li>惰性删除：放任键过期不管，直到需要读写改键时才检查是否过期，如过期就删除该键。</li>
<li>定期删除：每隔一段时间，对数据库做一次检查，删除过期的键。</li>
</ul>
<p>三种策略的优缺点分析：</p>
<ul>
<li><p>定时删除：对内存友好，对CPU不友好，影响服务器的响应时间和吞吐量。</p>
</li>
<li><p>惰性删除：对CPU友好，但浪费内存，可能导致内存泄漏。</p>
</li>
<li><p>定期删除：是对前两种策略的折中，其难点在于确定删除操作执行时长和频率。</p>
</li>
</ul>
<h4 id="Redis使用的过期键删除策略"><a href="#Redis使用的过期键删除策略" class="headerlink" title="Redis使用的过期键删除策略"></a>Redis使用的过期键删除策略</h4><p>Redis综合使用了惰性删除和定期删除这两种策略，策略具体实现如下：</p>
<h4 id="惰性删除"><a href="#惰性删除" class="headerlink" title="惰性删除"></a>惰性删除</h4><p>Redis的惰性删除策略在expireIfNeed函数实现，所有读写数据库的命令在执行之前都会调用expireIfNeeded函数对输入键进行检查：</p>
<ul>
<li>如果输入键已经过期，expireIfNeeded函数将输入键删除，命令当做键不存在的情况去执行。</li>
<li>如果输入键未过期，expireIfNeed函数什么也不做，继续执行实际的命令流程。</li>
</ul>
<h4 id="定期删除"><a href="#定期删除" class="headerlink" title="定期删除"></a>定期删除</h4><p>过期键的定期删除策略由redis.c&#x2F;activeExpireCycle函数实现。每当Redis的时间事件serverCron函数周期性执行时，activeExpireCycle函数就随之被调用。 这个周期默认为0.1秒，可以通过配置文件的hz选项修改这个值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># modify /etc/redis/redis.conf</span><br><span class="line"># The range is between 1 and 500, however a value over 100 is usually not</span><br><span class="line"># a good idea. Most users should use the default of 10 and raise this up to</span><br><span class="line"># 100 only in environments where very low latency is required.</span><br><span class="line">hz 10</span><br></pre></td></tr></table></figure>

<p>activeExpireCycle函数的实现原理：在规定时间内，分多次遍历服务器中的数据库，从数据库的expires字典中随机检查一部分键的过期时间，并删除其中的过期键。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p>《Redis设计与实现》第9章 数据库</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://pcj600.github.io/2021/0313194553.html" data-id="cm2puzlwy002i4cvw7j8fa5ll" data-title="Redis学习笔记(七)——数据库" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/0314194830.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          Redis学习笔记(八)——RDB持久化
        
      </div>
    </a>
  
  
    <a href="/2021/0206194352.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">leetcode几道链表题解决思路</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Assembly/">Assembly</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CMake/">CMake</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CSAPP/">CSAPP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Django/">Django</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GDB/">GDB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPM/">RPM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell/">Shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Squid/">Squid</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/VMware/">VMware</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Win/">Win</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ansible/">ansible</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/awk/">awk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/curl/">curl</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/draft/">draft</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/interview/">interview</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/investment/">investment</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iptables/">iptables</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">k8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/systemd/">systemd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/troubleshooting/">troubleshooting</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/wget/">wget</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Assembly/" rel="tag">Assembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CLISH/" rel="tag">CLISH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMake/" rel="tag">CMake</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSAPP/" rel="tag">CSAPP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Django/" rel="tag">Django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GDB/" rel="tag">GDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GRUB/" rel="tag">GRUB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/" rel="tag">Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPM/" rel="tag">RPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Squid/" rel="tag">Squid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Traceroute/" rel="tag">Traceroute</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VMware/" rel="tag">VMware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Win/" rel="tag">Win</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ansible/" rel="tag">ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/" rel="tag">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chronyd/" rel="tag">chronyd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crontab/" rel="tag">crontab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/curl/" rel="tag">curl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/frontend/" rel="tag">frontend</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gcc/" rel="tag">gcc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/interview/" rel="tag">interview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/investment/" rel="tag">investment</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/" rel="tag">other</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/systemd/" rel="tag">systemd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tar/" rel="tag">tar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/troubleshooting/" rel="tag">troubleshooting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wget/" rel="tag">wget</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Assembly/" style="font-size: 11.11px;">Assembly</a> <a href="/tags/C/" style="font-size: 13.33px;">C</a> <a href="/tags/CLISH/" style="font-size: 10px;">CLISH</a> <a href="/tags/CMake/" style="font-size: 10px;">CMake</a> <a href="/tags/CSAPP/" style="font-size: 13.33px;">CSAPP</a> <a href="/tags/Django/" style="font-size: 12.22px;">Django</a> <a href="/tags/Docker/" style="font-size: 14.44px;">Docker</a> <a href="/tags/GDB/" style="font-size: 13.33px;">GDB</a> <a href="/tags/GRUB/" style="font-size: 10px;">GRUB</a> <a href="/tags/Git/" style="font-size: 13.33px;">Git</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/LeetCode/" style="font-size: 13.33px;">LeetCode</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 13.33px;">MySQL</a> <a href="/tags/Network/" style="font-size: 13.33px;">Network</a> <a href="/tags/Python/" style="font-size: 16.67px;">Python</a> <a href="/tags/RPM/" style="font-size: 12.22px;">RPM</a> <a href="/tags/Redis/" style="font-size: 17.78px;">Redis</a> <a href="/tags/Shell/" style="font-size: 11.11px;">Shell</a> <a href="/tags/Squid/" style="font-size: 14.44px;">Squid</a> <a href="/tags/Traceroute/" style="font-size: 10px;">Traceroute</a> <a href="/tags/VMware/" style="font-size: 12.22px;">VMware</a> <a href="/tags/Win/" style="font-size: 12.22px;">Win</a> <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/awk/" style="font-size: 10px;">awk</a> <a href="/tags/chronyd/" style="font-size: 10px;">chronyd</a> <a href="/tags/crontab/" style="font-size: 10px;">crontab</a> <a href="/tags/curl/" style="font-size: 10px;">curl</a> <a href="/tags/frontend/" style="font-size: 10px;">frontend</a> <a href="/tags/gcc/" style="font-size: 10px;">gcc</a> <a href="/tags/interview/" style="font-size: 10px;">interview</a> <a href="/tags/investment/" style="font-size: 17.78px;">investment</a> <a href="/tags/iptables/" style="font-size: 12.22px;">iptables</a> <a href="/tags/k8s/" style="font-size: 15.56px;">k8s</a> <a href="/tags/other/" style="font-size: 10px;">other</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/systemd/" style="font-size: 12.22px;">systemd</a> <a href="/tags/tar/" style="font-size: 10px;">tar</a> <a href="/tags/troubleshooting/" style="font-size: 18.89px;">troubleshooting</a> <a href="/tags/wget/" style="font-size: 10px;">wget</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">十月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">八月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">六月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">五月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/02/">二月 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">十二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/1026143114.html">Hexo搭建博客问题记录</a>
          </li>
        
          <li>
            <a href="/2024/1026131638.html">华宝添益(511990)折价套利记录</a>
          </li>
        
          <li>
            <a href="/2024/1026131259.html">chronyd配置了local的NTP server后, NTP报文出现public ip的问题</a>
          </li>
        
          <li>
            <a href="/2024/1017202436.html">MySQL8.0以上版本如何重置密码</a>
          </li>
        
          <li>
            <a href="/2024/1017195632.html">在Rocky Linux上安装Docker</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 PC<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>