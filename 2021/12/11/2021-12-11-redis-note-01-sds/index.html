<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pcj600.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="å‰è¨€Redisæ˜¯ç”¨Cè¯­è¨€å¼€å‘çš„ï¼Œä½†å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€æ•°ç»„å»è¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²(Simple dynamic Stringï¼Œç®€ç§°SDS)ä½œä¸ºå­—ç¬¦ä¸²çš„åº•å±‚å®ç°ã€‚ ä»¥ä¸‹ç»™å‡ºSDSç›¸å…³çš„ä¸€äº›å¸¸è§é—®é¢˜ï¼Œé€šè¿‡æºç åˆ†æå’Œå®é™…éªŒè¯ï¼Œæ€è€ƒè¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼Œäº†è§£å®ç°åŸç†å’Œè®¾è®¡æ€è·¯ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Rediså­¦ä¹ ç¬”è®°(ä¸€)â€”â€”ç®€å•åŠ¨æ€å­—ç¬¦ä¸²">
<meta property="og:url" content="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/index.html">
<meta property="og:site_name" content="PC&#39;s Blog">
<meta property="og:description" content="å‰è¨€Redisæ˜¯ç”¨Cè¯­è¨€å¼€å‘çš„ï¼Œä½†å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€æ•°ç»„å»è¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²(Simple dynamic Stringï¼Œç®€ç§°SDS)ä½œä¸ºå­—ç¬¦ä¸²çš„åº•å±‚å®ç°ã€‚ ä»¥ä¸‹ç»™å‡ºSDSç›¸å…³çš„ä¸€äº›å¸¸è§é—®é¢˜ï¼Œé€šè¿‡æºç åˆ†æå’Œå®é™…éªŒè¯ï¼Œæ€è€ƒè¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼Œäº†è§£å®ç°åŸç†å’Œè®¾è®¡æ€è·¯ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/image1.png">
<meta property="og:image" content="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/image2.png">
<meta property="og:image" content="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/image3.png">
<meta property="og:image" content="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/image4.png">
<meta property="og:image" content="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/image5.png">
<meta property="article:published_time" content="2021-12-11T12:28:06.000Z">
<meta property="article:modified_time" content="2024-08-18T12:34:49.438Z">
<meta property="article:author" content="PC">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/image1.png">

<link rel="canonical" href="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Rediså­¦ä¹ ç¬”è®°(ä¸€)â€”â€”ç®€å•åŠ¨æ€å­—ç¬¦ä¸² | PC's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">PC's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Life is short, Play more!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pcj600.github.io/2021/12/11/2021-12-11-redis-note-01-sds/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="PC">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PC's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Rediså­¦ä¹ ç¬”è®°(ä¸€)â€”â€”ç®€å•åŠ¨æ€å­—ç¬¦ä¸²
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-11 20:28:06" itemprop="dateCreated datePublished" datetime="2021-12-11T20:28:06+08:00">2021-12-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>15 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Redisæ˜¯ç”¨Cè¯­è¨€å¼€å‘çš„ï¼Œä½†å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€æ•°ç»„å»è¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²(Simple dynamic Stringï¼Œç®€ç§°SDS)ä½œä¸ºå­—ç¬¦ä¸²çš„åº•å±‚å®ç°ã€‚</p>
<p>ä»¥ä¸‹ç»™å‡ºSDSç›¸å…³çš„ä¸€äº›å¸¸è§é—®é¢˜ï¼Œé€šè¿‡æºç åˆ†æå’Œå®é™…éªŒè¯ï¼Œæ€è€ƒè¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼Œäº†è§£å®ç°åŸç†å’Œè®¾è®¡æ€è·¯ã€‚</p>
<span id="more"></span>

<p><strong>æºç ç‰ˆæœ¬ï¼š</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/redis/redis/releases/tag/3.0.0">Redis 3.0.0</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/redis/redis/releases/tag/6.0.10">Redis 6.0.10</a></p>
<h2 id="æ€è€ƒé—®é¢˜"><a href="#æ€è€ƒé—®é¢˜" class="headerlink" title="æ€è€ƒé—®é¢˜"></a>æ€è€ƒé—®é¢˜<span id="jump0"></span></h2><ul>
<li><a href="#jump1">SDSçš„æ•°æ®ç»“æ„ï¼Œå­—ç¬¦ä¸²å¦‚ä½•è¡¨ç¤ºçš„</a><ul>
<li><a href="#jump2">SDSç»“æ„ä½“å„æˆå‘˜çš„ä½œç”¨</a></li>
<li><a href="#jump3">åˆ›å»ºç»™å®šCå­—ç¬¦ä¸²çš„SDSåœºæ™¯ï¼Œsdshdrç»“æ„ä½“å„æˆå‘˜åˆå€¼æ˜¯å¤šå°‘</a></li>
</ul>
</li>
<li><a href="#jump4">SDSç›¸è¾ƒäºCé£æ ¼å­—ç¬¦ä¸²çš„ä¼˜ç‚¹</a><ul>
<li><a href="#jump5">SDSçš„ç©ºé—´åˆ†é…ç­–ç•¥æ˜¯å¦‚ä½•æœç»ç¼“å†²åŒºæº¢å‡ºé—®é¢˜çš„</a></li>
<li><a href="#jump6">SDSæ˜¯å¦‚ä½•å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°</a><ul>
<li><a href="#jump7">å­—ç¬¦ä¸²å¢é•¿åœºæ™¯ï¼ŒSDSæ‰©å®¹ç­–ç•¥</a></li>
<li><a href="#jump8">å­—ç¬¦ä¸²ç¼©çŸ­åœºæ™¯ï¼ŒSDSç©ºé—´é‡Šæ”¾ç­–ç•¥</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jump9">SDSæœ€å¤§é•¿åº¦æ˜¯å¤šå°‘</a></li>
<li><a href="#jump10">å­—ç¬¦ä¸²é”®çš„ä¸‰ç§ç¼–ç æ–¹å¼</a><ul>
<li><a href="#jump11">intç¼–ç </a></li>
<li><a href="#jump12">embstrç¼–ç </a></li>
<li><a href="#jump13">rawç¼–ç </a></li>
<li><a href="#jump14">è®¾è®¡embstrç¼–ç çš„ç”¨æ„æ˜¯ä»€ä¹ˆ</a></li>
<li><a href="#jump15">ä¸‰ç§ç¼–ç ä¹‹é—´çš„è½¬æ¢è§„åˆ™</a></li>
</ul>
</li>
<li><a href="#jump16">å¯¹äºå¾ˆçŸ­çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸éœ€è¦4å­—èŠ‚è¡¨ç¤ºé•¿åº¦ï¼ŒREDIS 3.2ä¸­çš„SDSå®ç°æ˜¯å¦‚ä½•ä¼˜åŒ–ï¼ŒèŠ‚çº¦å†…å­˜çš„</a><ul>
<li><a href="#jump17">ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„sdsï¼Œå®ƒçš„åº•å±‚é€šè¿‡å“ªä¸ªsdshdrç±»å‹è¡¨ç¤ºï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#jump18">REDISå­—ç¬¦ä¸²å‘½ä»¤</a></li>
</ul>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="SDSçš„æ•°æ®ç»“æ„ï¼Œå­—ç¬¦ä¸²æ˜¯å¦‚ä½•è¡¨ç¤ºçš„"><a href="#SDSçš„æ•°æ®ç»“æ„ï¼Œå­—ç¬¦ä¸²æ˜¯å¦‚ä½•è¡¨ç¤ºçš„" class="headerlink" title="SDSçš„æ•°æ®ç»“æ„ï¼Œå­—ç¬¦ä¸²æ˜¯å¦‚ä½•è¡¨ç¤ºçš„ "></a>SDSçš„æ•°æ®ç»“æ„ï¼Œå­—ç¬¦ä¸²æ˜¯å¦‚ä½•è¡¨ç¤ºçš„ <span id="jump1"></span></h3><p>REDIS 3.0ä¸­ï¼ŒSDSçš„æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> len;		<span class="comment">// å­—ç¬¦ä¸²é•¿åº¦ï¼Œå³å¯¹Cé£æ ¼å­—ç¬¦ä¸²è°ƒç”¨strlençš„ç»“æœ</span></span><br><span class="line">	<span class="type">int</span> <span class="built_in">free</span>;		<span class="comment">// bufæ•°ç»„ä¸­çš„æœªä½¿ç”¨å­—èŠ‚æ•°</span></span><br><span class="line">	<span class="type">char</span> buf[];		<span class="comment">// &#x27;\0&#x27;ç»“å°¾</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„sizeof(struct sdshdr)çš„ç»“æœç­‰äº8ï¼Œä¸æ˜¯9ï¼›è¿™é‡Œçš„bufä¸ºæŸ”æ€§æ•°ç»„æˆå‘˜ã€‚è‡³äºä¸ºä»€ä¹ˆç”¨æŸ”æ€§æ•°ç»„æˆå‘˜å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/davygeek/p/5748852.html">https://www.cnblogs.com/davygeek/p/5748852.html</a></p>
<h4 id="SDSç»“æ„ä½“å„æˆå‘˜çš„ä½œç”¨"><a href="#SDSç»“æ„ä½“å„æˆå‘˜çš„ä½œç”¨" class="headerlink" title="SDSç»“æ„ä½“å„æˆå‘˜çš„ä½œç”¨"></a>SDSç»“æ„ä½“å„æˆå‘˜çš„ä½œç”¨<span id="jump2"></span></h4><ul>
<li>len: è¡¨ç¤ºbufæ•°ç»„ä¸­å·²ä½¿ç”¨çš„å­—èŠ‚æ•°(<strong>ä¸åŒ…æ‹¬â€™\0â€™</strong>)ï¼Œå³å­—ç¬¦ä¸²é•¿åº¦ã€‚å¥½å¤„æ˜¯è·å–å­—ç¬¦ä¸²é•¿åº¦æ—¶é—´ä¸ºO(1)</li>
<li>free: è¡¨ç¤ºbufæ•°ç»„ä¸­æœªä½¿ç”¨çš„å­—èŠ‚æ•°ã€‚</li>
<li>buf: ç”¨äºä¿å­˜å­—ç¬¦ä¸²ï¼Œéµå¾ªCé£æ ¼å­—ç¬¦ä¸²åŸåˆ™ï¼Œä»¥â€™\0â€™ç»“å°¾ã€‚</li>
</ul>
<h4 id="åˆ›å»ºç»™å®šCå­—ç¬¦ä¸²çš„SDSåœºæ™¯ï¼Œsdshdrç»“æ„ä½“å„æˆå‘˜åˆå€¼æ˜¯å¤šå°‘ï¼Ÿ"><a href="#åˆ›å»ºç»™å®šCå­—ç¬¦ä¸²çš„SDSåœºæ™¯ï¼Œsdshdrç»“æ„ä½“å„æˆå‘˜åˆå€¼æ˜¯å¤šå°‘ï¼Ÿ" class="headerlink" title="åˆ›å»ºç»™å®šCå­—ç¬¦ä¸²çš„SDSåœºæ™¯ï¼Œsdshdrç»“æ„ä½“å„æˆå‘˜åˆå€¼æ˜¯å¤šå°‘ï¼Ÿ"></a>åˆ›å»ºç»™å®šCå­—ç¬¦ä¸²çš„SDSåœºæ™¯ï¼Œsdshdrç»“æ„ä½“å„æˆå‘˜åˆå€¼æ˜¯å¤šå°‘ï¼Ÿ<span id="jump3"></span></h4><p><strong>æ€è€ƒé—®é¢˜</strong>ï¼šå†™å…¥ä¸€ä¸ªå­—ç¬¦ä¸²é”®key, å€¼ä¸ºé•¿åº¦ä¸º5çš„å­—ç¬¦ä¸²â€Redisâ€ï¼Œå®ƒçš„SDSè¡¨ç¤ºä¸­len, free, bufæˆå‘˜å€¼å„æ˜¯å¤šå°‘ï¼Ÿ</p>
<p><strong>æºç åˆ†æï¼š</strong></p>
<p>1ã€Redisè°ƒç”¨<code>sdsnew</code>åˆ›å»ºä¸€ä¸ªåŒ…å«ç»™å®šCå­—ç¬¦ä¸²çš„SDSï¼Œè¿™é‡Œçš„initlen &#x3D; strlen(â€œRedisâ€) &#x3D; 5ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sds <span class="title function_">sdsnew</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *init)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> initlen = (init == <span class="literal">NULL</span>) ? <span class="number">0</span> : <span class="built_in">strlen</span>(init);	<span class="comment">// è°ƒç”¨strlenè·å–é•¿åº¦</span></span><br><span class="line">    <span class="keyword">return</span> sdsnewlen(init, initlen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2ã€å†è°ƒç”¨<code>sdsnewlen</code>ï¼Œè¿”å›SDSã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sds <span class="title function_">sdsnewlen</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *init, <span class="type">size_t</span> initlen)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> *<span class="title">sh</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// sdséµå¾ªCé£æ ¼å­—ç¬¦ä¸²åŸåˆ™ï¼Œä»¥&#x27;\0&#x27;ç»“å°¾ï¼Œé¢å¤–1å­—èŠ‚ä¸è®¡æ•°len</span></span><br><span class="line">    <span class="keyword">if</span> (init) &#123;</span><br><span class="line">        sh = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)+initlen+<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sh = zcalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)+initlen+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    sh-&gt;len = initlen;			<span class="comment">// len = strlen(init)</span></span><br><span class="line">    sh-&gt;<span class="built_in">free</span> = <span class="number">0</span>;				<span class="comment">// åˆ›å»ºä¸€ä¸ªåŒ…å«Cå­—ç¬¦ä¸²SDSåœºæ™¯ï¼Œfree = 0</span></span><br><span class="line">    <span class="keyword">if</span> (initlen &amp;&amp; init)</span><br><span class="line">        <span class="built_in">memcpy</span>(sh-&gt;buf, init, initlen);</span><br><span class="line">    sh-&gt;buf[initlen] = <span class="string">&#x27;\0&#x27;</span>;	<span class="comment">// sdséµå¾ªCé£æ ¼å­—ç¬¦ä¸²åŸåˆ™ï¼Œä»¥&#x27;\0&#x27;ç»“å°¾ï¼Œé¢å¤–1å­—èŠ‚ä¸è®¡å…¥len</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">char</span>*)sh-&gt;buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œåˆ›å»ºç»™å®šCå­—ç¬¦ä¸²çš„SDSåœºæ™¯ï¼š</p>
<ul>
<li><p>lençš„å€¼ä¸ºstrlen(â€œRedisâ€) &#x3D; 5</p>
</li>
<li><p>freeçš„å€¼ä¸º0</p>
</li>
<li><p>bufçš„å†…å®¹ä¸º â€œRedisâ€, ä»¥â€™\0â€™ç»“å°¾ï¼Œ6å­—èŠ‚å¤§å°</p>
</li>
</ul>
<p>SDSå®ä¾‹å›¾ï¼š<br><img src="/2021/12/11/2021-12-11-redis-note-01-sds/image1.png"></p>
<p><strong>æ€è€ƒé—®é¢˜ï¼š</strong> åˆå§‹åŒ–SDSæ—¶freeä¸ºå•¥ç»™0ï¼Ÿâ€”â€” å¹³æ—¶ä½¿ç”¨å­—ç¬¦ä¸²è¿˜æ˜¯åªè¯»åœºæ™¯åå¤šï¼Œè¿™æ ·èƒ½èŠ‚çº¦ç©ºé—´ã€‚</p>
<p><strong>GDBéªŒè¯ï¼š</strong></p>
<p>Redisæ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå¯ä»¥é€šè¿‡GDBæ‰“å°å†…å­˜ï¼ŒæŸ¥çœ‹è¿™ä¸ªkeyå¯¹åº”çš„SDSç»“æ„ä½“ï¼Œæ˜¯å¦å’Œæºç åˆ†æç»“æœä¸€è‡´ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p server.db[0].dict.ht[0]</span><br><span class="line">$1 = &#123;table = 0x7f3008d40900, size = 4, sizemask = 3, used = 1&#125;</span><br><span class="line"></span><br><span class="line">(gdb) p *(struct redisObject *) (server.db[0].dict.ht[0].table[0].v)</span><br><span class="line">$2 = &#123;type = 0, encoding = 8, lru = 11494144, refcount = 1, ptr = 0x7f3008d40838&#125;</span><br><span class="line"># type = REDIS_STRING(0), encoding = REDIS_ENCODING_EMBSTR(8)</span><br><span class="line"></span><br><span class="line">(gdb) p  (*(robj *)server.db[0].dict.ht[0].table[0].v).ptr</span><br><span class="line">$3 = (void *) 0x7f3008d40838</span><br><span class="line"></span><br><span class="line">(gdb) p  (sds) 0x7f3008d40838</span><br><span class="line">$4 = (sds) 0x7f3008d40838 &quot;redis&quot;		# å­˜å‚¨å­—ç¬¦ä¸²é”®çš„å€¼</span><br><span class="line"></span><br><span class="line">(gdb) p *(struct sdshdr *)(0x7f3008d40838 - 0x8)			# len 4å­—èŠ‚ï¼Œ free 4å­—èŠ‚ï¼Œå‡å»8å­—èŠ‚æ­£å¥½æ˜¯struct sdshdrçš„é¦–åœ°å€</span><br><span class="line">$5 = &#123;len = 5, free = 0, buf = 0x7f3008d40838 &quot;Redis&quot;&#125;  	# å’Œä»¥ä¸Šæºç åˆ†æçš„SDSç»“æ„ä½“å†…å®¹ä¸€è‡´</span><br></pre></td></tr></table></figure>

<p><strong>ä¸Šè¿°GDBè°ƒè¯•æ“ä½œçš„ä¾æ®è¯´æ˜ï¼š</strong></p>
<ul>
<li><p>Rediså°†æ‰€æœ‰æ•°æ®åº“ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€<code>server</code>å˜é‡ä¸­ï¼Œé»˜è®¤åˆ›å»º16ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤ç›®æ ‡æ•°æ®åº“ä¸º0å·(db[0])</p>
</li>
<li><p>dictä¸ºæ•°æ®åº“é”®ç©ºé—´ï¼Œä¿å­˜æ‰€æœ‰é”®å€¼å¯¹ï¼Œåº•å±‚å®ç°ä¸ºå“ˆå¸Œè¡¨ï¼Œå…¶ä¸­ht[0]å­˜å‚¨key-valueï¼Œht[1]ç”¨äºrehash</p>
</li>
<li><p>tableç±»å‹ä¸º<code>dictEntry **</code>, é“¾åœ°å€æ³•å®ç°å“ˆå¸Œè¡¨ï¼Œtable[0]ä¸ä¸ºNULLï¼Œè¯´æ˜è¿™ä¸ªkeyçš„hashcode % sizeçš„ç»“æœä¸º0</p>
</li>
<li><p>ptrç±»å‹ä¸ºvoid *ã€‚å¯¹äºå­—ç¬¦ä¸²é”®è€Œè¨€ï¼Œptrå®é™…ç±»å‹ä¸ºchar *ï¼Œå­˜å‚¨å†…å®¹ä¸ºâ€Redisâ€ä¸²ï¼Œè€Œä¸æ˜¯struct sdshdrçš„é¦–åœ°å€ã€‚</p>
</li>
</ul>
<p><strong>æ³¨ï¼š</strong>Rediså¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨sds, listè¿™äº›åŸºæœ¬æ•°æ®ç»“æ„å»å®ç°æ•°æ®åº“ï¼Œè€Œæ˜¯åœ¨è¿™äº›åŸºæœ¬æ•°æ®ç»“æ„ä¸Šæ„ç­‘äº†ä¸€ä¸ª<strong>å¯¹è±¡ç³»ç»Ÿ</strong>ï¼Œç»Ÿä¸€ä½¿ç”¨redisObjectå¯¹è±¡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> type:<span class="number">4</span>;			    <span class="comment">// ç±»å‹</span></span><br><span class="line">    <span class="type">unsigned</span> encoding:<span class="number">4</span>;			<span class="comment">// ç¼–ç </span></span><br><span class="line">    <span class="type">unsigned</span> lru:<span class="number">24</span>;				<span class="comment">// è®°å½•å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤ç¨‹åºè®¿é—®çš„æ—¶é—´</span></span><br><span class="line">    <span class="type">int</span> refcount;					<span class="comment">// å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="type">void</span> *ptr;						<span class="comment">// æŒ‡å‘åº•å±‚å®ç°æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span></span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>pträ¸ºvoid *æ³›å‹æŒ‡é’ˆï¼ŒæŒ‡å‘åº•å±‚å®ç°çš„æ•°æ®ç»“æ„ã€‚void *æ˜¯Cè¯­è¨€å®ç°æ³›å‹ç¼–ç¨‹çš„å¸¸ç”¨æ‰‹æ®µã€‚</p>
</li>
<li><p>typeä¸ºå¯¹è±¡ç±»å‹ã€‚typeå±æ€§è®¾è®¡ç›®çš„å¾ˆç®€å•ï¼Œå› ä¸ºä»…é€šè¿‡ptrè¿™ä¸ªæ³›å‹æŒ‡é’ˆæ— æ³•è·å–è¿™ä¸ªå¯¹è±¡çœŸæ­£çš„ç±»å‹ã€‚å¯¹äºå­—ç¬¦ä¸²é”®ï¼Œtypeå€¼å–0ï¼ˆREDIS_STRINGï¼‰</p>
</li>
<li><p>encodingä¸ºç¼–ç ç±»å‹ã€‚encodingå±æ€§è®¾è®¡ç›®çš„åœ¨äºï¼Œæ ¹æ®ä¸åŒåœºæ™¯ï¼Œä¸ºå¯¹è±¡è®¾ç½®ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„å®ç°æ¥ä¼˜åŒ–æ€§èƒ½ã€‚æ­¤ä¾‹ä¸­ï¼Œencodingå€¼å–8(REDIS_ENCODING_EMBSTR)ï¼Œè¡¨ç¤ºç¼–ç æ–¹å¼ä¸ºembstrã€‚</p>
</li>
</ul>
<h3 id="SDSç›¸è¾ƒäºCé£æ ¼å­—ç¬¦ä¸²çš„ä¼˜ç‚¹"><a href="#SDSç›¸è¾ƒäºCé£æ ¼å­—ç¬¦ä¸²çš„ä¼˜ç‚¹" class="headerlink" title="SDSç›¸è¾ƒäºCé£æ ¼å­—ç¬¦ä¸²çš„ä¼˜ç‚¹"></a>SDSç›¸è¾ƒäºCé£æ ¼å­—ç¬¦ä¸²çš„ä¼˜ç‚¹<span id="jump4"></span></h3><ul>
<li><p>è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1) ï¼ˆå¯¹äºSDSæ¥è¯´ï¼Œè·å–é•¿åº¦åªéœ€è®¿é—®lenæˆå‘˜ï¼‰</p>
</li>
<li><p>æœç»ç¼“å†²åŒºæº¢å‡ºé—®é¢˜</p>
</li>
<li><p>å‡å°‘å­—ç¬¦ä¸²ä¿®æ”¹æ—¶å¯¼è‡´çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°</p>
</li>
<li><p>äºŒè¿›åˆ¶å®‰å…¨ï¼Œé™¤äº†èƒ½ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®</p>
</li>
</ul>
<h4 id="SDSçš„ç©ºé—´åˆ†é…ç­–ç•¥æ˜¯å¦‚ä½•æœç»ç¼“å†²åŒºæº¢å‡ºé—®é¢˜çš„ï¼Ÿ"><a href="#SDSçš„ç©ºé—´åˆ†é…ç­–ç•¥æ˜¯å¦‚ä½•æœç»ç¼“å†²åŒºæº¢å‡ºé—®é¢˜çš„ï¼Ÿ" class="headerlink" title="SDSçš„ç©ºé—´åˆ†é…ç­–ç•¥æ˜¯å¦‚ä½•æœç»ç¼“å†²åŒºæº¢å‡ºé—®é¢˜çš„ï¼Ÿ"></a>SDSçš„ç©ºé—´åˆ†é…ç­–ç•¥æ˜¯å¦‚ä½•æœç»ç¼“å†²åŒºæº¢å‡ºé—®é¢˜çš„ï¼Ÿ<span id="jump5"></span></h4><p>ä»¥SDSæ‹¼æ¥å‡½æ•°<code>sdscat</code>ä¸ºä¾‹ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sds <span class="title function_">sdscat</span><span class="params">(sds s, <span class="type">const</span> <span class="type">char</span> *t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sdscatlen(s, t, <span class="built_in">strlen</span>(t));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sds <span class="title function_">sdscatlen</span><span class="params">(sds s, <span class="type">const</span> <span class="type">void</span> *t, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> *<span class="title">sh</span>;</span></span><br><span class="line">    <span class="type">size_t</span> curlen = sdslen(s);		<span class="comment">// å¾—åˆ°æºå­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">    s = sdsMakeRoomFor(s,len);		<span class="comment">// æ‹¼æ¥å‰æ£€æŸ¥sçš„å‰©ä½™ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚ç©ºé—´ä¸è¶³éœ€å…ˆæ‰©å±•ç©ºé—´</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    sh = (<span class="type">void</span>*) (s-(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)));</span><br><span class="line">    <span class="built_in">memcpy</span>(s+curlen, t, len);</span><br><span class="line">    sh-&gt;len = curlen+len;</span><br><span class="line">    sh-&gt;<span class="built_in">free</span> = sh-&gt;<span class="built_in">free</span>-len;</span><br><span class="line">    s[curlen+len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œ<code>sdscat</code>æ‹¼æ¥å­—ç¬¦ä¸²å‰ï¼Œä¼šå…ˆé€šè¿‡<code>sdsMakeRoomFor</code>æ£€æŸ¥sçš„å‰©ä½™ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œ<strong>å¦‚æœç©ºé—´ä¸è¶³ï¼Œä¼šå…ˆè°ƒç”¨<code>realloc</code>æ‰©å±•å‡ºè¶³å¤Ÿç©ºé—´å</strong>ï¼Œå†é€šè¿‡<code>memcpy</code>æ‹¼æ¥å­—ç¬¦ä¸²ã€‚ æ‰€ä»¥æœç»äº†ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ã€‚</p>
<h4 id="SDSæ˜¯å¦‚ä½•å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°"><a href="#SDSæ˜¯å¦‚ä½•å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°" class="headerlink" title="SDSæ˜¯å¦‚ä½•å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°"></a>SDSæ˜¯å¦‚ä½•å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°<span id="jump6"></span></h4><p>å¯¹äºCå­—ç¬¦ä¸²ï¼Œæ¯æ¬¡å¢é•¿æˆ–ç¼©çŸ­æ“ä½œï¼Œéƒ½ä¼šå¯¼è‡´ä¸€æ¬¡å†…å­˜é‡åˆ†é…ï¼Œæ€§èƒ½è¾ƒå·®ã€‚</p>
<p>SDSä¸­å¼•å…¥freeå±æ€§ï¼Œé€šè¿‡æœªä½¿ç”¨ç©ºé—´ï¼Œä¼˜åŒ–å­—ç¬¦ä¸²çš„å¢é•¿æˆ–ç¼©çŸ­æ“ä½œï¼Œå‡å°‘å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚</p>
<h4 id="å­—ç¬¦ä¸²å¢é•¿åœºæ™¯ï¼ŒSDSæ‰©å®¹ç­–ç•¥"><a href="#å­—ç¬¦ä¸²å¢é•¿åœºæ™¯ï¼ŒSDSæ‰©å®¹ç­–ç•¥" class="headerlink" title="å­—ç¬¦ä¸²å¢é•¿åœºæ™¯ï¼ŒSDSæ‰©å®¹ç­–ç•¥"></a>å­—ç¬¦ä¸²å¢é•¿åœºæ™¯ï¼ŒSDSæ‰©å®¹ç­–ç•¥<span id="jump7"></span></h4><p>å¯¹äºå­—ç¬¦ä¸²å¢é•¿åœºæ™¯ï¼ŒREDISé‡‡ç”¨ç©ºé—´é¢„åˆ†é…çš„æ€æƒ³ï¼Œå³ä¸ä»…åˆ†é…ä¿®æ”¹åçš„SDSå¿…éœ€çš„ç©ºé—´ï¼Œ<strong>è¿˜ä¼šé¢å¤–åˆ†é…ä¸€å®šçš„æœªä½¿ç”¨ç©ºé—´</strong>ã€‚æºç å‚è€ƒ<code>sdsMakeRoomFor</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_MAX_PREALLOC (1024 * 1024)</span></span><br><span class="line">sds <span class="title function_">sdsMakeRoomFor</span><span class="params">(sds s, <span class="type">size_t</span> addlen)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> *<span class="title">sh</span>, *<span class="title">newsh</span>;</span></span><br><span class="line">    <span class="type">size_t</span> <span class="built_in">free</span> = sdsavail(s);</span><br><span class="line">    <span class="type">size_t</span> len, newlen;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">free</span> &gt;= addlen) <span class="keyword">return</span> s;			<span class="comment">// å¦‚æœå‰©ä½™ç©ºé—´è¶³å¤Ÿç›´æ¥è¿”å›</span></span><br><span class="line">	len = sdslen(s);</span><br><span class="line">	sh = (<span class="type">void</span>*) (s-(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)));</span><br><span class="line">	newlen = (len+addlen);</span><br><span class="line">	<span class="keyword">if</span> (newlen &lt; SDS_MAX_PREALLOC)			<span class="comment">// å¦‚ä¿®æ”¹åçš„SDSé•¿åº¦å°äº1M,reallocé‡æ–°åˆ†é…ä¸¤å€ç©ºé—´</span></span><br><span class="line">   		newlen *= <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">    	newlen += SDS_MAX_PREALLOC;			<span class="comment">// å¦‚ä¿®æ”¹åçš„SDSé•¿åº¦å¤§äºç­‰äº1M, reallocé‡æ–°åˆ†é…1Mçš„ç©ºé—´</span></span><br><span class="line">	newsh = zrealloc(sh, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)+newlen+<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (newsh == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	newsh-&gt;<span class="built_in">free</span> = newlen - len;</span><br><span class="line">	<span class="keyword">return</span> newsh-&gt;buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œé¢å¤–åˆ†é…çš„æœªä½¿ç”¨ç©ºé—´å¤§å°ç”±ä¿®æ”¹åçš„SDSé•¿åº¦å†³å®šï¼š</p>
<ul>
<li>å¦‚æœå¯¹SDSä¿®æ”¹åï¼ŒSDSé•¿åº¦(å³lenå±æ€§çš„å€¼)å°äº1MBï¼ŒREDISä¼šé¢å¤–åˆ†é…lenä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œç»™å®šSDSä¸²s(â€œhelloâ€)ï¼Œè°ƒç”¨sdscat(s, â€œworldâ€)ä¹‹åï¼Œlen &#x3D; 10ï¼Œfree &#x3D; 10, bufæ•°ç»„å¤§å°å˜ä¸º 10 + 10 + 1 &#x3D; 21å­—èŠ‚ã€‚</li>
<li>å¦‚æœå¯¹SDSä¿®æ”¹åï¼ŒSDSé•¿åº¦å¤§äºç­‰äº1MBï¼Œ REDISåªé¢å¤–åˆ†é…1MBçš„ç©ºé—´ï¼Œç›®çš„æ˜¯é¿å…å†…å­˜å‡ºç°å¤ªå¤§çš„æµªè´¹ã€‚</li>
</ul>
<p>ç›¸æ¯”Cé£æ ¼å­—ç¬¦ä¸²ï¼Œ<strong>SDSçš„æ‰©å®¹ç­–ç•¥å°†å¢é•¿Næ¬¡å­—ç¬¦ä¸²éœ€è¦çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ä»Næ¬¡é™ä½ä¸ºæœ€å¤šNæ¬¡</strong>ã€‚</p>
<p>GDBéªŒè¯ç»“æœå¦‚ä¸‹ï¼Œå’Œåˆ†ææºç å¾—å‡ºçš„ç»“è®ºä¸€è‡´ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set key hello</span><br><span class="line">[OOK</span><br><span class="line">(gdb) p *(struct sdshdr *)((*(robj *)server.db[0].dict.ht[0].table[3].v).ptr - 0x8)</span><br><span class="line">$1 = &#123;len = 5, free = 0, buf = 0x7f571f1407f8 &quot;hello&quot;&#125;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; APPEND key world</span><br><span class="line">(integer) 10</span><br><span class="line">(gdb) p *(struct sdshdr *)((*(robj *)server.db[0].dict.ht[0].table[3].v).ptr - 0x8)</span><br><span class="line">$2 = &#123;len = 10, free = 10, buf = 0x7f571f1407e8 &quot;helloworld&quot;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å­—ç¬¦ä¸²ç¼©çŸ­åœºæ™¯ï¼ŒSDSç©ºé—´é‡Šæ”¾ç­–ç•¥"><a href="#å­—ç¬¦ä¸²ç¼©çŸ­åœºæ™¯ï¼ŒSDSç©ºé—´é‡Šæ”¾ç­–ç•¥" class="headerlink" title="å­—ç¬¦ä¸²ç¼©çŸ­åœºæ™¯ï¼ŒSDSç©ºé—´é‡Šæ”¾ç­–ç•¥"></a>å­—ç¬¦ä¸²ç¼©çŸ­åœºæ™¯ï¼ŒSDSç©ºé—´é‡Šæ”¾ç­–ç•¥<span id="jump8"></span></h4><p>å¯¹äºå­—ç¬¦ä¸²ç¼©çŸ­åœºæ™¯ï¼ŒREDISé‡‡ç”¨æƒ°æ€§ç©ºé—´é‡Šæ”¾ç­–ç•¥ï¼Œå³å¹¶ä¸ç«‹å³å›æ”¶ç©ºé—²å†…å­˜ï¼Œè€Œæ˜¯ä»…ä½¿ç”¨freeå±æ€§è®°å½•ç©ºé—²å­—èŠ‚æ•°ï¼Œå¦‚æœå°†æ¥éœ€å¯¹SDSåšå¢é•¿æ“ä½œï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™éƒ¨åˆ†ç©ºé—²å†…å­˜ï¼Œæ— éœ€åšå†…å­˜é‡åˆ†é…ã€‚</p>
<p>æºç åˆ†æï¼š<code>sdsclear</code>ç”¨äºæ¸…ç©ºSDSä¿å­˜çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œé‡‡ç”¨æƒ°æ€§ç©ºé—²é‡Šæ”¾ç­–ç•¥ï¼Œå¤æ‚åº¦ä»…ä¸ºO(1)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">sdsclear</span><span class="params">(sds s)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> *<span class="title">sh</span> =</span> (<span class="type">void</span>*) (s-(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)));</span><br><span class="line">    sh-&gt;<span class="built_in">free</span> += sh-&gt;len;</span><br><span class="line">    sh-&gt;len = <span class="number">0</span>;</span><br><span class="line">    sh-&gt;buf[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶ï¼ŒREDISæä¾›API <code>sdsRemoveFreeSpace</code>ï¼Œé€šè¿‡reallocä»…åˆ†é…å®é™…å¤§å°çš„å†…å­˜ï¼ŒçœŸæ­£åœ°å›æ”¶ç©ºé—²å†…å­˜ï¼Œè§£å†³æƒ°æ€§ç©ºé—´é‡Šæ”¾ç­–ç•¥å¸¦æ¥çš„å†…å­˜æµªè´¹é—®é¢˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sds <span class="title function_">sdsRemoveFreeSpace</span><span class="params">(sds s)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> *<span class="title">sh</span>;</span></span><br><span class="line">    sh = (<span class="type">void</span>*) (s-(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)));</span><br><span class="line">    sh = zrealloc(sh, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)+sh-&gt;len+<span class="number">1</span>);	<span class="comment">// ä»…åˆ†é…å®é™…å¤§å°çš„å†…å­˜</span></span><br><span class="line">    sh-&gt;<span class="built_in">free</span> = <span class="number">0</span>;										<span class="comment">// freeå†™0</span></span><br><span class="line">    <span class="keyword">return</span> sh-&gt;buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SDSæœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ"><a href="#SDSæœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ" class="headerlink" title="SDSæœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ"></a>SDSæœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ<span id="jump9"></span></h3><p>Redis 3.0</p>
<ul>
<li><p>struct sdshdrçš„lenæˆå‘˜è®°å½•SDSé•¿åº¦ï¼Œç±»å‹ä¸ºintï¼Œ4å­—èŠ‚ï¼Œç†è®ºä¸Šæœ€å¤§é•¿åº¦ 2^32 &#x2F; 2^10 &#x2F; 2^10 &#x3D; 4096MB</p>
</li>
<li><p>åœ¨set, appendæ“ä½œä¸­é€šè¿‡ç¡¬ç¼–ç å†™æ­»å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦ä¸º512MBï¼Œè¶…è¿‡è¿™ä¸ªé•¿åº¦ä¼šæŠ¥é”™ï¼Œæºç å‚è€ƒ<code>checkStringLength</code>ã€‚</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">checkStringLength</span><span class="params">(redisClient *c, <span class="type">long</span> <span class="type">long</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="number">512</span>*<span class="number">1024</span>*<span class="number">1024</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;string exceeds maximum allowed size (512MB)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> REDIS_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> REDIS_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»¼ä¸Šï¼Œ Redis 3.0ä¸­SDSæœ€å¤§é•¿åº¦ä¸º 512MBã€‚</p>
<p>Redis 6.0.10</p>
<ul>
<li>é€šè¿‡é…ç½®é¡¹<code>proto-max-bulk-len</code>æŒ‡å®šSDSé•¿åº¦ï¼Œé»˜è®¤æ˜¯512MBï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œé…ç½®è¿™ä¸ªå€¼ï¼Œè¿™ç‚¹å’ŒRedis 3.0æœ‰åŒºåˆ«ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">checkStringLength</span><span class="params">(client *c, <span class="type">long</span> <span class="type">long</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(c-&gt;flags &amp; CLIENT_MASTER) &amp;&amp; size &gt; server.proto_max_bulk_len) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">&quot;string exceeds maximum allowed size (proto-max-bulk-len)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> C_ERR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> C_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»¼ä¸Šï¼Œ Redis 6.0ä¸­SDSæœ€å¤§é•¿åº¦é»˜è®¤ä¸º512MBï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œé…ç½®è¿™ä¸ªå€¼ã€‚</p>
<h3 id="å­—ç¬¦ä¸²é”®çš„ä¸‰ç§ç¼–ç æ–¹å¼"><a href="#å­—ç¬¦ä¸²é”®çš„ä¸‰ç§ç¼–ç æ–¹å¼" class="headerlink" title="å­—ç¬¦ä¸²é”®çš„ä¸‰ç§ç¼–ç æ–¹å¼"></a>å­—ç¬¦ä¸²é”®çš„ä¸‰ç§ç¼–ç æ–¹å¼<span id="jump10"></span></h3><p>Redisä¸­å­—ç¬¦ä¸²å¯¹è±¡æœ‰ä¸‰ç§ç¼–ç ï¼Œåˆ†åˆ«æ˜¯int , embstr, rawã€‚ä»¥ä¸‹åˆ†åˆ«ä»‹ç»è¿™ä¸‰ç§ç¼–ç ï¼š</p>
<h4 id="intç¼–ç "><a href="#intç¼–ç " class="headerlink" title="intç¼–ç "></a>intç¼–ç <span id="jump11"></span></h4><p>å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„å†…å®¹æ˜¯æ•´æ•°å€¼ï¼Œä¸”è¿™ä¸ªæ•´æ•°å¯ä»¥ç”¨longè¡¨ç¤ºï¼ŒRediså°±æŠŠå®ƒçš„ç¼–ç è®¾ç½®ä¸ºint</p>
<p>ä¸¾ä¾‹ï¼šæ‰§è¡Œ set key â€œ123â€å‘½ä»¤ï¼Œä¼šåˆ›å»ºä¸€ä¸ªintç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set key 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding key</span><br><span class="line">&quot;int&quot;</span><br></pre></td></tr></table></figure>

<p>å†…å­˜ä¸­çš„<code>redisObject</code>å¯¹è±¡å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="/2021/12/11/2021-12-11-redis-note-01-sds/image2.png"></p>
<p>intç±»å‹ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œè¦æ±‚æ•´æ•°è½åœ¨longçš„èŒƒå›´å†…ã€‚åœ¨64ä½ç¯å¢ƒä¸Šï¼ŒlongèŒƒå›´ï¼š-9223372036854775808ï½+9223372036854775807ï¼Œä¸åŒçš„é”®å€¼å’Œç¼–ç ç»“æœå‚è€ƒä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th align="left">é”®å€¼</th>
<th align="left">ç¼–ç </th>
</tr>
</thead>
<tbody><tr>
<td align="left">+123</td>
<td align="left">embstr</td>
</tr>
<tr>
<td align="left">-123</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">â€“123</td>
<td align="left">embstr</td>
</tr>
<tr>
<td align="left">-9223372036854775808</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">-9223372036854775809</td>
<td align="left">embstr</td>
</tr>
<tr>
<td align="left">9223372036854775807</td>
<td align="left">int</td>
</tr>
<tr>
<td align="left">9223372036854775808</td>
<td align="left">embstr</td>
</tr>
</tbody></table>
<p><strong>æºç åˆ†æï¼š</strong></p>
<p><code>createStringObjectFromLongLong</code>æ ¹æ®ä¼ å…¥çš„long longç±»å‹çš„æ•´æ•°å€¼ï¼Œåˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ã€‚å¦‚æœå…¥å‚åœ¨longèŒƒå›´ä¹‹å†…ï¼Œå°±åˆ›å»ºintç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REDIS_SHARED_INTEGERS 10000</span></span><br><span class="line">robj *<span class="title function_">createStringObjectFromLongLong</span><span class="params">(<span class="type">long</span> <span class="type">long</span> value)</span> &#123;</span><br><span class="line">    robj *o;</span><br><span class="line">    <span class="comment">// value çš„å¤§å°åœ¨ 0 - 10000ä¹‹é—´ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªå…±äº«å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">0</span> &amp;&amp; value &lt; REDIS_SHARED_INTEGERS) &#123;</span><br><span class="line">        incrRefCount(shared.integers[value]);</span><br><span class="line">        o = shared.integers[value];</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// å¦‚æœåœ¨longèŒƒå›´å†…ï¼Œå°±åˆ›å»ºç¼–ç ä¸ºintçš„å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">if</span> (value &gt;= LONG_MIN &amp;&amp; value &lt;= LONG_MAX) &#123;</span><br><span class="line">            o = createObject(REDIS_STRING, <span class="literal">NULL</span>);</span><br><span class="line">            o-&gt;encoding = REDIS_ENCODING_INT;</span><br><span class="line">            o-&gt;ptr = (<span class="type">void</span>*)((<span class="type">long</span>)value);	<span class="comment">// ptrå®é™…æŒ‡å‘ä¸€ä¸ªlongç±»å‹çš„value</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœåœ¨longä¹‹å¤–ï¼Œå°±åˆ›å»ºä¸€ä¸ªç¼–ç ä¸ºembstrçš„å­—ç¬¦ä¸²</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            o = createObject(REDIS_STRING,sdsfromlonglong(value));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="REDISä¸­çš„å¯¹è±¡å…±äº«æœºåˆ¶"><a href="#REDISä¸­çš„å¯¹è±¡å…±äº«æœºåˆ¶" class="headerlink" title="REDISä¸­çš„å¯¹è±¡å…±äº«æœºåˆ¶"></a>REDISä¸­çš„å¯¹è±¡å…±äº«æœºåˆ¶</h4><p>RedisæœåŠ¡å™¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šé¢„å…ˆåˆ›å»º1ä¸‡ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ (0 ~ 9999), å½“æœåŠ¡å™¨éœ€è¦ä½¿ç”¨å€¼ä¸º 0 - 9999çš„å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼ŒæœåŠ¡å™¨ä¼šç›´æ¥ä½¿ç”¨è¿™äº›å…±äº«å¯¹è±¡ï¼Œè€Œä¸æ˜¯å»æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªç”¨æ„åœ¨äºèŠ‚çº¦å†…å­˜ã€‚</p>
<p><strong>ä¸¾ä¾‹ï¼š</strong></p>
<p>åˆ›å»ºå­—ç¬¦ä¸²é”®Aï¼ŒBï¼Œå€¼éƒ½å†™â€œ1â€, é‚£ä¹ˆè¿™ä¸¤ä¸ªé”®å…±äº«åŒä¸€ä¸ªredisObjectå¯¹è±¡ï¼Œä¸”è¿™ä¸ªredisObjectå¯¹è±¡çš„ptræŒ‡å‘çš„å†…å®¹ä¸º1</p>
<p><strong>GDBéªŒè¯ç»“æœï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb)  p *(robj *)server.db[0].dict.ht[0].table[0].v</span><br><span class="line">$15 = &#123;type = 0, encoding = 1, lru = 11668863, refcount = 3, ptr = 0x1&#125;</span><br><span class="line">(gdb)  p *(robj *)server.db[0].dict.ht[0].table[2].v</span><br><span class="line">$16 = &#123;type = 0, encoding = 1, lru = 11668863, refcount = 3, ptr = 0x1&#125;</span><br><span class="line">(gdb)  p &amp;(*(robj *)server.db[0].dict.ht[0].table[0].v)</span><br><span class="line">$17 = (robj *) 0x7fa7c1457360</span><br><span class="line">(gdb)  p &amp;(*(robj *)server.db[0].dict.ht[0].table[2].v)</span><br><span class="line">$18 = (robj *) 0x7fa7c1457360		# å’Œ$17ç›¸åŒï¼Œéƒ½æ˜¯0x7fa7c1457360ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼Œä¸¤ä¸ªkeyå’Œå…±äº«å­—ç¬¦ä¸²å¯¹è±¡çš„å†…å­˜ç¤ºæ„å›¾ï¼š</p>
<p><img src="/2021/12/11/2021-12-11-redis-note-01-sds/image3.png"></p>
<h4 id="rawç¼–ç "><a href="#rawç¼–ç " class="headerlink" title="rawç¼–ç "></a>rawç¼–ç <span id="jump13"></span></h4><p>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œä¸”è¿™ä¸ªå­—ç¬¦ä¸²é•¿åº¦å¤§äº39ä¸ªå­—èŠ‚ï¼ŒREDISå°±ä½¿ç”¨SDSå­˜å‚¨è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶è®¾ç½®ç¼–ç ç±»å‹ä¸ºrawã€‚</p>
<p><strong>ä¸¾ä¾‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set key 1234567891234567891234567891234567891234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding ket</span><br><span class="line">&quot;raw&quot;</span><br><span class="line">127.0.0.1:6379&gt; strlen key</span><br><span class="line">(integer) 40</span><br></pre></td></tr></table></figure>

<p>rawç¼–ç çš„å­—ç¬¦ä¸²ç¤ºæ„å›¾ï¼š</p>
<p><img src="/2021/12/11/2021-12-11-redis-note-01-sds/image4.png"></p>
<p><strong>æºç åˆ†æï¼š</strong></p>
<p><code>createStringObject</code>ç”¨äºåˆ›å»ºä¸€ä¸ªSDSè¡¨ç¤ºçš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚å½“å­—ç¬¦ä¸²é•¿åº¦å¤§äº39å­—èŠ‚æ—¶ä½¿ç”¨rawç¼–ç ï¼Œ å¦åˆ™ç”¨embstrç¼–ç ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The current limit of 39 is chosen so that the biggest string object</span></span><br><span class="line"><span class="comment"> * we allocate as EMBSTR will still fit into the 64 byte arena of jemalloc. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REDIS_ENCODING_EMBSTR_SIZE_LIMIT 39</span></span><br><span class="line">robj *<span class="title function_">createStringObject</span><span class="params">(<span class="type">char</span> *ptr, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt;= REDIS_ENCODING_EMBSTR_SIZE_LIMIT)</span><br><span class="line">        <span class="keyword">return</span> createEmbeddedStringObject(ptr,len);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> createRawStringObject(ptr,len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">robj *<span class="title function_">createRawStringObject</span><span class="params">(<span class="type">char</span> *ptr, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> createObject(REDIS_STRING,sdsnewlen(ptr,len));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">robj *<span class="title function_">createObject</span><span class="params">(<span class="type">int</span> type, <span class="type">void</span> *ptr)</span> &#123;</span><br><span class="line">    robj *o = zmalloc(<span class="keyword">sizeof</span>(*o));</span><br><span class="line">    o-&gt;type = type;</span><br><span class="line">    o-&gt;encoding = REDIS_ENCODING_RAW;	<span class="comment">// è®¾ç½®ç¼–ç ç±»å‹ä¸ºraw</span></span><br><span class="line">    o-&gt;ptr = ptr;</span><br><span class="line">    o-&gt;refcount = <span class="number">1</span>;</span><br><span class="line">    o-&gt;lru = LRU_CLOCK();</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="embstrç¼–ç "><a href="#embstrç¼–ç " class="headerlink" title="embstrç¼–ç "></a>embstrç¼–ç <span id="jump12"></span></h4><p>å¦‚æœå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œä¸”è¿™ä¸ªå­—ç¬¦ä¸²é•¿åº¦å°äºç­‰äº39ä¸ªå­—èŠ‚ï¼ŒREDISå°±ä½¿ç”¨SDSå­˜å‚¨è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶è®¾ç½®ç¼–ç ç±»å‹ä¸ºembstrï¼Œ<strong>embstræ˜¯ä¸“é—¨ç”¨äºä¿å­˜çŸ­å­—ç¬¦ä¸²çš„ä¸€ç§ä¼˜åŒ–ç¼–ç æ–¹å¼ã€‚</strong></p>
<p><strong>ä¸¾ä¾‹ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set key hello</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding key</span><br><span class="line">&quot;embstr&quot;</span><br></pre></td></tr></table></figure>

<p>å’Œrawç¼–ç ç±»ä¼¼ï¼Œembstrç¼–ç ä¹Ÿä½¿ç”¨<code>redisObject</code>å’Œ<code>sdshdr</code>ä¿å­˜å­—ç¬¦ä¸²ï¼Œä½†å·®åˆ«åœ¨äºï¼š</p>
<ul>
<li>rawç¼–ç éœ€è°ƒç”¨<strong>2</strong>æ¬¡mallocåˆ›å»º<code>redisObject</code>å’Œ<code>sdshdr</code>å¯¹è±¡ï¼Œä¸”<code>redisObject</code>å’Œ<code>sdshdr</code>å†…å­˜ä¸è¿ç»­</li>
<li>è€Œembstrç¼–ç åªéœ€<strong>1</strong>æ¬¡mallocåˆ›å»º<code>redisObject</code>å’Œ<code>sdshdr</code>å¯¹è±¡ï¼Œä¸”<code>redisObject</code>å’Œ<code>sdshdr</code>å†…å­˜æ˜¯è¿ç»­çš„</li>
</ul>
<p>GDBæŸ¥çœ‹embstrç¼–ç å­—ç¬¦ä¸²çš„å†…å­˜ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p &amp;(*(robj *)server.db[0].dict.ht[0].table[3].v)</span><br><span class="line">$1 = (robj *) 0x7f43ebd3b9c0</span><br><span class="line">(gdb) p *(robj *)server.db[0].dict.ht[0].table[3].v</span><br><span class="line">$2 = &#123;type = 0, encoding = 8, lru = 11755503, refcount = 1, ptr = 0x7f43ebd3b9d8&#125;</span><br><span class="line">(gdb) p *(struct sdshdr *)0x7f43ebd3b9d0</span><br><span class="line">$3 = &#123;len = 5, free = 0, buf = 0x7f43ebd3b9d8 &quot;hello&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿç»“æœå‘ç°robjå’Œsdshdrå†…å­˜ç¡®å®æ˜¯è¿ç»­çš„ï¼Œembstrç¼–ç çš„å†…å­˜ç¤ºæ„å›¾ï¼š</p>
<p><img src="/2021/12/11/2021-12-11-redis-note-01-sds/image5.png"></p>
<p><strong>æºç åˆ†æï¼š</strong></p>
<p><code>createEmbeddedStringObject</code>ç”¨äºåˆ›å»ºä¸€ä¸ªembstrç¼–ç çš„å­—ç¬¦ä¸²</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">robj *<span class="title function_">createEmbeddedStringObject</span><span class="params">(<span class="type">char</span> *ptr, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    robj *o = zmalloc(<span class="keyword">sizeof</span>(robj)+<span class="keyword">sizeof</span>(<span class="keyword">struct</span> sdshdr)+len+<span class="number">1</span>); <span class="comment">// ä»…1æ¬¡malloc</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr</span> *<span class="title">sh</span> =</span> (<span class="type">void</span>*)(o+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    o-&gt;type = REDIS_STRING;</span><br><span class="line">    o-&gt;encoding = REDIS_ENCODING_EMBSTR;</span><br><span class="line">    o-&gt;ptr = sh+<span class="number">1</span>;</span><br><span class="line">    o-&gt;refcount = <span class="number">1</span>;</span><br><span class="line">    o-&gt;lru = LRU_CLOCK();</span><br><span class="line"></span><br><span class="line">    sh-&gt;len = len;</span><br><span class="line">    sh-&gt;<span class="built_in">free</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(sh-&gt;buf,ptr,len);</span><br><span class="line">        sh-&gt;buf[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memset</span>(sh-&gt;buf,<span class="number">0</span>,len+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="è®¾è®¡embstrç¼–ç çš„ç”¨æ„æ˜¯ä»€ä¹ˆ"><a href="#è®¾è®¡embstrç¼–ç çš„ç”¨æ„æ˜¯ä»€ä¹ˆ" class="headerlink" title="è®¾è®¡embstrç¼–ç çš„ç”¨æ„æ˜¯ä»€ä¹ˆ"></a>è®¾è®¡embstrç¼–ç çš„ç”¨æ„æ˜¯ä»€ä¹ˆ<span id="jump14"></span></h4><p>ç›¸æ¯”äºrawç¼–ç ï¼Œembstrç¼–ç å­˜å‚¨çŸ­å­—ç¬¦ä¸²çš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li><p>åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼Œmallocæ¬¡æ•°ä»2æ¬¡å˜ä¸º1æ¬¡ï¼Œé‡Šæ”¾å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼Œfreeæ¬¡æ•°ä»2æ¬¡å˜æˆ1æ¬¡ã€‚</p>
</li>
<li><p>embstrç¼–ç ä¸­ï¼Œ<code>redisObject</code>å’Œ<code>sdshdr</code>å†…å­˜è¿ç»­ï¼Œå¯ä»¥æ›´å¥½åˆ©ç”¨ç¼“å­˜ï¼Œæå‡æ•ˆç‡ã€‚</p>
</li>
</ul>
<h4 id="ä¸‰ç§ç¼–ç ä¹‹é—´çš„è½¬æ¢è§„åˆ™"><a href="#ä¸‰ç§ç¼–ç ä¹‹é—´çš„è½¬æ¢è§„åˆ™" class="headerlink" title="ä¸‰ç§ç¼–ç ä¹‹é—´çš„è½¬æ¢è§„åˆ™"></a>ä¸‰ç§ç¼–ç ä¹‹é—´çš„è½¬æ¢è§„åˆ™<span id="jump15"></span></h4><p><strong>è§„åˆ™1ï¼š</strong> embstrå¯¹è±¡æ‰§è¡Œä¿®æ”¹å‘½ä»¤åï¼Œæ€»æ˜¯ä¼šå˜æˆä¸€ä¸ªrawç¼–ç å¯¹è±¡ã€‚</p>
<p><strong>è§„åˆ™2ï¼š</strong> å¯¹äºintå¯¹è±¡ï¼Œå¦‚æœåœ¨è¿™ä¸ªå¯¹è±¡æ‰§è¡Œçš„æ“ä½œå¯¼è‡´å…¶ä¿å­˜çš„å€¼ä¸åœ¨longèŒƒå›´å†…ï¼Œè¿™ä¸ªå¯¹è±¡ç¼–ç æ€»æ˜¯å˜æˆraw</p>
<p><strong>æºç åˆ†æï¼š</strong></p>
<p>ä»¥APPENDå‘½ä»¤ä¸ºä¾‹ï¼Œæºç å‚è€ƒ<code>appendCommand</code>ï¼Œæ­¤å‡½æ•°æœ€ç»ˆè°ƒç”¨<code>dbUnshareStringValue</code>ï¼Œæ€»æ˜¯åˆ›å»ºä¸€ä¸ªrawç¼–ç çš„å¯¹è±¡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">appendCommand</span><span class="params">(redisClient *c)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> totlen;</span><br><span class="line">    robj *o, *append;</span><br><span class="line">    o = lookupKeyWrite(c-&gt;db,c-&gt;argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// é”®å€¼å¯¹ä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ ......</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// é”®å€¼å¯¹å­˜åœ¨ ......</span></span><br><span class="line">        <span class="comment">/* &quot;append&quot; is an argument, so always an sds */</span></span><br><span class="line">        append = c-&gt;argv[<span class="number">2</span>];</span><br><span class="line">        totlen = stringObjectLen(o)+sdslen(append-&gt;ptr);</span><br><span class="line">        <span class="keyword">if</span> (checkStringLength(c,totlen) != REDIS_OK)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">/* Append the value */</span></span><br><span class="line">        o = dbUnshareStringValue(c-&gt;db,c-&gt;argv[<span class="number">1</span>],o);</span><br><span class="line">        o-&gt;ptr = sdscatlen(o-&gt;ptr,append-&gt;ptr,sdslen(append-&gt;ptr));</span><br><span class="line">        totlen = sdslen(o-&gt;ptr);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">robj *<span class="title function_">dbUnshareStringValue</span><span class="params">(redisDb *db, robj *key, robj *o)</span> &#123;</span><br><span class="line">    redisAssert(o-&gt;type == REDIS_STRING);</span><br><span class="line">    <span class="keyword">if</span> (o-&gt;refcount != <span class="number">1</span> || o-&gt;encoding != REDIS_ENCODING_RAW) &#123;</span><br><span class="line">        robj *decoded = getDecodedObject(o);</span><br><span class="line">        o = createRawStringObject(decoded-&gt;ptr, sdslen(decoded-&gt;ptr)); <span class="comment">// embstrå¯¹è±¡æ‰§è¡Œä¿®æ”¹å‘½ä»¤åï¼Œæ€»æ˜¯ä¼šå˜æˆä¸€ä¸ªrawç¼–ç å¯¹è±¡ã€‚</span></span><br><span class="line">        decrRefCount(decoded);</span><br><span class="line">        dbOverwrite(db,key,o);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>éªŒè¯ç»“æœï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set key &quot;hello&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; object encoding key</span><br><span class="line">&quot;embstr&quot;</span><br><span class="line">127.0.0.1:6379&gt; append key &quot; world!&quot;</span><br><span class="line">(integer) 12</span><br><span class="line">127.0.0.1:6379&gt; object encoding key</span><br><span class="line">&quot;raw&quot;</span><br></pre></td></tr></table></figure>



<h4 id="REDIS3-2ä¸­çš„SDSå®ç°"><a href="#REDIS3-2ä¸­çš„SDSå®ç°" class="headerlink" title="REDIS3.2ä¸­çš„SDSå®ç°"></a>REDIS3.2ä¸­çš„SDSå®ç°<span id="jump16"></span></h4><p>REDIS 3.2ä¸­ï¼Œæ ¹æ®SDSçš„é•¿åº¦åˆç»†åˆ†ä¸º5ç±»ï¼Œå¯¹äºä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œç”¨ä¸åŒçš„sdshdrXç»“æ„ä½“å­˜å‚¨ï¼Œå®ç°èŠ‚çº¦å†…å­˜çš„ç›®çš„ã€‚</p>
<p>ä»¥REDIS 6.0.10æºç ä¸ºä¾‹ï¼Œsdshdrç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">char</span> *sds;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint16_t</span> alloc; <span class="comment">/* excluding the he</span></span><br><span class="line"><span class="comment">    ader and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint32_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="type">uint64_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="type">uint64_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="type">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>å„ç»“æ„ä½“æˆå‘˜ä½œç”¨ï¼š</strong></p>
<ul>
<li><p>lenè¡¨ç¤ºå­—ç¬¦ä¸²å®é™…é•¿åº¦ã€‚</p>
</li>
<li><p>allocè¡¨ç¤ºä¸ºsdsåˆ†é…çš„å¤§å°ï¼Œä¸åŒ…æ‹¬â€™\0â€™ã€‚</p>
</li>
<li><p>flagsè¡¨ç¤ºsdshdrç±»å‹ï¼Œç”¨äºåˆ¤æ–­sdsçš„ç±»å‹ã€‚flagsæœ¬èº«æ˜¯charç±»å‹æœ‰8ä½ï¼Œå…¶ä¸­é«˜5ä½ä¿ç•™ï¼Œåªç”¨ä½3ä½è¶³ä»¥è¿™è¡¨ç¤º5ç§sdshdrç±»å‹ï¼Œå‚è€ƒæºç ï¼š</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_TYPE_5  0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_TYPE_8  1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_TYPE_16 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_TYPE_32 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_TYPE_64 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_TYPE_MASK 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDS_TYPE_BITS 3</span></span><br></pre></td></tr></table></figure>

<p><strong><code>__attribute__ ((__packed__))</code>ä½œç”¨ï¼Ÿ</strong></p>
<p><code>__attribute__ ((__packed__))</code>æ˜¯GCCç‰¹æœ‰çš„è¯­æ³•ï¼Œä½œç”¨æ˜¯å–æ¶ˆç»“æ„ä½“çš„å­—èŠ‚å¯¹é½ï¼Œé‡‡ç”¨å†…å­˜ç´§å‡‘æ¨¡å¼æ’åˆ—ã€‚</p>
<p>è¿™é‡Œç»™å‡ºåŠ ä¸Šæˆ–ä¸åŠ å…³é”®å­—æ—¶ï¼Œå„sdshdrç»“æ„ä½“çš„å¤§å°ï¼š</p>
<table>
<thead>
<tr>
<th align="left">ç»“æ„ä½“</th>
<th align="left">åŠ GCCå…³é”®å­—<code>__attribute__ ((__packed__))</code></th>
<th align="left">ä¸åŠ å…³é”®å­—</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sdshdr5</td>
<td align="left">1å­—èŠ‚</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">sdshdr8</td>
<td align="left">3</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">sdshdr16</td>
<td align="left">5</td>
<td align="left">6</td>
</tr>
<tr>
<td align="left">sdshdr32</td>
<td align="left">9</td>
<td align="left">12</td>
</tr>
<tr>
<td align="left">sdshdr64</td>
<td align="left">17</td>
<td align="left">24</td>
</tr>
</tbody></table>
<p><strong>é—®é¢˜æ€è€ƒ</strong>ï¼šå–æ¶ˆç»“æ„ä½“å­—èŠ‚å¯¹é½çš„ç”¨æ„æ˜¯ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆä¼˜ç‚¹ï¼Ÿ</p>
<ul>
<li>1ä¸ªå¥½å¤„æ˜¯èŠ‚çº¦äº†å†…å­˜ï¼Œæ—¶é—´æ¢ç©ºé—´ã€‚</li>
<li>å¦1ä¸ªå¥½å¤„æ˜¯ä½¿å¾—<strong>é€šè¿‡å†…å­˜ç›´æ¥è®¿é—®ç»“æ„ä½“å†…éƒ¨å˜é‡éå¸¸æ–¹ä¾¿</strong>ï¼Œæ¯”å¦‚é€šè¿‡buf[-1]è¿™ç§éªšæ“ä½œå¯ä»¥ç›´æ¥è®¿é—®åˆ°<code>flags</code>æˆå‘˜ï¼Œä»è€Œåˆ¤æ–­sdsç±»å‹ï¼Œå®ç°éå¸¸ç®€æ´ã€‚æºç å‚è€ƒå¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sds s;</span><br><span class="line"><span class="type">char</span> type = s[<span class="number">-1</span>] &amp; SDS_TYPE_MASK;</span><br></pre></td></tr></table></figure>

<h4 id="ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„sdsï¼Œå®ƒçš„åº•å±‚é€šè¿‡å“ªä¸ªsdshdrç±»å‹è¡¨ç¤ºï¼Ÿ"><a href="#ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„sdsï¼Œå®ƒçš„åº•å±‚é€šè¿‡å“ªä¸ªsdshdrç±»å‹è¡¨ç¤ºï¼Ÿ" class="headerlink" title="ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„sdsï¼Œå®ƒçš„åº•å±‚é€šè¿‡å“ªä¸ªsdshdrç±»å‹è¡¨ç¤ºï¼Ÿ"></a>ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„sdsï¼Œå®ƒçš„åº•å±‚é€šè¿‡å“ªä¸ªsdshdrç±»å‹è¡¨ç¤ºï¼Ÿ<span id="jump17"></span></h4><p>ä»¥REDIS 6.0.10æºç ä¸ºä¾‹ï¼Œå‚è€ƒ<code>sdsReqType</code>çš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">char</span> <span class="title function_">sdsReqType</span><span class="params">(<span class="type">size_t</span> string_size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">32</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_5;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">0xff</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_8;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">0xffff</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_16;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">0xffffffff</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_32;</span><br><span class="line">    <span class="keyword">return</span> SDS_TYPE_64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š</p>
<ul>
<li>SDSé•¿åº¦å°äº32ï¼Œç”¨sdshdr5ç±»å‹è¡¨ç¤º</li>
<li>SDSé•¿åº¦åœ¨ [32, 255ï¼‰ï¼Œç”¨sdshdr8ç±»å‹è¡¨ç¤º</li>
<li>ä¾æ¬¡ç±»æ¨ â€¦â€¦</li>
</ul>
<p><strong>æ€è€ƒé—®é¢˜ï¼š</strong><code>set key hello</code>ï¼Œ é”®keyå’Œå€¼helloéƒ½æ˜¯ç”¨sdshdr5è¡¨ç¤ºçš„å—ï¼Ÿ</p>
<p>è¯¦ç»†åˆ†æè¿‡ç¨‹å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017450295">https://segmentfault.com/a/1190000017450295</a></p>
<p>ä»¥ä¸‹ä»…ç»™å‡ºç»“è®ºå’ŒéªŒè¯ç»“æœï¼š</p>
<p><strong>ç»“è®ºï¼š</strong></p>
<ul>
<li><p><strong>å¯¹äºé•¿åº¦å°äº32çš„å­—ç¬¦ä¸²é”®å’Œå€¼ï¼Œé”®é€šè¿‡sdshdr5è¡¨ç¤ºï¼Œè€Œå€¼é€šè¿‡sdshdr8è¡¨ç¤º</strong></p>
</li>
<li><p>å¯¹äºå€¼ï¼Œä½¿ç”¨<code>createEmbeddedStringObject</code>æ€»æ˜¯åˆ›å»ºä¸€ä¸ªsdshdr8ç±»å‹çš„å¯¹è±¡ã€‚</p>
</li>
<li><p>å¯¹äºé”®ï¼Œé€šè¿‡è°ƒç”¨é“¾<code>setGenericCommand--&gt;genericSetKey--&gt;dbAdd</code>ï¼Œæœ€ç»ˆè°ƒç”¨<code>sdsdup</code>ï¼Œåˆ›å»ºä¸€ä¸ªsdshdr5ç±»å‹çš„å¯¹è±¡ã€‚è°ƒç”¨æ ˆå‚è€ƒï¼š</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  dbAdd (db=0x557b1c4d9690, key=0x557b1c4f5720, val=0x557b1c4f4730) at db.c:185</span><br><span class="line">#1  0x0000557b1b95751d in genericSetKey (c=c@entry=0x557b1c4ecfa0, db=0x557b1c4d9690, key=key@entry=0x557b1c4f5720,</span><br><span class="line">    val=val@entry=0x557b1c4f4730, keepttl=keepttl@entry=0, signal=signal@entry=1) at db.c:252</span><br><span class="line">#2  0x0000557b1b9649e7 in setGenericCommand (c=c@entry=0x557b1c4ecfa0, flags=flags@entry=0, key=0x557b1c4f5720,</span><br><span class="line">    val=0x557b1c4f4730, expire=expire@entry=0x0, unit=unit@entry=0, ok_reply=0x0, abort_reply=0x0) at t_string.c:87</span><br><span class="line">#3  0x0000557b1b964c51 in setCommand (c=0x557b1c4ecfa0) at t_string.c:146</span><br><span class="line">#4  0x0000557b1b93bd5e in call (c=0x557b1c4ecfa0, flags=15) at server.c:3368</span><br><span class="line">#5  0x0000557b1b93c7a5 in processCommand (c=c@entry=0x557b1c4ecfa0) at server.c:3797</span><br><span class="line">#6  0x0000557b1b94a7b0 in processCommandAndResetClient (c=c@entry=0x557b1c4ecfa0) at networking.c:1895</span><br><span class="line">#7  0x0000557b1b94f09a in processInputBuffer (c=0x557b1c4ecfa0) at networking.c:1978</span><br><span class="line">#8  0x0000557b1b9cbd48 in callHandler (handler=&lt;optimized out&gt;, conn=0x557b1c4fdd60) at connhelpers.h:79</span><br><span class="line">#9  connSocketEventHandler (el=&lt;optimized out&gt;, fd=&lt;optimized out&gt;, clientData=0x557b1c4fdd60, mask=&lt;optimized out&gt;)</span><br><span class="line">    at connection.c:296</span><br><span class="line">#10 0x0000557b1b9356c7 in aeProcessEvents (eventLoop=eventLoop@entry=0x557b1c479aa0, flags=flags@entry=27) at ae.c:479</span><br><span class="line">#11 0x0000557b1b935a0d in aeMain (eventLoop=0x557b1c479aa0) at ae.c:539</span><br><span class="line">#12 0x0000557b1b932216 in main (argc=2, argv=0x7ffe8e366c18) at server.c:5498</span><br></pre></td></tr></table></figure>

<p><strong>GDBéªŒè¯ç»“æœï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/tb ((*(robj *)server.db[0].dict.ht[0].table[1].v).ptr - 1) // value</span><br><span class="line">0x557b1c4f4742: 00000001	// æ³¨æ„valueçš„æœ€åä¸‰ä½ä¸º001ï¼Œè¡¨ç¤ºSDS_TYPE_8</span><br><span class="line">$2 = &#123;len = 5 &#x27;\005&#x27;, alloc = 5 &#x27;\005&#x27;, flags = 1 &#x27;\001&#x27;, buf = 0x557b1c4f4743 &quot;hello&quot;&#125;</span><br><span class="line"></span><br><span class="line">(gdb) p (sds)server.db[0].dict.ht[0].table[1].key</span><br><span class="line">$3 = (sds) 0x557b1c502f61 &quot;key&quot;</span><br><span class="line">(gdb) x/tb 0x557b1c502f61 - 0x1</span><br><span class="line">0x557b1c502f60: 00011000	// æ³¨æ„keyçš„æœ€åä¸‰ä½ä¸º000ï¼Œè¡¨ç¤ºSDS_TYPE_5</span><br></pre></td></tr></table></figure>

<p><strong>æ€è€ƒé—®é¢˜</strong>ï¼šå¯¹äºçŸ­å­—ç¬¦ä¸²ï¼Œä¸ºä»€ä¹ˆé”®åº•å±‚ç±»å‹ä¸ºsdshdr5ï¼Œå€¼åº•å±‚ç±»å‹è®¾ç½®å´æˆsdshdr8ï¼Ÿ</p>
<p>ä¸ªäººåˆ†æï¼šå®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œé€šå¸¸é”®çš„æ›´æ–°æ¬¡æ•°è¿œå°äºå€¼çš„æ›´æ–°æ¬¡æ•°ã€‚æ‰€ä»¥å¯¹é”®é‡‡ç”¨æœ€å°çš„å†…å­˜å­˜å‚¨ï¼Œä»¥èŠ‚çœç©ºé—´ï¼›å¯¹å€¼ç”¨æ›´å¤§çš„å†…å­˜å­˜å‚¨ï¼Œå‡å°‘å†…å­˜é‡åˆ†é…çš„æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ã€‚</p>
<h4 id="REDISå­—ç¬¦ä¸²å‘½ä»¤"><a href="#REDISå­—ç¬¦ä¸²å‘½ä»¤" class="headerlink" title="REDISå­—ç¬¦ä¸²å‘½ä»¤"></a>REDISå­—ç¬¦ä¸²å‘½ä»¤<span id="jump18"></span></h4><p>REDIS å­—ç¬¦ä¸²å‘½ä»¤å‚è€ƒå®˜æ–¹ç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="https://redis.io/commands#string">https://redis.io/commands#string</a></p>
<p>ä»¥ä¸‹ä»…ç»™å‡ºå‡ ä¸ªæœ€å¸¸ç”¨çš„å‘½ä»¤:</p>
<ul>
<li>set key value</li>
<li>get key</li>
<li>append key value</li>
</ul>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>ã€1ã€‘ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹ç¬¬2ç«  ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼Œç¬¬8ç«  å¯¹è±¡</p>
<p>ã€2ã€‘<a target="_blank" rel="noopener" href="https://blog.huangz.me/diary/2014/how-to-read-redis-source-code.html">å¦‚ä½•é˜…è¯»Redisæºç </a></p>
<p>ã€3ã€‘<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017450295">ã€Redisæºç åˆ†æã€‘ä¸€ä¸ªå¯¹SDSHDR5æ˜¯å¦ä½¿ç”¨çš„ç–‘é—®</a></p>
<p>ã€4ã€‘<a target="_blank" rel="noopener" href="https://www.cnblogs.com/davygeek/p/5748852.html">æŸ”æ€§æ•°ç»„</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/11/30/2021-11-30-redis-key-expired-case/" rel="prev" title="HiredisæŸ¥è¯¢å¤±è´¥æ—¶å‡ºç°keyä¸¢å¤±é—®é¢˜å®šä½">
      <i class="fa fa-chevron-left"></i> HiredisæŸ¥è¯¢å¤±è´¥æ—¶å‡ºç°keyä¸¢å¤±é—®é¢˜å®šä½
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/12/12/2021-12-12-redis-note-02-linkedlist/" rel="next" title="Rediså­¦ä¹ ç¬”è®°(äºŒ)â€”â€”é“¾è¡¨">
      Rediså­¦ä¹ ç¬”è®°(äºŒ)â€”â€”é“¾è¡¨ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%97%AE%E9%A2%98"><span class="nav-number">2.</span> <span class="nav-text">æ€è€ƒé—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SDS%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%98%AF%E5%A6%82%E4%BD%95%E8%A1%A8%E7%A4%BA%E7%9A%84"><span class="nav-number">3.1.</span> <span class="nav-text">SDSçš„æ•°æ®ç»“æ„ï¼Œå­—ç¬¦ä¸²æ˜¯å¦‚ä½•è¡¨ç¤ºçš„ </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SDS%E7%BB%93%E6%9E%84%E4%BD%93%E5%90%84%E6%88%90%E5%91%98%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">3.1.1.</span> <span class="nav-text">SDSç»“æ„ä½“å„æˆå‘˜çš„ä½œç”¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%BB%99%E5%AE%9AC%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84SDS%E5%9C%BA%E6%99%AF%EF%BC%8Csdshdr%E7%BB%93%E6%9E%84%E4%BD%93%E5%90%84%E6%88%90%E5%91%98%E5%88%9D%E5%80%BC%E6%98%AF%E5%A4%9A%E5%B0%91%EF%BC%9F"><span class="nav-number">3.1.2.</span> <span class="nav-text">åˆ›å»ºç»™å®šCå­—ç¬¦ä¸²çš„SDSåœºæ™¯ï¼Œsdshdrç»“æ„ä½“å„æˆå‘˜åˆå€¼æ˜¯å¤šå°‘ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDS%E7%9B%B8%E8%BE%83%E4%BA%8EC%E9%A3%8E%E6%A0%BC%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-number">3.2.</span> <span class="nav-text">SDSç›¸è¾ƒäºCé£æ ¼å­—ç¬¦ä¸²çš„ä¼˜ç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SDS%E7%9A%84%E7%A9%BA%E9%97%B4%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%9D%9C%E7%BB%9D%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E9%97%AE%E9%A2%98%E7%9A%84%EF%BC%9F"><span class="nav-number">3.2.1.</span> <span class="nav-text">SDSçš„ç©ºé—´åˆ†é…ç­–ç•¥æ˜¯å¦‚ä½•æœç»ç¼“å†²åŒºæº¢å‡ºé—®é¢˜çš„ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SDS%E6%98%AF%E5%A6%82%E4%BD%95%E5%87%8F%E5%B0%91%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%97%B6%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%86%85%E5%AD%98%E9%87%8D%E5%88%86%E9%85%8D%E6%AC%A1%E6%95%B0"><span class="nav-number">3.2.2.</span> <span class="nav-text">SDSæ˜¯å¦‚ä½•å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A2%9E%E9%95%BF%E5%9C%BA%E6%99%AF%EF%BC%8CSDS%E6%89%A9%E5%AE%B9%E7%AD%96%E7%95%A5"><span class="nav-number">3.2.3.</span> <span class="nav-text">å­—ç¬¦ä¸²å¢é•¿åœºæ™¯ï¼ŒSDSæ‰©å®¹ç­–ç•¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%A9%E7%9F%AD%E5%9C%BA%E6%99%AF%EF%BC%8CSDS%E7%A9%BA%E9%97%B4%E9%87%8A%E6%94%BE%E7%AD%96%E7%95%A5"><span class="nav-number">3.2.4.</span> <span class="nav-text">å­—ç¬¦ä¸²ç¼©çŸ­åœºæ™¯ï¼ŒSDSç©ºé—´é‡Šæ”¾ç­–ç•¥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDS%E6%9C%80%E5%A4%A7%E9%95%BF%E5%BA%A6%E6%98%AF%E5%A4%9A%E5%B0%91%EF%BC%9F"><span class="nav-number">3.3.</span> <span class="nav-text">SDSæœ€å¤§é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%94%AE%E7%9A%84%E4%B8%89%E7%A7%8D%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F"><span class="nav-number">3.4.</span> <span class="nav-text">å­—ç¬¦ä¸²é”®çš„ä¸‰ç§ç¼–ç æ–¹å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#int%E7%BC%96%E7%A0%81"><span class="nav-number">3.4.1.</span> <span class="nav-text">intç¼–ç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REDIS%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB%E6%9C%BA%E5%88%B6"><span class="nav-number">3.4.2.</span> <span class="nav-text">REDISä¸­çš„å¯¹è±¡å…±äº«æœºåˆ¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#raw%E7%BC%96%E7%A0%81"><span class="nav-number">3.4.3.</span> <span class="nav-text">rawç¼–ç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#embstr%E7%BC%96%E7%A0%81"><span class="nav-number">3.4.4.</span> <span class="nav-text">embstrç¼–ç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1embstr%E7%BC%96%E7%A0%81%E7%9A%84%E7%94%A8%E6%84%8F%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">3.4.5.</span> <span class="nav-text">è®¾è®¡embstrç¼–ç çš„ç”¨æ„æ˜¯ä»€ä¹ˆ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E7%BC%96%E7%A0%81%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99"><span class="nav-number">3.4.6.</span> <span class="nav-text">ä¸‰ç§ç¼–ç ä¹‹é—´çš„è½¬æ¢è§„åˆ™</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REDIS3-2%E4%B8%AD%E7%9A%84SDS%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.4.7.</span> <span class="nav-text">REDIS3.2ä¸­çš„SDSå®ç°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%99%E5%AE%9A%E4%B8%80%E4%B8%AA%E9%95%BF%E5%BA%A6%E4%B8%BAn%E7%9A%84sds%EF%BC%8C%E5%AE%83%E7%9A%84%E5%BA%95%E5%B1%82%E9%80%9A%E8%BF%87%E5%93%AA%E4%B8%AAsdshdr%E7%B1%BB%E5%9E%8B%E8%A1%A8%E7%A4%BA%EF%BC%9F"><span class="nav-number">3.4.8.</span> <span class="nav-text">ç»™å®šä¸€ä¸ªé•¿åº¦ä¸ºnçš„sdsï¼Œå®ƒçš„åº•å±‚é€šè¿‡å“ªä¸ªsdshdrç±»å‹è¡¨ç¤ºï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REDIS%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.9.</span> <span class="nav-text">REDISå­—ç¬¦ä¸²å‘½ä»¤</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">4.</span> <span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="PC"
      src="/images/avatar.jpg">
  <!-- <p class="site-author-name" itemprop="name">PC</p> -->
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">109</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        



<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PC</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">299k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">4:32</span>
</div>

<!--
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>
-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right"},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2}});</script></body>
</html>

<script type="text/javascript" src="/js/clicklove.js"></script>
