<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="VLyEpKy1Jq3gcpFmB3W8Ql0f4f-G35UyYi1NJ8Towq0">
  <meta name="baidu-site-verification" content="codeva-dRzuqywF6U">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pcj600.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="å‰è¨€é€šè¿‡é˜…è¯»Redisæºç ï¼Œé…åˆGDBå’ŒæŠ“åŒ…ç­‰è°ƒè¯•æ‰‹æ®µï¼Œåˆ†æRediså‘å¸ƒè®¢é˜…çš„å®ç°åŸç†ï¼Œæ€è€ƒç›¸å…³é—®é¢˜ã€‚ æºç ç‰ˆæœ¬ï¼šRedis 6.0.10">
<meta property="og:type" content="article">
<meta property="og:title" content="Rediså‘å¸ƒä¸è®¢é˜…æºç åˆ†æ">
<meta property="og:url" content="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/index.html">
<meta property="og:site_name" content="PC&#39;s Blog">
<meta property="og:description" content="å‰è¨€é€šè¿‡é˜…è¯»Redisæºç ï¼Œé…åˆGDBå’ŒæŠ“åŒ…ç­‰è°ƒè¯•æ‰‹æ®µï¼Œåˆ†æRediså‘å¸ƒè®¢é˜…çš„å®ç°åŸç†ï¼Œæ€è€ƒç›¸å…³é—®é¢˜ã€‚ æºç ç‰ˆæœ¬ï¼šRedis 6.0.10">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/image1.png">
<meta property="og:image" content="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/image2.png">
<meta property="og:image" content="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/image3.png">
<meta property="og:image" content="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/image4.png">
<meta property="og:image" content="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/image5.png">
<meta property="article:published_time" content="2022-01-29T12:48:52.000Z">
<meta property="article:modified_time" content="2024-08-18T12:51:25.013Z">
<meta property="article:author" content="PC">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/image1.png">

<link rel="canonical" href="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Rediså‘å¸ƒä¸è®¢é˜…æºç åˆ†æ | PC's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">PC's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Life is short, Play more!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»<span class="badge">32</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾<span class="badge">39</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£<span class="badge">126</span></a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>ç«™ç‚¹åœ°å›¾</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="PC">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="PC's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Rediså‘å¸ƒä¸è®¢é˜…æºç åˆ†æ
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-01-29 20:48:52" itemprop="dateCreated datePublished" datetime="2022-01-29T20:48:52+08:00">2022-01-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>24 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>é€šè¿‡é˜…è¯»Redisæºç ï¼Œé…åˆGDBå’ŒæŠ“åŒ…ç­‰è°ƒè¯•æ‰‹æ®µï¼Œåˆ†æRediså‘å¸ƒè®¢é˜…çš„å®ç°åŸç†ï¼Œæ€è€ƒç›¸å…³é—®é¢˜ã€‚</p>
<p><strong>æºç ç‰ˆæœ¬ï¼š</strong><a target="_blank" rel="noopener" href="https://github.com/redis/redis/releases/tag/6.0.10">Redis 6.0.10</a></p>
<span id="more"></span>

<h2 id="æ€è€ƒé—®é¢˜"><a href="#æ€è€ƒé—®é¢˜" class="headerlink" title="æ€è€ƒé—®é¢˜"></a>æ€è€ƒé—®é¢˜</h2><ul>
<li><a href="#jump0">å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µä»‹ç»</a></li>
<li><a href="#jump1">è®¢é˜…é¢‘é“ â€”â€” SUBSCRIBEå‘½ä»¤çš„å®ç°</a></li>
<li><a href="#jump2">é€€è®¢é¢‘é“ â€”â€” USUBSCRIBEå‘½ä»¤çš„å®ç°</a></li>
<li><a href="#jump3">è®¢é˜…æ¨¡å¼ â€”â€” PSUBSCRIBEå‘½ä»¤çš„å®ç°</a></li>
<li><a href="#jump4">é€€è®¢æ¨¡å¼ â€”â€” PUNSUBSCRIBEå‘½ä»¤çš„å®ç°</a></li>
<li><a href="#jump5">å‘é€æ¶ˆæ¯ â€”â€” PUBLISHå‘½ä»¤çš„å®ç°</a><ul>
<li><a href="#jump6">Rediså‘å¸ƒè®¢é˜…çš„ç‰¹ç‚¹</a></li>
<li><a href="#jump7">ä¸ºä»€ä¹ˆè®¾è®¡pubsub_patterns_dictå­—å…¸ï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#jump10">ä¸€æ¬¡å®Œæ•´çš„Redisè®¢é˜…ã€å‘å¸ƒæµç¨‹åˆ†æ</a><ul>
<li><a href="#jump11">ä¸ºä»€ä¹ˆredis-cliä¸­æ‰§è¡Œäº†subscribeå‘½ä»¤åæ— æ³•å†æ‰§è¡Œunsubscribeå‘½ä»¤ï¼Ÿ</a></li>
<li><a href="#jump12">TCPæ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œè®¢é˜…è€…æ˜¯å¦‚ä½•ä¿è¯æ­£ç¡®è§£æå‘å¸ƒè€…çš„æ¶ˆæ¯?</a></li>
<li><a href="#jump8">è®¢é˜…çš„å®¢æˆ·ç«¯æ–­çº¿ï¼ŒæœåŠ¡ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥çš„ï¼Ÿå¦‚ä½•ä¿è¯è¿™ä¸ªå®¢æˆ·ç«¯çš„é¢‘é“ã€æ¨¡å¼è®¢é˜…ä¿¡æ¯ä¹Ÿè¢«åŒæ­¥åˆ é™¤ï¼Ÿ</a></li>
<li><a href="#jump9">æœåŠ¡å™¨æ­£å¸¸å…³é—­åœºæ™¯ï¼Œæ­£åœ¨è®¢é˜…çš„å®¢æˆ·ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥åˆ°æœåŠ¡å™¨ç¦»çº¿çš„ï¼Ÿ</a></li>
</ul>
</li>
<li>æŸ¥çœ‹è®¢é˜…æ¶ˆæ¯</li>
</ul>
<h3 id="å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µä»‹ç»"><a href="#å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µä»‹ç»" class="headerlink" title="å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µä»‹ç»"></a>å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µä»‹ç»<span id="jump0"></span></h3><p>Redisçš„å‘å¸ƒè®¢é˜…åŠŸèƒ½ç”±SUBSCRIBEï¼ŒPSUBSCRIBEï¼ŒPUBLISHç­‰å‘½ä»¤ç»„æˆï¼Œæ¯ä¸ªå‘½ä»¤å¯¹åº”çš„åŠŸèƒ½å’Œç›¸å…³æºç å‚è€ƒä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th align="left">å‘½ä»¤</th>
<th align="left">åŠŸèƒ½</th>
<th align="left">ç›¸å…³æºç </th>
</tr>
</thead>
<tbody><tr>
<td align="left">subscribe</td>
<td align="left">è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</td>
<td align="left">subscribeCommand</td>
</tr>
<tr>
<td align="left">unsubscribe</td>
<td align="left">è§£é™¤ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“çš„è®¢é˜…</td>
<td align="left">unsubscribeCommand</td>
</tr>
<tr>
<td align="left">psubscribe</td>
<td align="left">è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼</td>
<td align="left">psubscribeCommand</td>
</tr>
<tr>
<td align="left">punsubscribe</td>
<td align="left">è§£é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼çš„è®¢é˜…</td>
<td align="left">punsubscribeCommand</td>
</tr>
<tr>
<td align="left">publish</td>
<td align="left">å‘é€ä¿¡æ¯åˆ°æŒ‡å®šé¢‘é“</td>
<td align="left">pubsubCommand</td>
</tr>
<tr>
<td align="left">pubsub</td>
<td align="left">æŸ¥çœ‹è®¢é˜…ä¿¡æ¯</td>
<td align="left">pubsubCommand</td>
</tr>
</tbody></table>
<p>Rediså‘å¸ƒè®¢é˜…çš„ç¤ºä¾‹å¯å‚è€ƒ<a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-pub-sub.html">èœé¸Ÿæ•™ç¨‹ Redis å‘å¸ƒè®¢é˜…</a></p>
<h3 id="è®¢é˜…é¢‘é“-â€”â€”-SUBSCRIBEå‘½ä»¤çš„å®ç°"><a href="#è®¢é˜…é¢‘é“-â€”â€”-SUBSCRIBEå‘½ä»¤çš„å®ç°" class="headerlink" title="è®¢é˜…é¢‘é“ â€”â€” SUBSCRIBEå‘½ä»¤çš„å®ç°"></a>è®¢é˜…é¢‘é“ â€”â€” SUBSCRIBEå‘½ä»¤çš„å®ç°<span id="jump1"></span></h3><p>å®¢æˆ·ç«¯å‘RedisæœåŠ¡å™¨å‘é€SUBSCRIBEå‘½ä»¤ï¼ŒRedisæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„è®¢é˜…è¯·æ±‚ï¼Œå°†é¢‘é“çš„è®¢é˜…å…³ç³»ä¿å­˜åœ¨å­—å…¸<code>pubsub_channels</code>ä¸­ï¼Œæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> <span class="title">server</span>;</span>	<span class="comment">/* Server global state, server.c */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span> <span class="comment">// server.h</span></span><br><span class="line">	dict *pubsub_channels;  <span class="comment">/* Map channels to list of subscribed clients */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>pubsub_channels</code>å­—å…¸çš„é”®è¡¨ç¤ºé¢‘é“ï¼Œä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œå­—å…¸çš„å€¼ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œä¿å­˜æ‰€æœ‰è®¢é˜…äº†è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯ã€‚</p>
<p>æ¯å½“ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œ<code>SUBSCRIBE channel</code>å‘½ä»¤åï¼ŒæœåŠ¡ç«¯å°†æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>å¦‚æœ<code>pubsub_channel</code>å­—å…¸ä¸åŒ…å«<code>channel</code>è¿™ä¸ªé”®ï¼Œè¯´æ˜<font color = 'blue'>æ­¤æ—¶è¿™ä¸ªé¢‘é“è¿˜æ²¡æœ‰ä»»ä½•è®¢é˜…è€…</font>ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å°†é¦–å…ˆåœ¨å­—å…¸ä¸­åˆ›å»ºä¸€ä¸ªå«<code>channel</code>çš„é”®ï¼Œå€¼åˆå§‹æˆä¸€ä¸ªç©ºé“¾è¡¨ï¼Œç„¶åå°†è¿™ä¸ªå®¢æˆ·ç«¯åŠ å…¥ç©ºé“¾è¡¨ã€‚</li>
<li>å¦‚æœ<code>pubsub_channel</code>å­—å…¸åŒ…å«<code>channel</code>è¿™ä¸ªé”®ï¼Œè¯´æ˜<font color = 'blue'>æ­¤æ—¶è¿™ä¸ªé¢‘é“å·²ç»æœ‰1ä¸ªæˆ–å¤šä¸ªè®¢é˜…è€…</font>ï¼Œæ­¤æ—¶æœåŠ¡ç«¯åœ¨å­—å…¸ä¸­æ‰¾åˆ°è¿™ä¸ªé”®å¯¹åº”çš„é“¾è¡¨ï¼Œå†å°†è¿™ä¸ªå®¢æˆ·ç«¯åŠ å…¥é“¾è¡¨æœ«å°¾ã€‚</li>
</ul>
<p>ä¸¾ä¾‹ï¼šæœ‰4ä¸ªå®¢æˆ·ç«¯(client1~client4)ï¼Œå…¶ä¸­client1, client2è®¢é˜…<code>channel1</code>, client3, client4è®¢é˜…<code>channel2</code>ï¼Œæ­¤æ—¶ï¼Œ<code>pubsub_channels</code>å­—å…¸å¯ä»¥æ˜¯ä¸‹å›¾æ‰€ç¤ºï¼š<br><img data-src="/2022/01/29/2022-01-29-redis-pubsub-study/image1.png"></p>
<h5 id="GDBæ‰“å°é¢‘é“å­—å…¸pubsub-channelsçš„æ–¹æ³•"><a href="#GDBæ‰“å°é¢‘é“å­—å…¸pubsub-channelsçš„æ–¹æ³•" class="headerlink" title="GDBæ‰“å°é¢‘é“å­—å…¸pubsub_channelsçš„æ–¹æ³•"></a><a href="#jumpx">GDBæ‰“å°é¢‘é“å­—å…¸<code>pubsub_channels</code>çš„æ–¹æ³•</a></h5><p>è®¢é˜…é¢‘é“çš„æºç å®ç°å‚è€ƒ<code>pubsub.c/subscribeCommand</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">subscribeCommand</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; c-&gt;argc; j++)</span><br><span class="line">        pubsubSubscribeChannel(c,c-&gt;argv[j]);</span><br><span class="line">    c-&gt;flags |= CLIENT_PUBSUB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Subscribe a client to a channel. Returns 1 if the operation succeeded, or</span></span><br><span class="line"><span class="comment"> * 0 if the client was already subscribed to that channel. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pubsubSubscribeChannel</span><span class="params">(client *c, robj *channel)</span> &#123;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="built_in">list</span> *clients = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dictAdd(c-&gt;pubsub_channels,channel,<span class="literal">NULL</span>) == DICT_OK) &#123;</span><br><span class="line">        retval = <span class="number">1</span>;</span><br><span class="line">        incrRefCount(channel);</span><br><span class="line">        <span class="comment">/* Add the client to the channel -&gt; list of clients hash table */</span></span><br><span class="line">        de = dictFind(server.pubsub_channels,channel);</span><br><span class="line">        <span class="keyword">if</span> (de == <span class="literal">NULL</span>) &#123; <span class="comment">// è¯´æ˜channelè¿˜æ²¡æœ‰ä»»ä½•è®¢é˜…è€…ï¼Œéœ€å…ˆåœ¨å­—å…¸ä¸­æ–°å¢channelé”®ï¼Œå†åˆå§‹åŒ–1ä¸ªé“¾è¡¨ï¼Œå¹¶å°†å®¢æˆ·ç«¯åŠ å…¥é“¾è¡¨</span></span><br><span class="line">            clients = listCreate();</span><br><span class="line">            dictAdd(server.pubsub_channels,channel,clients);</span><br><span class="line">            incrRefCount(channel);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// è¯´æ˜channelå·²æœ‰1ä¸ªæˆ–å¤šä¸ªè®¢é˜…è€…ï¼Œç›´æ¥å°†è¿™ä¸ªå®¢æˆ·ç«¯åŠ å…¥é“¾è¡¨å³å¯</span></span><br><span class="line">            clients = dictGetVal(de);</span><br><span class="line">        &#125;</span><br><span class="line">        listAddNodeTail(clients,c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Notify the client */</span></span><br><span class="line">    addReplyPubsubSubscribed(c,channel);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="é€€è®¢é¢‘é“-â€”â€”-USUBSCRIBEå‘½ä»¤çš„å®ç°"><a href="#é€€è®¢é¢‘é“-â€”â€”-USUBSCRIBEå‘½ä»¤çš„å®ç°" class="headerlink" title="é€€è®¢é¢‘é“ â€”â€” USUBSCRIBEå‘½ä»¤çš„å®ç°"></a>é€€è®¢é¢‘é“ â€”â€” USUBSCRIBEå‘½ä»¤çš„å®ç°<span id="jump2"></span></h3><p>RedisæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„é€€è®¢é¢‘é“è¯·æ±‚åï¼Œé€šè¿‡ä¿®æ”¹å­—å…¸<code>pubsub_channels</code>ï¼Œè§£é™¤å®¢æˆ·ç«¯ä¸é¢‘é“ä¹‹é—´çš„è®¢é˜…å…³ç³»ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœ<code>pubsub_channel</code>å­—å…¸åŒ…å«<code>channel</code>è¿™ä¸ªé”®ï¼Œè¯´æ˜<font color = 'blue'>æ­¤æ—¶è¿™ä¸ªé¢‘é“å·²ç»æœ‰1ä¸ªæˆ–å¤šä¸ªè®¢é˜…è€…</font>ï¼š<ul>
<li>å¦‚æœé¢‘é“æœ‰å¤šäº1ä¸ªçš„è®¢é˜…è€…ï¼ŒRedisæœåŠ¡å™¨ä¼šæŸ¥è¯¢<code>pubsub_channels</code>å­—å…¸ï¼Œæ‰¾åˆ°é¢‘é“å¯¹åº”çš„å®¢æˆ·ç«¯é“¾è¡¨ï¼Œç„¶åä»é“¾è¡¨ä¸­åˆ é™¤è¿™ä¸ªå®¢æˆ·ç«¯ã€‚</li>
<li>å¦‚æœé¢‘é“åªæœ‰1ä¸ªè®¢é˜…è€…ï¼ŒRedisæœåŠ¡å™¨å°†å¯¹åº”çš„å®¢æˆ·ç«¯é“¾è¡¨å˜æˆç©ºé“¾è¡¨ï¼Œå¹¶ä¸”ä»<code>pubsub_channels</code>å­—å…¸ä¸­åˆ é™¤è¿™ä¸ªé¢‘é“å¯¹åº”çš„é”®ã€‚</li>
</ul>
</li>
<li>å¦‚æœ<code>pubsub_channel</code>å­—å…¸ä¸åŒ…å«<code>channel</code>è¿™ä¸ªé”®ï¼Œè¯´æ˜æ²¡æœ‰å®¢æˆ·ç«¯è®¢é˜…è¿™ä¸ªé¢‘é“ï¼Œæ­¤æ—¶RedisæœåŠ¡å™¨ä¸å¯¹<code>pubsub_channels</code>å­—å…¸åšä»»ä½•ä¿®æ”¹ï¼Œåªæ˜¯ç®€å•å‘å®¢æˆ·ç«¯å‘é€å›å¤ã€‚ï¼ˆå›å¤å†…å®¹åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šâ€unsubscribeâ€, â€œchannelâ€, è¿™ä¸ªå®¢æˆ·ç«¯è®¢é˜…çš„é¢‘é“ä¸ªæ•°å’Œæ¨¡å¼ä¸ªæ•°ä¹‹å’Œï¼‰</li>
</ul>
<p>ä¸¾ä¾‹ï¼šæœ‰4ä¸ªå®¢æˆ·ç«¯(client1~client4)ï¼Œå…¶ä¸­client1, client2è®¢é˜…<code>channel1</code>, client3, client4è®¢é˜…<code>channel2</code>ã€‚</p>
<p>å‡è®¾client2æ‰§è¡Œ<code>unsubscribe channel1</code>ï¼Œclient3, client4åˆ†åˆ«æ‰§è¡Œ<code>unsubscribe channel2</code>ï¼Œé‚£ä¹ˆé€€è®¢å‰åçš„<code>pubsub_channels</code>å­—å…¸å˜åŒ–å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img data-src="/2022/01/29/2022-01-29-redis-pubsub-study/image2.png"></p>
<p>é€€è®¢é¢‘é“çš„æºç å®ç°å‚è€ƒ<code>pubsub.c/unsubscribeCommand</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">unsubscribeCommand</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;argc == <span class="number">1</span>) &#123;</span><br><span class="line">        pubsubUnsubscribeAllChannels(c,<span class="number">1</span>);				<span class="comment">// unsubscribeä¸åŠ ä»»ä½•å‚æ•°ï¼Œè¡¨ç¤ºè§£é™¤æ‰€æœ‰é¢‘é“çš„è®¢é˜…</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> j;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; c-&gt;argc; j++)</span><br><span class="line">            pubsubUnsubscribeChannel(c,c-&gt;argv[j],<span class="number">1</span>);	<span class="comment">// è§£é™¤è¿™ä¸ªå®¢æˆ·ç«¯ä¸æŸä¸ªé¢‘é“çš„è®¢é˜…å…³ç³»</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clientSubscriptionsCount(c) == <span class="number">0</span>) c-&gt;flags &amp;= ~CLIENT_PUBSUB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Unsubscribe a client from a channel. Returns 1 if the operation succeeded, or</span></span><br><span class="line"><span class="comment"> * 0 if the client was not subscribed to the specified channel. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pubsubUnsubscribeChannel</span><span class="params">(client *c, robj *channel, <span class="type">int</span> notify)</span> &#123;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="built_in">list</span> *clients;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    <span class="type">int</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Remove the channel from the client -&gt; channels hash table */</span></span><br><span class="line">    incrRefCount(channel);</span><br><span class="line">    <span class="keyword">if</span> (dictDelete(c-&gt;pubsub_channels,channel) == DICT_OK) &#123;</span><br><span class="line">        retval = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/* Remove the client from the channel -&gt; clients list hash table */</span></span><br><span class="line">        de = dictFind(server.pubsub_channels,channel);</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,de != <span class="literal">NULL</span>);</span><br><span class="line">        clients = dictGetVal(de);					<span class="comment">// 1ã€æŸ¥è¯¢pubsub_channelså­—å…¸ï¼Œæ‰¾åˆ°é¢‘é“å¯¹åº”çš„å®¢æˆ·ç«¯é“¾è¡¨clients</span></span><br><span class="line">        ln = listSearchKey(clients,c);				<span class="comment">// 2ã€åœ¨é“¾è¡¨clientsä¸­æŸ¥æ‰¾å®¢æˆ·ç«¯c</span></span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,ln != <span class="literal">NULL</span>);</span><br><span class="line">        listDelNode(clients,ln);					<span class="comment">// 3ã€ç„¶åä»é“¾è¡¨ä¸­åˆ é™¤è¿™ä¸ªå®¢æˆ·ç«¯c</span></span><br><span class="line">        <span class="keyword">if</span> (listLength(clients) == <span class="number">0</span>) &#123;				<span class="comment">// 4ã€å¦‚æœé¢‘é“åªæœ‰1ä¸ªè®¢é˜…è€…ï¼Œè¿˜éœ€è¦ä»pubsub_channelså­—å…¸ä¸­åˆ é™¤è¿™ä¸ªé¢‘é“å¯¹åº”çš„é”®</span></span><br><span class="line">            dictDelete(server.pubsub_channels,channel);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Notify the client */</span></span><br><span class="line">    <span class="keyword">if</span> (notify) addReplyPubsubUnsubscribed(c,channel);</span><br><span class="line">    decrRefCount(channel); <span class="comment">/* it is finally safe to release it */</span></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="è®¢é˜…æ¨¡å¼-â€”â€”-PSUBSCRIBEå‘½ä»¤çš„å®ç°"><a href="#è®¢é˜…æ¨¡å¼-â€”â€”-PSUBSCRIBEå‘½ä»¤çš„å®ç°" class="headerlink" title="è®¢é˜…æ¨¡å¼ â€”â€” PSUBSCRIBEå‘½ä»¤çš„å®ç°"></a>è®¢é˜…æ¨¡å¼ â€”â€” PSUBSCRIBEå‘½ä»¤çš„å®ç°<span id="jump3"></span></h3><p>RedisæœåŠ¡å™¨å°†æ‰€æœ‰æ¨¡å¼è®¢é˜…ä¿¡æ¯è®°å½•åœ¨é“¾è¡¨<code>pubsub_patterns</code>å’Œå­—å…¸<code>pubsub_pattern_dict</code>ï¼Œç›¸å…³æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> <span class="title">server</span>;</span>	<span class="comment">/* Server global state, server.c */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">    <span class="built_in">list</span> *pubsub_patterns;  <span class="comment">/* A list of pubsub_patterns */</span></span><br><span class="line">    dict *pubsub_patterns_dict;  <span class="comment">/* A dict of pubsub_patterns */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>1ã€<code>pubsub_patterns</code>é“¾è¡¨èŠ‚ç‚¹çš„ç±»å‹ä¸º<code>struct pubsubPattern</code>ï¼Œå…¶ä¸­<code>pattern</code>æˆå‘˜è¡¨ç¤ºè®¢é˜…çš„æ¨¡å¼ä¸²ï¼Œ<code>client</code>æˆå‘˜è®°å½•è®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pubsubPattern</span> &#123;</span></span><br><span class="line">    client *client;			<span class="comment">// è®°å½•è®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯</span></span><br><span class="line">    robj *pattern;			<span class="comment">// è¡¨ç¤ºè®¢é˜…çš„æ¨¡å¼ä¸²</span></span><br><span class="line">&#125; pubsubPattern;</span><br></pre></td></tr></table></figure>

<p>2ã€<code>pubsub_patterns_dict</code>å­—å…¸çš„é”®ä¸ºè¢«è®¢é˜…çš„æ¨¡å¼ï¼ˆ<code>robj *</code>ç±»å‹ï¼‰ï¼Œå­—å…¸çš„å€¼ä¸ºé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨è®°å½•æ‰€æœ‰è®¢é˜…äº†è¿™ä¸ªæ¨¡å¼çš„å®¢æˆ·ç«¯ ã€‚</p>
<p>å½“å®¢æˆ·ç«¯æ‰§è¡ŒPSUBSCRIBEå‘½ä»¤åï¼ŒRedisæœåŠ¡å™¨ä¼šæ”¶åˆ°è¿™ä¸ªæ¨¡å¼è®¢é˜…è¯·æ±‚ï¼Œå¹¶æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ª<code>struct pubsubPattern</code>ç»“æ„ï¼Œå…¶ä¸­<code>pattern</code>æˆå‘˜è®¾ç½®ä¸ºè¢«è®¢é˜…çš„æ¨¡å¼ï¼Œ<code>client</code>æˆå‘˜è®¾ç½®ä¸ºè®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯</li>
<li>å°†<code>struct pubsubPattern</code>ç»“æ„åŠ å…¥åˆ°<code>pubsub_patterns</code>é“¾è¡¨çš„æœ«å°¾ã€‚</li>
<li>ç„¶ååœ¨<code>pubsub_patterns_dict</code>å­—å…¸ä¸­æŸ¥æ‰¾è¿™ä¸ªæ¨¡å¼ï¼š<ul>
<li>å¦‚æœæ²¡æŸ¥åˆ°ï¼Œè¯´æ˜è¿™ä¸ªæ¨¡å¼è¿˜æ²¡æœ‰ä»»ä½•å®¢æˆ·ç«¯è®¢é˜…ã€‚æ­¤æ—¶Redisåœ¨<code>pubsub_patterns_dict</code>å­—å…¸ä¸­ä¸ºè¿™ä¸ªæ¨¡å¼åˆ›å»ºä¸€ä¸ªé”®ï¼Œå°†è¿™ä¸ªé”®çš„å€¼è®¾ä¸ºç©ºé“¾è¡¨ï¼Œå†å°†å®¢æˆ·ç«¯åŠ å…¥é“¾è¡¨ã€‚</li>
<li>å¦‚æœèƒ½æŸ¥åˆ°ï¼Œè¯´æ˜è¿™ä¸ªæ¨¡å¼å·²æœ‰å®¢æˆ·ç«¯è®¢é˜…ï¼Œ<code>pubsub_patterns_dict</code>å­—å…¸ä¸­å¿…æœ‰å¯¹åº”çš„å®¢æˆ·ç«¯é“¾è¡¨ï¼Œæ­¤æ—¶Redisåªéœ€å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°è¿™ä¸ªå®¢æˆ·ç«¯é“¾è¡¨çš„æœ«å°¾å³å¯ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸¾ä¾‹ï¼šæœ‰4ä¸ªå®¢æˆ·ç«¯(client1~client4)ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>client1è®¢é˜…æ¨¡å¼pat1*</li>
<li>client2è®¢é˜…æ¨¡å¼pat2*</li>
<li>client3, client4è®¢é˜…æ¨¡å¼pat3*ã€‚</li>
</ul>
<p>æ­¤æ—¶<code>pubsub_patterns_dict</code>å­—å…¸å’Œ<code>pubsub_patterns</code>é“¾è¡¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img data-src="/2022/01/29/2022-01-29-redis-pubsub-study/image3.png"></p>
<h5 id="GDBæ‰“å°æ¨¡å¼å­—å…¸å’Œæ¨¡å¼é“¾è¡¨çš„æ–¹æ³•"><a href="#GDBæ‰“å°æ¨¡å¼å­—å…¸å’Œæ¨¡å¼é“¾è¡¨çš„æ–¹æ³•" class="headerlink" title="GDBæ‰“å°æ¨¡å¼å­—å…¸å’Œæ¨¡å¼é“¾è¡¨çš„æ–¹æ³•"></a><a href="#jumpy">GDBæ‰“å°æ¨¡å¼å­—å…¸å’Œæ¨¡å¼é“¾è¡¨çš„æ–¹æ³•</a></h5><p>è®¢é˜…æ¨¡å¼çš„æºç å‚è€ƒ<code>pubsub.c/pubsubSubscribePattern</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Subscribe a client to a pattern. Returns 1 if the operation succeeded, or 0 if the client was already subscribed to that pattern. */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pubsubSubscribePattern</span><span class="params">(client *c, robj *pattern)</span> &#123;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="built_in">list</span> *clients;</span><br><span class="line">    <span class="type">int</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listSearchKey(c-&gt;pubsub_patterns,pattern) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        retval = <span class="number">1</span>;</span><br><span class="line">        pubsubPattern *pat;</span><br><span class="line">        listAddNodeTail(c-&gt;pubsub_patterns,pattern);</span><br><span class="line">        incrRefCount(pattern);</span><br><span class="line">        pat = zmalloc(<span class="keyword">sizeof</span>(*pat));					<span class="comment">// 1ã€æ„é€ ä¸€ä¸ªpubsubPatternç»“æ„</span></span><br><span class="line">        pat-&gt;pattern = getDecodedObject(pattern);		<span class="comment">// 2ã€patternæˆå‘˜è®¾ç½®ä¸ºè¢«è®¢é˜…çš„æ¨¡å¼</span></span><br><span class="line">        pat-&gt;client = c;								<span class="comment">// 3ã€clientæˆå‘˜è®¾ç½®ä¸ºè®¢é˜…è¿™ä¸ªæ¨¡å¼çš„å®¢æˆ·ç«¯</span></span><br><span class="line">        listAddNodeTail(server.pubsub_patterns,pat);	<span class="comment">// 4ã€æ·»åŠ è¿™ä¸ªpubsubPaternç»“æ„åˆ°pubsub_patternsé“¾è¡¨å°¾</span></span><br><span class="line">        <span class="comment">/* Add the client to the pattern -&gt; list of clients hash table */</span></span><br><span class="line">        de = dictFind(server.pubsub_patterns_dict,pattern);</span><br><span class="line">        <span class="keyword">if</span> (de == <span class="literal">NULL</span>) &#123;	<span class="comment">// å¦‚æœæ²¡æŸ¥åˆ°ï¼Œè¯´æ˜è¿™ä¸ªæ¨¡å¼è¿˜æ²¡æœ‰å®¢æˆ·ç«¯è®¢é˜…ï¼Œæ­¤æ—¶å…ˆåœ¨å­—å…¸ä¸­ä¸ºè¿™ä¸ªæ¨¡å¼åˆ›å»ºä¸€ä¸ªé”®ï¼Œé”®çš„å€¼ä¸ºç©ºé“¾è¡¨</span></span><br><span class="line">            clients = listCreate();</span><br><span class="line">            dictAdd(server.pubsub_patterns_dict,pattern,clients);</span><br><span class="line">            incrRefCount(pattern);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            clients = dictGetVal(de);</span><br><span class="line">        &#125;</span><br><span class="line">        listAddNodeTail(clients,c);	<span class="comment">// å°†å®¢æˆ·ç«¯cåŠ å…¥é“¾è¡¨clients</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Notify the client */</span></span><br><span class="line">    addReplyPubsubPatSubscribed(c,pattern);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="é€€è®¢æ¨¡å¼-â€”â€”-PUNSUBSCRIBEå‘½ä»¤çš„å®ç°"><a href="#é€€è®¢æ¨¡å¼-â€”â€”-PUNSUBSCRIBEå‘½ä»¤çš„å®ç°" class="headerlink" title="é€€è®¢æ¨¡å¼ â€”â€” PUNSUBSCRIBEå‘½ä»¤çš„å®ç°"></a>é€€è®¢æ¨¡å¼ â€”â€” PUNSUBSCRIBEå‘½ä»¤çš„å®ç°<span id="jump4"></span></h3><p>æ¨¡å¼é€€è®¢æ“ä½œå’Œæ¨¡å¼è®¢é˜…çš„æ“ä½œæ­£å¥½ç›¸åï¼Œå½“å®¢æˆ·ç«¯æ‰§è¡ŒPUNSUBSCRIBEå‘½ä»¤é€€è®¢ä¸€ä¸ªæ¨¡å¼æ—¶ï¼ŒRedisæœåŠ¡å™¨å°†å‘ç”Ÿå¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>åœ¨<code>pubsub_patterns</code>é“¾è¡¨ä¸­æŸ¥æ‰¾è¿™ä¸ªå®¢æˆ·ç«¯å¹¶åˆ é™¤ã€‚</li>
<li>åœ¨<code>pubsub_patterns_dict</code>å­—å…¸ä¸­ï¼Œæ‰¾åˆ°è¿™ä¸ªæ¨¡å¼å¯¹åº”çš„å®¢æˆ·ç«¯é“¾è¡¨ï¼Œåœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾è¿™ä¸ªå®¢æˆ·ç«¯å¹¶åˆ é™¤ã€‚</li>
</ul>
<p>ä¸¾ä¾‹ï¼šæœ‰4ä¸ªå®¢æˆ·ç«¯(client1~client4)ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>client1è®¢é˜…äº†æ¨¡å¼pat1*</li>
<li>client2è®¢é˜…äº†æ¨¡å¼pat2*</li>
<li>client3, client4è®¢é˜…äº†æ¨¡å¼pat3*ã€‚</li>
</ul>
<p>å‡è®¾æ­¤æ—¶client2æ‰§è¡Œ<code>unpsubscribe pat2*</code>ï¼Œclient4æ‰§è¡Œ<code>unsubscribe pat3*</code>ï¼Œé‚£ä¹ˆæ¨¡å¼é€€è®¢å‰åçš„<code>pubsub_patterns</code>é“¾è¡¨å’Œ<code>pubsub_patterns_dict</code>å­—å…¸å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>[O<br><img data-src="/2022/01/29/2022-01-29-redis-pubsub-study/image4.png"></p>
<p>æ¨¡å¼é€€è®¢çš„æºç å‚è€ƒ<code>pubsub.c/punsubscribeCommand</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">punsubscribeCommand</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;argc == <span class="number">1</span>) &#123;</span><br><span class="line">        pubsubUnsubscribeAllPatterns(c,<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; c-&gt;argc; j++)</span><br><span class="line">            pubsubUnsubscribePattern(c,c-&gt;argv[j],<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (clientSubscriptionsCount(c) == <span class="number">0</span>) c-&gt;flags &amp;= ~CLIENT_PUBSUB;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pubsubUnsubscribePattern</span><span class="params">(client *c, robj *pattern, <span class="type">int</span> notify)</span> &#123;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    <span class="built_in">list</span> *clients;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    pubsubPattern pat;</span><br><span class="line">    <span class="type">int</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    incrRefCount(pattern); <span class="comment">/* Protect the object. May be the same we remove */</span></span><br><span class="line">    <span class="keyword">if</span> ((ln = listSearchKey(c-&gt;pubsub_patterns,pattern)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        retval = <span class="number">1</span>;</span><br><span class="line">        listDelNode(c-&gt;pubsub_patterns,ln);</span><br><span class="line">        pat.client = c;</span><br><span class="line">        pat.pattern = pattern;</span><br><span class="line">        ln = listSearchKey(server.pubsub_patterns,&amp;pat);</span><br><span class="line">        listDelNode(server.pubsub_patterns,ln);			<span class="comment">// åœ¨pubsub_patternsé“¾è¡¨ä¸­æŸ¥æ‰¾è¿™ä¸ªå®¢æˆ·ç«¯å¹¶åˆ é™¤ã€‚</span></span><br><span class="line">        <span class="comment">/* Remove the client from the pattern -&gt; clients list hash table */</span></span><br><span class="line">        de = dictFind(server.pubsub_patterns_dict,pattern);</span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,de != <span class="literal">NULL</span>);</span><br><span class="line">        clients = dictGetVal(de);</span><br><span class="line">        ln = listSearchKey(clients,c);	<span class="comment">// æŸ¥æ‰¾pubsub_patterns_dictå­—å…¸ï¼Œæ‰¾åˆ°å®¢æˆ·ç«¯é“¾è¡¨ï¼Œåœ¨é“¾è¡¨ä¸­åˆ é™¤è¿™ä¸ªå®¢æˆ·ç«¯èŠ‚ç‚¹</span></span><br><span class="line">        serverAssertWithInfo(c,<span class="literal">NULL</span>,ln != <span class="literal">NULL</span>);</span><br><span class="line">        listDelNode(clients,ln);</span><br><span class="line">        <span class="keyword">if</span> (listLength(clients) == <span class="number">0</span>) &#123;	<span class="comment">// å¦‚æœåˆ é™¤èŠ‚ç‚¹åçš„é“¾è¡¨é•¿åº¦ä¸º0ï¼ŒæŠŠé”®patternä¹Ÿä»å­—å…¸ä¸­åˆ é™¤ã€‚</span></span><br><span class="line">            <span class="comment">/* Free the list and associated hash entry at all if this was</span></span><br><span class="line"><span class="comment">             * the latest client. */</span></span><br><span class="line">            dictDelete(server.pubsub_patterns_dict,pattern);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Notify the client */</span></span><br><span class="line">    <span class="keyword">if</span> (notify) addReplyPubsubPatUnsubscribed(c,pattern);</span><br><span class="line">    decrRefCount(pattern);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å‘é€æ¶ˆæ¯-â€”â€”-PUBLISHå‘½ä»¤çš„å®ç°"><a href="#å‘é€æ¶ˆæ¯-â€”â€”-PUBLISHå‘½ä»¤çš„å®ç°" class="headerlink" title="å‘é€æ¶ˆæ¯ â€”â€” PUBLISHå‘½ä»¤çš„å®ç°"></a>å‘é€æ¶ˆæ¯ â€”â€” PUBLISHå‘½ä»¤çš„å®ç°<span id="jump5"></span></h3><p>å®¢æˆ·ç«¯æ‰§è¡Œ<code>PUBLISH channel message</code>å‘½ä»¤æ—¶ï¼ŒRedisæœåŠ¡å™¨å°†æ‰§è¡Œå¦‚ä¸‹ä¸¤ä¸ªé‡è¦æ“ä½œï¼š</p>
<ul>
<li>é¦–å…ˆï¼ŒæŸ¥æ‰¾<code>pubsub_channels</code>å­—å…¸ï¼Œå°†æ¶ˆæ¯å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ã€‚</li>
<li>å…¶æ¬¡ï¼ŒæŸ¥æ‰¾<code>pubsub_patterns_dict</code>å­—å…¸ï¼Œæ‰¾å‡ºæ‰€æœ‰åŒ¹é…è¿™ä¸ªé¢‘é“çš„æ¨¡å¼ï¼Œå†å°†æ¶ˆæ¯å‘é€ç»™è¿™äº›æ¨¡å¼çš„è®¢é˜…è€…ã€‚</li>
</ul>
<p>å‘å¸ƒæ¶ˆæ¯çš„æºç å®ç°å‚è€ƒ<code>publishCommand</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">publishCommand</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    <span class="type">int</span> receivers = pubsubPublishMessage(c-&gt;argv[<span class="number">1</span>],c-&gt;argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled)</span><br><span class="line">        clusterPropagatePublish(c-&gt;argv[<span class="number">1</span>],c-&gt;argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        forceCommandPropagation(c,PROPAGATE_REPL);</span><br><span class="line">    addReplyLongLong(c,receivers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pubsubPublishMessage</span><span class="params">(robj *channel, robj *message)</span> &#123;</span><br><span class="line">    <span class="type">int</span> receivers = <span class="number">0</span>;</span><br><span class="line">    dictEntry *de;</span><br><span class="line">    dictIterator *di;</span><br><span class="line">    listNode *ln;</span><br><span class="line">    listIter li;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1ã€å…ˆæŸ¥æ‰¾é¢‘é“å­—å…¸`pubsub_channels` ï¼Œå°†æ¶ˆæ¯å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…</span></span><br><span class="line">    de = dictFind(server.pubsub_channels,channel);</span><br><span class="line">    <span class="keyword">if</span> (de) &#123;</span><br><span class="line">        <span class="built_in">list</span> *<span class="built_in">list</span> = dictGetVal(de);</span><br><span class="line">        listNode *ln;</span><br><span class="line">        listIter li;</span><br><span class="line"></span><br><span class="line">        listRewind(<span class="built_in">list</span>,&amp;li);</span><br><span class="line">        <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            client *c = ln-&gt;value;</span><br><span class="line">            addReplyPubsubMessage(c,channel,message);	<span class="comment">// å°†æ¶ˆæ¯å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…</span></span><br><span class="line">            receivers++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2ã€å†æŸ¥æ‰¾æ¨¡å¼å­—å…¸pubsub_patterns_dict, æ‰¾å‡ºæ‰€æœ‰åŒ¹é…è¿™ä¸ªchannelçš„æ¨¡å¼ï¼Œå°†æ¶ˆæ¯å‘é€ç»™è¿™äº›æ¨¡å¼çš„æ‰€æœ‰è®¢é˜…è€…</span></span><br><span class="line">    di = dictGetIterator(server.pubsub_patterns_dict);</span><br><span class="line">    <span class="keyword">if</span> (di) &#123;</span><br><span class="line">        channel = getDecodedObject(channel);</span><br><span class="line">        <span class="keyword">while</span>((de = dictNext(di)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            robj *pattern = dictGetKey(de);</span><br><span class="line">            <span class="built_in">list</span> *clients = dictGetVal(de);</span><br><span class="line">            <span class="keyword">if</span> (!stringmatchlen((<span class="type">char</span>*)pattern-&gt;ptr,	<span class="comment">// åˆ¤æ–­æ¨¡å¼æ˜¯å¦ä¸é¢‘é“channelåŒ¹é…</span></span><br><span class="line">                                sdslen(pattern-&gt;ptr),</span><br><span class="line">                                (<span class="type">char</span>*)channel-&gt;ptr,</span><br><span class="line">                                sdslen(channel-&gt;ptr),<span class="number">0</span>)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// éå†è¿™ä¸ªæ¨¡å¼çš„å®¢æˆ·ç«¯é“¾è¡¨ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°æ‰€æœ‰è®¢é˜…è¿™ä¸ªæ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</span></span><br><span class="line">            listRewind(clients,&amp;li);</span><br><span class="line">            <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                client *c = listNodeValue(ln);</span><br><span class="line">                addReplyPubsubPatMessage(c,pattern,channel,message);</span><br><span class="line">                receivers++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        decrRefCount(channel);</span><br><span class="line">        dictReleaseIterator(di);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> receivers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆæºç ï¼Œå¯ä»¥çœ‹å‡º<strong>Rediså‘å¸ƒè®¢é˜…çš„ç‰¹ç‚¹</strong>ï¼š<span id="jump6"></span></p>
<ul>
<li><p>å‘å¸ƒçš„æ¶ˆæ¯ä¸ä¿ç•™åœ¨å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»å…ˆæœ‰è®¢é˜…è€…ï¼Œå‘å¸ƒè€…å‘é€çš„æ¶ˆæ¯æ‰æœ‰æ„ä¹‰ã€‚</p>
</li>
<li><p>è®¢é˜…çš„æ¨¡å¼åç§°æ”¯æŒ<code>glob</code>é£æ ¼çš„åŒ¹é…ç¬¦ï¼Œç¤ºä¾‹å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://blog.huangz.me/diary/2013/redis-pubsub-glob-pattern-example.html">Redis å‘å¸ƒä¸è®¢é˜…æ¨¡å¼åŒ¹é…ç¬¦ç¤ºä¾‹</a></p>
</li>
</ul>
<h4 id="ä¸ºä»€ä¹ˆè®¾è®¡pubsub-patterns-dictå­—å…¸ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè®¾è®¡pubsub-patterns-dictå­—å…¸ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè®¾è®¡pubsub_patterns_dictå­—å…¸ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè®¾è®¡pubsub_patterns_dictå­—å…¸ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ<span id="jump7"></span></h4><p>å‡è®¾æœ‰Nä¸ªå®¢æˆ·ç«¯, æ¯ä¸ªå®¢æˆ·ç«¯è®¢é˜…äº†1ä¸ªæ¨¡å¼ï¼›å¦‚æœåªä½¿ç”¨é“¾è¡¨ï¼Œåˆ¤æ–­æ‰€æœ‰æ¨¡å¼æ˜¯å¦ä¸æŒ‡å®šé¢‘é“åŒ¹é…çš„æ¬¡æ•°å›ºå®šä¸ºNæ¬¡ï¼Œæ•ˆç‡è¾ƒä½ã€‚</p>
<p>ç”±äºå®é™…åœºæ™¯ä¸­ï¼Œ<font color = 'blue'>å­˜åœ¨åŒä¸€ä¸ªæ¨¡å¼è¢«å¤šä¸ªå®¢æˆ·ç«¯è®¢é˜…çš„åœºæ™¯</font>ï¼Œæ‰€ä»¥è®¾è®¡<code>pubsub_patterns_dict</code>å­—å…¸çš„å¥½å¤„åœ¨äºï¼Œå°†è¿™ä¸ªåˆ¤æ–­æ¬¡æ•°ä»Næ¬¡é™ä½ä¸ºæœ€å¤šNæ¬¡ï¼Œæé«˜æ•ˆç‡ã€‚</p>
<h3 id="ä¸€æ¬¡å®Œæ•´çš„Redisè®¢é˜…ã€å‘å¸ƒæµç¨‹åˆ†æ"><a href="#ä¸€æ¬¡å®Œæ•´çš„Redisè®¢é˜…ã€å‘å¸ƒæµç¨‹åˆ†æ" class="headerlink" title="ä¸€æ¬¡å®Œæ•´çš„Redisè®¢é˜…ã€å‘å¸ƒæµç¨‹åˆ†æ"></a>ä¸€æ¬¡å®Œæ•´çš„Redisè®¢é˜…ã€å‘å¸ƒæµç¨‹åˆ†æ<span id="jump10"></span></h3><p>å‡è®¾æœ‰1ä¸ªé¢‘é“è®¢é˜…è€…å’Œ1ä¸ªæ¶ˆæ¯å‘å¸ƒè€…ï¼Œä¸€æ¬¡å®Œæ•´çš„Redisè®¢é˜…ã€å‘å¸ƒæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img data-src="/2022/01/29/2022-01-29-redis-pubsub-study/image5.png"></p>
<h4 id="ä¸ºä»€ä¹ˆredis-cliä¸­æ‰§è¡Œäº†subscribeå‘½ä»¤åæ— æ³•å†æ‰§è¡Œunsubscribeå‘½ä»¤ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆredis-cliä¸­æ‰§è¡Œäº†subscribeå‘½ä»¤åæ— æ³•å†æ‰§è¡Œunsubscribeå‘½ä»¤ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆredis-cliä¸­æ‰§è¡Œäº†subscribeå‘½ä»¤åæ— æ³•å†æ‰§è¡Œunsubscribeå‘½ä»¤ï¼Ÿ"></a>ä¸ºä»€ä¹ˆredis-cliä¸­æ‰§è¡Œäº†subscribeå‘½ä»¤åæ— æ³•å†æ‰§è¡Œunsubscribeå‘½ä»¤ï¼Ÿ<span id="jump11"></span></h4><p>è§‚å¯Ÿæµç¨‹å›¾ä¸­çš„ç¬¬5æ­¥ï¼Œè®¢é˜…è€…æˆåŠŸå»ºç«‹é•¿è¿æ¥åï¼Œä¼šè¿›å…¥whileæ­»å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯è°ƒç”¨å‡½æ•°<code>cliReadReply</code>è¯»å–ä¸€æ¡é¢‘é“çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥æ— æ³•å†æ‰§è¡Œ<code>unsubscribe</code>å‘½ä»¤ã€‚redis-cliçš„è°ƒç”¨æ ˆå‚è€ƒå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00007ffff7e5d5b0</span> in __libc_recv (fd=<span class="number">3</span>, buf=<span class="number">0x7fffffffa200</span>, len=<span class="number">16384</span>, flags=flags@entry=<span class="number">0</span>) at ../sysdeps/unix/sysv/linux/recv.c:<span class="number">28</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x000055555558ec0b</span> in <span class="title function_">recv</span> <span class="params">(__flags=<span class="number">0</span>, __n=&lt;optimized out&gt;, __buf=&lt;optimized out&gt;, __fd=&lt;optimized out&gt;)</span></span><br><span class="line">    at /usr/include/x86_64-linux-gnu/bits/socket2.h:44</span><br><span class="line">#2  <span class="title function_">redisNetRead</span> <span class="params">(c=<span class="number">0x555555841300</span>, buf=&lt;optimized out&gt;, bufcap=&lt;optimized out&gt;)</span> at net.c:61</span><br><span class="line">#3  0x0000555555587702 in <span class="title function_">redisBufferRead</span> <span class="params">(c=<span class="number">0x555555841300</span>)</span> at hiredis.c:881</span><br><span class="line">#4  0x0000555555587a92 in <span class="title function_">main</span> <span class="params">(c=<span class="number">0x555555841300</span>, reply=<span class="number">0x7fffffffe280</span>)</span> at hiredis.c:954</span><br><span class="line">#5  0x000055555557fadd in <span class="title function_">cliReadReply</span> <span class="params">(output_raw_strings=<span class="number">0</span>)</span> at redis-cli.c:1204</span><br><span class="line">#6  0x0000555555581e0d in <span class="title function_">cliSendCommand</span> <span class="params">(argc=<span class="number">2</span>, argv=<span class="number">0x7ffff780a000</span>, repeat=<span class="number">0</span>)</span> at redis-cli.c:1361</span><br><span class="line">#7  0x0000555555582006 in <span class="title function_">issueCommandRepeat</span> <span class="params">(argc=<span class="number">2</span>, argv=<span class="number">0x7ffff780a000</span>, repeat=<span class="number">1</span>)</span> at redis-cli.c:1858</span><br><span class="line">#8  0x000055555556dd8d in <span class="title function_">issueCommand</span> <span class="params">(argv=<span class="number">0x7ffff780a000</span>, argc=&lt;optimized out&gt;)</span> at redis-cli.c:2090</span><br><span class="line">#9  <span class="title function_">noninteractive</span> <span class="params">(argv=<span class="number">0x7ffff780a000</span>, argc=&lt;optimized out&gt;)</span> at redis-cli.c:2090</span><br><span class="line">#10 <span class="title function_">main</span> <span class="params">(argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;)</span> at redis-cli.c:8251</span><br></pre></td></tr></table></figure>



<h4 id="TCPæ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œè®¢é˜…è€…æ˜¯å¦‚ä½•ä¿è¯æ­£ç¡®è§£æå‘å¸ƒè€…çš„æ¶ˆæ¯"><a href="#TCPæ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œè®¢é˜…è€…æ˜¯å¦‚ä½•ä¿è¯æ­£ç¡®è§£æå‘å¸ƒè€…çš„æ¶ˆæ¯" class="headerlink" title="TCPæ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œè®¢é˜…è€…æ˜¯å¦‚ä½•ä¿è¯æ­£ç¡®è§£æå‘å¸ƒè€…çš„æ¶ˆæ¯?"></a><a href="#jump12">TCPæ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œè®¢é˜…è€…æ˜¯å¦‚ä½•ä¿è¯æ­£ç¡®è§£æå‘å¸ƒè€…çš„æ¶ˆæ¯?</a><span id="jump12"></span></h4><p>è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼Œå‘å¸ƒè€…ä¾æ¬¡å‘å¸ƒä¸¤æ¡æ¶ˆæ¯åˆ°æœåŠ¡ç«¯ï¼Œå‡è®¾æ¶ˆæ¯å†…å®¹åˆ†åˆ«ä¸ºâ€helloâ€ â€œworldâ€ã€‚ç”±äºTCPåè®®æ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œå¦‚æœå®¢æˆ·ç«¯ä»…é€šè¿‡å¾ªç¯è°ƒç”¨<code>read()</code>çš„æ–¹å¼è¯»å–æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå¦‚ä¸‹ä¸ç¬¦åˆé¢„æœŸçš„æƒ…å†µï¼š</p>
<ul>
<li><code>read</code>åªè°ƒç”¨äº†1æ¬¡ï¼Œè¿”å›çš„æ˜¯â€helloworldâ€</li>
<li><code>read</code>è°ƒç”¨äº†2æ¬¡ï¼Œä½†è¿”å›çš„æ˜¯â€hellâ€ â€œoworldâ€ï¼Œæˆ–è€…â€helloworâ€ â€œldâ€ï¼Œç­‰ç­‰ã€‚</li>
<li><code>read</code>è°ƒç”¨äº†3æ¬¡ï¼Œä¾æ¬¡è¿”å›â€hellâ€, â€œowoâ€, â€œrldâ€</li>
<li>â€¦â€¦</li>
</ul>
<p>é’ˆå¯¹ä»¥ä¸Šçš„TCPæ— æ¶ˆæ¯è¾¹ç•Œé—®é¢˜ï¼Œä¸€èˆ¬æœ‰å¦‚ä¸‹3ç§å¸¸è§çš„è§£å†³ç­–ç•¥ï¼š</p>
<ul>
<li>æ¯æ¬¡åªå‘é€å›ºå®šé•¿åº¦çš„æ¶ˆæ¯</li>
<li>æŠŠæ¶ˆæ¯çš„å¤§å°å’Œå†…å®¹ä¸€å¹¶å‘é€</li>
<li>ä½¿ç”¨ç‰¹æ®Šæ ‡è®°åˆ’åˆ†æ¶ˆæ¯è¾¹ç•Œ</li>
</ul>
<p>å…¶ä¸­ï¼ŒRedisé‡‡ç”¨ç¬¬ä¸‰ç§ç­–ç•¥ï¼Œå³é€šè¿‡è‡ªå®šä¹‰RESPåè®®çš„æ–¹å¼ï¼Œä½¿ç”¨CRLF(<code>\r\n</code>)ä½œä¸ºæ¶ˆæ¯è¾¹ç•Œã€‚</p>
<p>æ¯”å¦‚æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å›å¤æ¶ˆæ¯â€subscribe channel1 1â€ï¼Œå¯¹åº”çš„TCPæŠ¥æ–‡å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">15:36:47.498803 IP localhost.6379 &gt; localhost.50208: Flags [P.], seq 1:38, ack 34, win 512, options [nop,nop,TS val 3705662770 ecr 3705662770], length 37: RESP &quot;subscribe&quot; &quot;channel1&quot; &quot;1&quot;</span><br><span class="line">        0x0000:  4500 0059 d241 4000 4006 6a5b 7f00 0001  E..Y.A@.@.j[....</span><br><span class="line">        0x0010:  7f00 0001 18eb c420 f57a bd66 c0c1 f5d6  .........z.f....</span><br><span class="line">        0x0020:  8018 0200 fe4d 0000 0101 080a dcdf ed32  .....M.........2</span><br><span class="line">        0x0030:  dcdf ed32 2a33 0d0a 2439 0d0a 7375 6273  ...2*3..$9..subs</span><br><span class="line">        0x0040:  6372 6962 650d 0a24 380d 0a63 6861 6e6e  cribe..$8..chann</span><br><span class="line">        0x0050:  656c 310d 0a3a 310d 0a                   el1..:1..</span><br></pre></td></tr></table></figure>
<h5 id="é™„ï¼šä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ï¼Œè¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹æŠ“åŒ…ç»“æœ"><a href="#é™„ï¼šä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ï¼Œè¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹æŠ“åŒ…ç»“æœ" class="headerlink" title="é™„ï¼šä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ï¼Œè¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹æŠ“åŒ…ç»“æœ"></a><a href="#jumpz">é™„ï¼šä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ï¼Œè¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹æŠ“åŒ…ç»“æœ</a></h5><p>å¯ä»¥çœ‹å‡ºï¼Œâ€subscribe channel1 1â€å‘½ä»¤åœ¨TCPæŠ¥æ–‡ä¸­å­˜å‚¨çš„åè®®å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*3\r\n$9\r\nsubscribe\r\n$8\r\nchannel1\r\n:1</span><br></pre></td></tr></table></figure>

<p>åè®®å†…å®¹çš„è§£æå‚è€ƒ<a target="_blank" rel="noopener" href="https://redis.io/topics/protocol">Redisåè®®è§„èŒƒï¼ˆRESPï¼‰</a> ï¼Œ ä»¥ä¸‹åªåšç®€å•çš„è§£é‡Šï¼š</p>
<ul>
<li>*3 è¡¨ç¤ºæ•°ç»„é•¿åº¦ä¸º3ï¼Œ æ•°ç»„å…ƒç´ ä¾æ¬¡ä¸º [â€œsubscribeâ€ channel1â€ â€œ1â€]</li>
<li>$9 è¡¨ç¤ºå­—ç¬¦ä¸² â€œsubscribeâ€ çš„é•¿åº¦</li>
<li>$8è¡¨ç¤ºå­—ç¬¦ä¸² â€œchannel1â€ çš„é•¿åº¦</li>
<li>ï¼šè¡¨ç¤ºç±»å‹ä¸ºæ•´æ•°ï¼Œ:1è¡¨ç¤ºç¬¬ä¸‰ä¸ªå…ƒç´ ä¸ºæ•´æ•°ï¼Œå–å€¼ä¸º1</li>
</ul>
<p>å¦å¤–ï¼Œå®¢æˆ·ç«¯ç¨‹åºredis-cliä¸­ï¼Œé€šè¿‡å°è£…å‡½æ•°<code>redisGetReply</code>è·å–ä¸€æ¬¡å®Œæ•´çš„æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ç®€å•åœ°å¾ªç¯è°ƒç”¨read()ï¼Œä»è€Œç¡®ä¿æ­£ç¡®åœ°è§£ææœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯ã€‚</p>
<h4 id="è®¢é˜…çš„å®¢æˆ·ç«¯æ–­çº¿ï¼ŒæœåŠ¡ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥çš„ï¼Ÿå¦‚ä½•ä¿è¯è¿™ä¸ªå®¢æˆ·ç«¯çš„é¢‘é“ã€æ¨¡å¼è®¢é˜…ä¿¡æ¯ä¹Ÿè¢«åŒæ­¥åˆ é™¤ï¼Ÿ"><a href="#è®¢é˜…çš„å®¢æˆ·ç«¯æ–­çº¿ï¼ŒæœåŠ¡ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥çš„ï¼Ÿå¦‚ä½•ä¿è¯è¿™ä¸ªå®¢æˆ·ç«¯çš„é¢‘é“ã€æ¨¡å¼è®¢é˜…ä¿¡æ¯ä¹Ÿè¢«åŒæ­¥åˆ é™¤ï¼Ÿ" class="headerlink" title="è®¢é˜…çš„å®¢æˆ·ç«¯æ–­çº¿ï¼ŒæœåŠ¡ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥çš„ï¼Ÿå¦‚ä½•ä¿è¯è¿™ä¸ªå®¢æˆ·ç«¯çš„é¢‘é“ã€æ¨¡å¼è®¢é˜…ä¿¡æ¯ä¹Ÿè¢«åŒæ­¥åˆ é™¤ï¼Ÿ"></a>è®¢é˜…çš„å®¢æˆ·ç«¯æ–­çº¿ï¼ŒæœåŠ¡ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥çš„ï¼Ÿå¦‚ä½•ä¿è¯è¿™ä¸ªå®¢æˆ·ç«¯çš„é¢‘é“ã€æ¨¡å¼è®¢é˜…ä¿¡æ¯ä¹Ÿè¢«åŒæ­¥åˆ é™¤ï¼Ÿ<span id="jump8"></span></h4><p>å‡è®¾1ä¸ªå®¢æˆ·ç«¯é€šè¿‡<code>redis-cli</code>è®¢é˜…é¢‘é“<code>channel1</code>ä¹‹åï¼ŒæŒ‰ä¸‹äº†Ctrl+Cé€€å‡ºï¼Œæ­¤æ—¶æœåŠ¡å™¨å°†ä¾æ¬¡å‘ç”Ÿå¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>1ã€é¦–å…ˆé€šè¿‡I&#x2F;Oå¤šè·¯å¤ç”¨å™¨(<code>select</code>&#x2F;<code>poll</code>&#x2F;<code>epoll</code>)ç›‘å¬è¿™ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—çš„å¯è¯»äº‹ä»¶ï¼Œè§¦å‘å‘½ä»¤è¯·æ±‚å¤„ç†çš„å›è°ƒå‡½æ•°<code>readQueryFromClient</code>ã€‚è°ƒç”¨é“¾<code>aeMain -&gt; aeProcessEvents -&gt; readQueryFromClient -&gt; read</code>ï¼Œè°ƒç”¨æ ˆå‚è€ƒï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt <span class="comment">// 1ã€é¦–å…ˆé€šè¿‡I/Oå¤šè·¯å¤ç”¨å™¨ç›‘å¬è¿™ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—çš„å¯è¯»äº‹ä»¶ï¼Œè§¦å‘å‘½ä»¤è¯·æ±‚å¤„ç†çš„å›è°ƒå‡½æ•°readQueryFromClient</span></span><br><span class="line">#<span class="number">0</span>  connSocketRead (conn=<span class="number">0x7fcbeae150c0</span>, buf=<span class="number">0x7fcbeae7cfc5</span>, buf_len=<span class="number">16384</span>) at connection.c:<span class="number">182</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x000056041195df03</span> in <span class="title function_">connRead</span> <span class="params">(buf_len=&lt;optimized out&gt;, buf=&lt;optimized out&gt;, conn=&lt;optimized out&gt;)</span> at connection.h:152</span><br><span class="line">#2  <span class="title function_">readQueryFromClient</span> <span class="params">(conn=<span class="number">0x7fcbeae150c0</span>)</span> at networking.c:2026</span><br><span class="line">#3  0x00005604119e3e3c in <span class="title function_">callHandler</span> <span class="params">(handler=&lt;optimized out&gt;, conn=<span class="number">0x7fcbeae150c0</span>)</span> at connhelpers.h:79</span><br><span class="line">#4  <span class="title function_">connSocketEventHandler</span> <span class="params">(el=&lt;optimized out&gt;, fd=&lt;optimized out&gt;, clientData=<span class="number">0x7fcbeae150c0</span>, mask=&lt;optimized out&gt;)</span> at connection.c:296</span><br><span class="line">#5  0x0000560411942723 in <span class="title function_">aeProcessEvents</span> <span class="params">(eventLoop=eventLoop@entry=<span class="number">0x7fcbeae0b480</span>, flags=flags@entry=<span class="number">27</span>)</span> at ae.c:479</span><br><span class="line">#6  0x0000560411942a5d in <span class="title function_">aeMain</span> <span class="params">(eventLoop=<span class="number">0x7fcbeae0b480</span>)</span> at ae.c:539</span><br><span class="line">#7  0x000056041193eed8 in <span class="title function_">main</span> <span class="params">(argc=&lt;optimized out&gt;, argv=<span class="number">0x7ffc77472d58</span>)</span> at server.c:5498</span><br><span class="line"><span class="params">(gdb)</span> n</span><br><span class="line">	<span class="type">int</span> ret = read(conn-&gt;fd, buf, buf_len); <span class="comment">// 2ã€è°ƒç”¨read()è¯»å¥—æ¥å­—, å‘ç°è¿”å›å€¼retä¸º0ï¼Œä»è€Œæ„ŸçŸ¥åˆ°å¯¹ç«¯å·²å…³é—­è¿æ¥ã€‚</span></span><br><span class="line">(gdb) n</span><br><span class="line">	<span class="title function_">if</span> <span class="params">(!ret)</span> &#123;</span><br><span class="line">(gdb) p ret</span><br><span class="line">$<span class="number">2</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>2ã€<code>readQueryFromClient</code>ä¸­ï¼Œ<font color = 'red'>è°ƒç”¨read()è¯»å®¢æˆ·ç«¯å¥—æ¥å­—ï¼Œå‘ç°è¿”å›å€¼ä¸º0ï¼Œä»è€Œæ„ŸçŸ¥åˆ°å¯¹ç«¯å·²å…³é—­è¿æ¥</font>ï¼Œå†è°ƒç”¨å‡½æ•°<code>freeClientAsync</code>ï¼Œå¼‚æ­¥åœ°å…³é—­è¿™ä¸ªå®¢æˆ·ç«¯ã€‚<code>freeClientAsync</code>æºç å‚è€ƒï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">freeClientAsync</span><span class="params">(client *c)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (c-&gt;flags &amp; CLIENT_CLOSE_ASAP || c-&gt;flags &amp; CLIENT_LUA) <span class="keyword">return</span>;</span><br><span class="line">    c-&gt;flags |= CLIENT_CLOSE_ASAP;</span><br><span class="line">    <span class="keyword">if</span> (server.io_threads_num == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* no need to bother with locking if there&#x27;s just one thread (the main thread) */</span></span><br><span class="line">        listAddNodeTail(server.clients_to_close,c);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">static</span> <span class="type">pthread_mutex_t</span> async_free_queue_mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line">    pthread_mutex_lock(&amp;async_free_queue_mutex);</span><br><span class="line">    listAddNodeTail(server.clients_to_close,c);</span><br><span class="line">    pthread_mutex_unlock(&amp;async_free_queue_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºï¼Œ<code>freeClientAsync</code>çš„å®ç°å¾ˆç®€å•ï¼Œåªæ˜¯æŠŠè¿™ä¸ªå®¢æˆ·ç«¯åŠ å…¥æœåŠ¡å™¨é“¾è¡¨<code>clients_to_close</code>ï¼Œ å¹¶ä¸ç«‹å³é‡Šæ”¾è¿™ä¸ªå®¢æˆ·ç«¯ï¼Œæ‰€ä»¥è¯´æ˜¯<strong>å¼‚æ­¥</strong>åœ°å…³é—­ã€‚</p>
<ul>
<li>3ã€åœ¨ä¸‹ä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œè°ƒç”¨<code>freeClientsInAsyncFreeQueue</code>ä»æœåŠ¡å™¨é“¾è¡¨<code>clients_to_close</code>å–å‡ºå¾…é‡Šæ”¾çš„å®¢æˆ·ç«¯ï¼›å†è°ƒç”¨<code>freeClient</code>çœŸæ­£åœ°é‡Šæ”¾è¿™ä¸ªå®¢æˆ·ç«¯ï¼Œ<font color = 'red'>æ¥ç€è°ƒç”¨<code>pubsubUnsubscribeAllChannels</code>ä¿è¯è¿™ä¸ªå®¢æˆ·ç«¯çš„é¢‘é“å’Œæ¨¡å¼è®¢é˜…ä¿¡æ¯è¢«åŒæ­¥åˆ é™¤</font>ã€‚è°ƒç”¨é“¾ï¼š<code>aeMain -&gt; aeProcessEvents -&gt;  beforeSleep -&gt; freeClientsInAsyncFreeQueue -&gt; freeClient</code>, è°ƒç”¨æ ˆå‚è€ƒå¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  dictGenericDelete (d=<span class="number">0x7fcbeae0d2e0</span>, key=key@entry=<span class="number">0x7fcbeae0e360</span>, nofree=nofree@entry=<span class="number">0</span>) at dict.c:<span class="number">393</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000560411944bdf</span> in <span class="title function_">dictDelete</span> <span class="params">(ht=&lt;optimized out&gt;, key=key@entry=<span class="number">0x7fcbeae0e360</span>)</span> at dict.c:406</span><br><span class="line">#2  0x000056041198e2bf in <span class="title function_">pubsubUnsubscribeChannel</span> <span class="params">(c=c@entry=<span class="number">0x7fcbeaf4d700</span>, channel=<span class="number">0x7fcbeae0e360</span>, notify=notify@entry=<span class="number">0</span>)</span> at pubsub.c:198</span><br><span class="line">#3  0x000056041198e5bd in <span class="title function_">pubsubUnsubscribeAllChannels</span> <span class="params">(c=c@entry=<span class="number">0x7fcbeaf4d700</span>, notify=notify@entry=<span class="number">0</span>)</span> at pubsub.c:284</span><br><span class="line">#4  0x0000560411957cf7 in <span class="title function_">freeClient</span> <span class="params">(c=<span class="number">0x7fcbeaf4d700</span>)</span> at networking.c:1251</span><br><span class="line">#5  0x00005604119584fd in <span class="title function_">freeClientsInAsyncFreeQueue</span> <span class="params">()</span> at networking.c:1345</span><br><span class="line">#6  0x000056041194634b in <span class="title function_">beforeSleep</span> <span class="params">(eventLoop=&lt;optimized out&gt;)</span> at server.c:2204</span><br><span class="line">#7  <span class="title function_">beforeSleep</span> <span class="params">(eventLoop=&lt;optimized out&gt;)</span> at server.c:2117</span><br><span class="line">#8  0x00005604119425e8 in <span class="title function_">aeProcessEvents</span> <span class="params">(eventLoop=eventLoop@entry=<span class="number">0x7fcbeae0b480</span>, flags=flags@entry=<span class="number">27</span>)</span> at ae.c:443</span><br><span class="line">#9  0x0000560411942a5d in <span class="title function_">aeMain</span> <span class="params">(eventLoop=<span class="number">0x7fcbeae0b480</span>)</span> at ae.c:539</span><br><span class="line">#10 0x000056041193eed8 in <span class="title function_">main</span> <span class="params">(argc=&lt;optimized out&gt;, argv=<span class="number">0x7ffc77472d58</span>)</span> at server.c:5498</span><br></pre></td></tr></table></figure>

<p><code>freeClientsInAsyncFreeQueue</code>çš„æºç å®ç°å‚è€ƒå¦‚ä¸‹ï¼Œé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯ä»æœåŠ¡å™¨é“¾è¡¨<code>client_to_close</code>ä¸­ä¾æ¬¡å–å‡ºå¹¶é‡Šæ”¾æ‰€æœ‰çš„å®¢æˆ·ç«¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">freeClientsInAsyncFreeQueue</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> freed = <span class="number">0</span>;</span><br><span class="line">    listIter li;</span><br><span class="line">    listNode *ln;</span><br><span class="line"></span><br><span class="line">    listRewind(server.clients_to_close,&amp;li);	<span class="comment">// ä»clients_to_closeé“¾è¡¨ä¸­ä¾æ¬¡å–å‡ºæ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå¹¶é‡Šæ”¾è¿™ä¸ªå®¢æˆ·ç«¯ã€‚</span></span><br><span class="line">    <span class="keyword">while</span> ((ln = listNext(&amp;li)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        client *c = listNodeValue(ln);</span><br><span class="line">        <span class="keyword">if</span> (c-&gt;flags &amp; CLIENT_PROTECTED) <span class="keyword">continue</span>;</span><br><span class="line">        c-&gt;flags &amp;= ~CLIENT_CLOSE_ASAP;</span><br><span class="line">        freeClient(c);</span><br><span class="line">        listDelNode(server.clients_to_close,ln);</span><br><span class="line">        freed++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> freed;	<span class="comment">// è¿”å›é‡Šæ”¾çš„å®¢æˆ·ç«¯æ€»æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="æœåŠ¡å™¨æ­£å¸¸å…³é—­åœºæ™¯ï¼Œæ­£åœ¨è®¢é˜…çš„å®¢æˆ·ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥åˆ°æœåŠ¡å™¨ç¦»çº¿çš„ï¼Ÿ"><a href="#æœåŠ¡å™¨æ­£å¸¸å…³é—­åœºæ™¯ï¼Œæ­£åœ¨è®¢é˜…çš„å®¢æˆ·ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥åˆ°æœåŠ¡å™¨ç¦»çº¿çš„ï¼Ÿ" class="headerlink" title="æœåŠ¡å™¨æ­£å¸¸å…³é—­åœºæ™¯ï¼Œæ­£åœ¨è®¢é˜…çš„å®¢æˆ·ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥åˆ°æœåŠ¡å™¨ç¦»çº¿çš„ï¼Ÿ"></a>æœåŠ¡å™¨æ­£å¸¸å…³é—­åœºæ™¯ï¼Œæ­£åœ¨è®¢é˜…çš„å®¢æˆ·ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥åˆ°æœåŠ¡å™¨ç¦»çº¿çš„ï¼Ÿ<span id="jump9"></span></h4><p>è¿™é‡Œä»…è®¨è®ºæœåŠ¡å™¨æ­£å¸¸å…³é—­çš„åœºæ™¯ï¼Œå³å®¢æˆ·ç«¯å‘é€SHUTDOWNå‘½ä»¤å…³é—­æœåŠ¡ç«¯ã€‚æ­¤æ—¶æœåŠ¡ç«¯å°†æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li>1ã€æ¥å—å®¢æˆ·ç«¯çš„SHUTDOWNå‘½ä»¤ï¼Œè°ƒç”¨å‡½æ•°<code>shutdownCommand</code>å¤„ç†è¿™ä¸ªå…³é—­è¯·æ±‚ã€‚è°ƒç”¨é“¾<code>aeMain -&gt; processInputBuffer -&gt; shutdownCommand </code>ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  closeListeningSockets (unlink_unix_socket=<span class="number">1</span>) at server.c:<span class="number">3809</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000562ee4b31992</span> in <span class="title function_">prepareForShutdown</span> <span class="params">(flags=&lt;optimized out&gt;, flags@entry=<span class="number">0</span>)</span> at server.c:3916</span><br><span class="line">#2  0x0000562ee4b4bbdb in <span class="title function_">shutdownCommand</span> <span class="params">(c=<span class="number">0x7ff3c594dd80</span>)</span> at db.c:1061</span><br><span class="line">#3  0x0000562ee4b30701 in <span class="title function_">call</span> <span class="params">(c=<span class="number">0x7ff3c594dd80</span>, flags=<span class="number">15</span>)</span> at server.c:3368</span><br><span class="line">#4  0x0000562ee4b311c6 in <span class="title function_">processCommand</span> <span class="params">(c=c@entry=<span class="number">0x7ff3c594dd80</span>)</span> at server.c:3797</span><br><span class="line">#5  0x0000562ee4b3fca4 in <span class="title function_">processCommandAndResetClient</span> <span class="params">(c=c@entry=<span class="number">0x7ff3c594dd80</span>)</span> at networking.c:1895</span><br><span class="line">#6  0x0000562ee4b448fa in <span class="title function_">processInputBuffer</span> <span class="params">(c=<span class="number">0x7ff3c594dd80</span>)</span> at networking.c:1978</span><br><span class="line">#7  0x0000562ee4bcae3c in <span class="title function_">callHandler</span> <span class="params">(handler=&lt;optimized out&gt;, conn=<span class="number">0x7ff3c58150c0</span>)</span> at connhelpers.h:79</span><br><span class="line">#8  <span class="title function_">connSocketEventHandler</span> <span class="params">(el=&lt;optimized out&gt;, fd=&lt;optimized out&gt;, clientData=<span class="number">0x7ff3c58150c0</span>, mask=&lt;optimized out&gt;)</span> at connection.c:296</span><br><span class="line">#9  0x0000562ee4b29723 in <span class="title function_">aeProcessEvents</span> <span class="params">(eventLoop=eventLoop@entry=<span class="number">0x7ff3c580b480</span>, flags=flags@entry=<span class="number">27</span>)</span> at ae.c:479</span><br><span class="line">#10 0x0000562ee4b29a5d in <span class="title function_">aeMain</span> <span class="params">(eventLoop=<span class="number">0x7ff3c580b480</span>)</span> at ae.c:539</span><br><span class="line">#11 0x0000562ee4b25ed8 in <span class="title function_">main</span> <span class="params">(argc=&lt;optimized out&gt;, argv=<span class="number">0x7ffe9a269bf8</span>)</span> at server.c:5498</span><br></pre></td></tr></table></figure>

<ul>
<li>2ã€æ¥ç€è°ƒç”¨<code>closeListeningSockets</code>å…³é—­listenå¥—æ¥å­—ï¼Œä¹‹åå†è°ƒç”¨<code>exit</code>é€€å‡ºæœåŠ¡å™¨ç¨‹åºã€‚æºç å‚è€ƒå¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">closeListeningSockets</span><span class="params">(<span class="type">int</span> unlink_unix_socket)</span> &#123;</span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    <span class="comment">// è°ƒç”¨close(), å…³é—­æœåŠ¡ç«¯çš„listenå¥—æ¥å­—</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.ipfd_count; j++) close(server.ipfd[j]);</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.tlsfd_count; j++) close(server.tlsfd[j]);</span><br><span class="line">    <span class="keyword">if</span> (server.sofd != <span class="number">-1</span>) close(server.sofd);</span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled)</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; server.cfd_count; j++) close(server.cfd[j]);</span><br><span class="line">    <span class="keyword">if</span> (unlink_unix_socket &amp;&amp; server.unixsocket) &#123;</span><br><span class="line">        serverLog(LL_NOTICE,<span class="string">&quot;Removing the unix socket file.&quot;</span>);</span><br><span class="line">        unlink(server.unixsocket); <span class="comment">/* don&#x27;t care if this fails */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>3ã€å®¢æˆ·ç«¯é€šè¿‡æ­»å¾ªç¯è°ƒç”¨<code>redisGetReply</code>è·å–è®¢é˜…ä¿¡æ¯ï¼Œè€Œ<code>redisGetReply</code>æœ€ç»ˆæ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>recv</code>è¯»å–å¥—æ¥å­—æ•°æ®ï¼Œ<font color = 'red'>å½“æœåŠ¡å™¨è°ƒç”¨exité€€å‡ºåï¼Œå®¢æˆ·ç«¯çš„<code>recv</code>è°ƒç”¨ä¼šè¿”å›0ï¼Œä»è€Œæ„ŸçŸ¥åˆ°æœåŠ¡å™¨ç¦»çº¿ï¼Œ</font>æœ€ç»ˆè°ƒç”¨<code>exit</code>é€€å‡ºå®¢æˆ·ç«¯ç¨‹åºã€‚è°ƒç”¨æ ˆå‚è€ƒï¼š</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  0x00007ffff7e5d5b0 in __libc_recv (fd=3, buf=0x7fffffffa200, len=16384, flags=flags@entry=0) at ../sysdeps/unix/sysv/linux/recv.c:28</span><br><span class="line">#1  0x000055555558ec0b in recv (__flags=0, __n=&lt;optimized out&gt;, __buf=&lt;optimized out&gt;, __fd=&lt;optimized out&gt;)</span><br><span class="line">    at /usr/include/x86_64-linux-gnu/bits/socket2.h:44</span><br><span class="line">#2  redisNetRead (c=0x555555841300, buf=&lt;optimized out&gt;, bufcap=&lt;optimized out&gt;) at net.c:61</span><br><span class="line">#3  0x0000555555587702 in redisBufferRead (c=0x555555841300) at hiredis.c:881</span><br><span class="line">#4  0x0000555555587a92 in redisGetReply (c=0x555555841300, reply=0x7fffffffe280) at hiredis.c:954</span><br><span class="line">#5  0x000055555557fadd in cliReadReply (output_raw_strings=0) at redis-cli.c:1204</span><br><span class="line">#6  0x0000555555581e0d in cliSendCommand (argc=2, argv=0x7ffff780a000, repeat=0) at redis-cli.c:1361</span><br><span class="line">#7  0x0000555555582006 in issueCommandRepeat (argc=2, argv=0x7ffff780a000, repeat=1) at redis-cli.c:1858</span><br><span class="line">#8  0x000055555556dd8d in issueCommand (argv=0x7ffff780a000, argc=&lt;optimized out&gt;) at redis-cli.c:2090</span><br><span class="line">#9  noninteractive (argv=0x7ffff780a000, argc=&lt;optimized out&gt;) at redis-cli.c:2090</span><br><span class="line">#10 main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at redis-cli.c:8251</span><br></pre></td></tr></table></figure>



<h3 id="è°ƒè¯•æ–¹æ³•å‚è€ƒ"><a href="#è°ƒè¯•æ–¹æ³•å‚è€ƒ" class="headerlink" title="è°ƒè¯•æ–¹æ³•å‚è€ƒ"></a>è°ƒè¯•æ–¹æ³•å‚è€ƒ</h3><h4 id="1ã€é¢‘é“è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°å­—å…¸pubsub-channels-çš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š"><a href="#1ã€é¢‘é“è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°å­—å…¸pubsub-channels-çš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š" class="headerlink" title="1ã€é¢‘é“è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°å­—å…¸pubsub_channels çš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š"></a>1ã€é¢‘é“è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°å­—å…¸<code>pubsub_channels</code> çš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š<span id="jumpx"></span></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1ã€æ‰“å°pubsub_channelså­—å…¸</span></span><br><span class="line">(gdb) p *(server.pubsub_channels)</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  type = <span class="number">0x557a48da1160</span> &lt;keylistDictType&gt;,</span><br><span class="line">  privdata = <span class="number">0x0</span>,</span><br><span class="line">  ht = &#123;&#123;</span><br><span class="line">      table = <span class="number">0x7f4f0bc0e3a0</span>,</span><br><span class="line">      size = <span class="number">4</span>,</span><br><span class="line">      sizemask = <span class="number">3</span>,</span><br><span class="line">      used = <span class="number">2</span>				<span class="comment">// channelé¢‘é“æ€»æ•°ä¸º2</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      table = <span class="number">0x0</span>,</span><br><span class="line">      size = <span class="number">0</span>,</span><br><span class="line">      sizemask = <span class="number">0</span>,</span><br><span class="line">      used = <span class="number">0</span></span><br><span class="line">    &#125;&#125;,</span><br><span class="line">  rehashidx = <span class="number">-1</span>,</span><br><span class="line">  iterators = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">(gdb) p server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">0</span>]</span><br><span class="line">$<span class="number">2</span> = (dictEntry *) <span class="number">0x0</span></span><br><span class="line">(gdb) p server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">1</span>]</span><br><span class="line">$<span class="number">3</span> = (dictEntry *) <span class="number">0x7f4f0bc4b728</span></span><br><span class="line">(gdb) p server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">2</span>]</span><br><span class="line">$<span class="number">4</span> = (dictEntry *) <span class="number">0x7f4f0bc4b7d0</span></span><br><span class="line">(gdb) p server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">3</span>]</span><br><span class="line">$<span class="number">5</span> = (dictEntry *) <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.1 æ‰“å°æ‰€æœ‰çš„channelï¼Œæ­¤ä¾‹ä¸­channelä¸ªæ•°ä¸º2ï¼Œåˆ†åˆ«æ˜¯channel1, channel2</span></span><br><span class="line">(gdb) p (<span class="type">char</span> *)((robj *)(server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">1</span>].key)).ptr</span><br><span class="line">$<span class="number">6</span> = <span class="number">0x7f4f0bc0e373</span> <span class="string">&quot;channel1&quot;</span></span><br><span class="line">(gdb) p (<span class="type">char</span> *)((robj *)(server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">2</span>].key)).ptr</span><br><span class="line">$<span class="number">7</span> = <span class="number">0x7f4f0bc0e433</span> <span class="string">&quot;channel2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2ã€æ‰“å°æ¯ä¸ªchannelå¯¹åº”çš„å®¢æˆ·ç«¯é“¾è¡¨</span></span><br><span class="line">(gdb) p (<span class="built_in">list</span> *)server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">1</span>].v.val</span><br><span class="line">$<span class="number">8</span> = (<span class="built_in">list</span> *) <span class="number">0x7f4f0bc0fa20</span></span><br><span class="line"><span class="comment">// 2.1 é“¾è¡¨é•¿åº¦ä¸º2ï¼Œè¡¨ç¤ºæœ‰2ä¸ªå®¢æˆ·ç«¯æ­£åœ¨è®¢é˜…channel1é¢‘é“</span></span><br><span class="line">(gdb) p *(<span class="built_in">list</span> *)server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">1</span>].v.val</span><br><span class="line">$<span class="number">9</span> = &#123;</span><br><span class="line">  head = <span class="number">0x7f4f0bc4b740</span>,</span><br><span class="line">  tail = <span class="number">0x7f4f0bc4b7a0</span>,</span><br><span class="line">  dup = <span class="number">0x0</span>,</span><br><span class="line">  <span class="built_in">free</span> = <span class="number">0x0</span>,</span><br><span class="line">  match = <span class="number">0x0</span>,</span><br><span class="line">  len = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 2.2 é“¾è¡¨é•¿åº¦ä¸º2ï¼Œè¡¨ç¤ºæœ‰2ä¸ªå®¢æˆ·ç«¯æ­£åœ¨è®¢é˜…channel2é¢‘é“</span></span><br><span class="line">(gdb) p *(<span class="built_in">list</span> *)server.pubsub_channels.ht[<span class="number">0</span>].table[<span class="number">2</span>].v.val</span><br><span class="line">$<span class="number">10</span> = &#123;</span><br><span class="line">  head = <span class="number">0x7f4f0bc4b7e8</span>,</span><br><span class="line">  tail = <span class="number">0x7f4f0bc4b830</span>,</span><br><span class="line">  dup = <span class="number">0x0</span>,</span><br><span class="line">  <span class="built_in">free</span> = <span class="number">0x0</span>,</span><br><span class="line">  match = <span class="number">0x0</span>,</span><br><span class="line">  len = <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2ã€æ¨¡å¼è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°æ¨¡å¼é“¾è¡¨pubsub-patternså’Œæ¨¡å¼å­—å…¸pubsub-patterns-dictçš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š"><a href="#2ã€æ¨¡å¼è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°æ¨¡å¼é“¾è¡¨pubsub-patternså’Œæ¨¡å¼å­—å…¸pubsub-patterns-dictçš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š" class="headerlink" title="2ã€æ¨¡å¼è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°æ¨¡å¼é“¾è¡¨pubsub_patternså’Œæ¨¡å¼å­—å…¸pubsub_patterns_dictçš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š "></a>2ã€æ¨¡å¼è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°æ¨¡å¼é“¾è¡¨<code>pubsub_patterns</code>å’Œæ¨¡å¼å­—å…¸<code>pubsub_patterns_dict</code>çš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š <span id="jumpy"></span></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰“å°æ¨¡å¼é“¾è¡¨pubsub_patterns</span></span><br><span class="line">p *(server.pubsub_patterns)</span><br><span class="line">$<span class="number">3</span> = &#123;head = <span class="number">0x7f499144b740</span>, tail = <span class="number">0x7f499144b7d0</span>, dup = <span class="number">0x0</span>, <span class="built_in">free</span> = <span class="number">0x55c68a57c110</span> &lt;freePubsubPattern&gt;,</span><br><span class="line">  match = <span class="number">0x55c68a57c130</span> &lt;listMatchPubsubPattern&gt;, len = <span class="number">4</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾è¡¨é•¿åº¦ä¸º4</span></span><br><span class="line">(gdb) p (sds)(robj *)(((<span class="keyword">struct</span> pubsubPattern *)server.pubsub_patterns-&gt;head-&gt;value)-&gt;pattern)-&gt;ptr</span><br><span class="line">$<span class="number">12</span> = (sds) <span class="number">0x7f499140e353</span> <span class="string">&quot;pat1*&quot;</span></span><br><span class="line">(gdb) p (sds)(robj *)(((<span class="keyword">struct</span> pubsubPattern *)server.pubsub_patterns-&gt;head-&gt;next-&gt;value)-&gt;pattern)-&gt;ptr</span><br><span class="line">$<span class="number">13</span> = (sds) <span class="number">0x7f499140e3b3</span> <span class="string">&quot;pat2*&quot;</span></span><br><span class="line">(gdb) p (sds)(robj *)(((<span class="keyword">struct</span> pubsubPattern *)server.pubsub_patterns-&gt;head-&gt;next-&gt;next-&gt;value)-&gt;pattern)-&gt;ptr</span><br><span class="line">$<span class="number">14</span> = (sds) <span class="number">0x7f499140e3d3</span> <span class="string">&quot;pat3*&quot;</span></span><br><span class="line">(gdb) p (sds)(robj *)(((<span class="keyword">struct</span> pubsubPattern *)server.pubsub_patterns-&gt;head-&gt;next-&gt;next-&gt;next-&gt;value)-&gt;pattern)-&gt;ptr</span><br><span class="line">$<span class="number">15</span> = (sds) <span class="number">0x7f499140e413</span> <span class="string">&quot;pat3*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æ¨¡å¼å­—å…¸</span></span><br><span class="line">(gdb) p *server.pubsub_patterns_dict</span><br><span class="line">$<span class="number">16</span> = &#123;type = <span class="number">0x55c68a6ce160</span> &lt;keylistDictType&gt;, privdata = <span class="number">0x0</span>, ht = &#123;&#123;table = <span class="number">0x7f499140e380</span>, size = <span class="number">4</span>, sizemask = <span class="number">3</span>,</span><br><span class="line">      used = <span class="number">3</span>&#125;, &#123;table = <span class="number">0x0</span>, size = <span class="number">0</span>, sizemask = <span class="number">0</span>, used = <span class="number">0</span>&#125;&#125;, rehashidx = <span class="number">-1</span>, iterators = <span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—å…¸æœ‰3ä¸ªkey</span></span><br><span class="line">p (sds)((robj *)server.pubsub_patterns_dict-&gt;ht[<span class="number">0</span>].table[<span class="number">1</span>]-&gt;key)-&gt;ptr</span><br><span class="line">$<span class="number">27</span> = (sds) <span class="number">0x7f499140e353</span> <span class="string">&quot;pat1*&quot;</span></span><br><span class="line">(gdb) p (sds)((robj *)server.pubsub_patterns_dict-&gt;ht[<span class="number">0</span>].table[<span class="number">3</span>]-&gt;key)-&gt;ptr</span><br><span class="line">$<span class="number">28</span> = (sds) <span class="number">0x7f499140e3d3</span> <span class="string">&quot;pat3*&quot;</span></span><br><span class="line">(gdb) p (sds)((robj *)server.pubsub_patterns_dict-&gt;ht[<span class="number">0</span>].table[<span class="number">3</span>]-&gt;next-&gt;key)-&gt;ptr</span><br><span class="line">$<span class="number">29</span> = (sds) <span class="number">0x7f499140e3b3</span> <span class="string">&quot;pat2*&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="3ã€é€šè¿‡tcpdumpæŠ“åŒ…ï¼Œåˆ†æä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ã€è¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹"><a href="#3ã€é€šè¿‡tcpdumpæŠ“åŒ…ï¼Œåˆ†æä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ã€è¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹" class="headerlink" title="3ã€é€šè¿‡tcpdumpæŠ“åŒ…ï¼Œåˆ†æä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ã€è¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹ "></a>3ã€é€šè¿‡tcpdumpæŠ“åŒ…ï¼Œåˆ†æä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ã€è¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹ <span id="jumpz"></span></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tcpdump tcp port 6379 -X -i lo</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">ä¸‰æ¬¡æ¡æ‰‹</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SYN</span></span><br><span class="line">15:36:47.497450 IP localhost.50208 &gt; localhost.6379: Flags [S], seq 3233936820, win 65495, options [mss 65495,sackOK,TS val 3705662768 ecr 0,nop,wscale 7], length 0</span><br><span class="line">        0x0000:  4500 003c 84bd 4000 4006 b7fc 7f00 0001  E..&lt;..@.@.......</span><br><span class="line">        0x0010:  7f00 0001 c420 18eb c0c1 f5b4 0000 0000  ................</span><br><span class="line">        0x0020:  a002 ffd7 fe30 0000 0204 ffd7 0402 080a  .....0..........</span><br><span class="line">        0x0030:  dcdf ed30 0000 0000 0103 0307            ...0........</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SYN + ACK</span></span><br><span class="line">15:36:47.497456 IP localhost.6379 &gt; localhost.50208: Flags [S.], seq 4118461797, ack 3233936821, win 65483, options [mss 65495,sackOK,TS val 3705662768 ecr 3705662768,nop,wscale 7], length 0</span><br><span class="line">        0x0000:  4500 003c 0000 4000 4006 3cba 7f00 0001  E..&lt;..@.@.&lt;.....</span><br><span class="line">        0x0010:  7f00 0001 18eb c420 f57a bd65 c0c1 f5b5  .........z.e....</span><br><span class="line">        0x0020:  a012 ffcb fe30 0000 0204 ffd7 0402 080a  .....0..........</span><br><span class="line">        0x0030:  dcdf ed30 dcdf ed30 0103 0307            ...0...0....</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ACK</span></span><br><span class="line">15:36:47.497462 IP localhost.50208 &gt; localhost.6379: Flags [.], ack 1, win 512, options [nop,nop,TS val 3705662768 ecr 3705662768], length 0</span><br><span class="line">        0x0000:  4500 0034 84be 4000 4006 b803 7f00 0001  E..4..@.@.......</span><br><span class="line">        0x0010:  7f00 0001 c420 18eb c0c1 f5b5 f57a bd66  .............z.f</span><br><span class="line">        0x0020:  8010 0200 fe28 0000 0101 080a dcdf ed30  .....(.........0</span><br><span class="line">        0x0030:  dcdf ed30                                ...0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸‰æ¬¡æ¡æ‰‹ç»“æŸï¼Œè®¢é˜…çš„é•¿è¿æ¥å»ºç«‹</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼š<span class="string">&quot;subscribe channel1&quot;</span>ï¼Œé‡‡ç”¨RESPåè®®</span></span><br><span class="line">15:36:47.498719 IP localhost.50208 &gt; localhost.6379: Flags [P.], seq 1:34, ack 1, win 512, options [nop,nop,TS val 3705662770 ecr 3705662768], length 33: RESP &quot;subscribe&quot; &quot;channel1&quot;</span><br><span class="line">        0x0000:  4500 0055 84bf 4000 4006 b7e1 7f00 0001  E..U..@.@.......</span><br><span class="line">        0x0010:  7f00 0001 c420 18eb c0c1 f5b5 f57a bd66  .............z.f</span><br><span class="line">        0x0020:  8018 0200 fe49 0000 0101 080a dcdf ed32  .....I.........2</span><br><span class="line">        0x0030:  dcdf ed30 2a32 0d0a 2439 0d0a 7375 6273  ...0*2..$9..subs</span><br><span class="line">        0x0040:  6372 6962 650d 0a24 380d 0a63 6861 6e6e  cribe..$8..chann</span><br><span class="line">        0x0050:  656c 310d 0a                             el1..</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æœåŠ¡ç«¯çš„ACK</span></span><br><span class="line">15:36:47.498725 IP localhost.6379 &gt; localhost.50208: Flags [.], ack 34, win 512, options [nop,nop,TS val 3705662770 ecr 3705662770], length 0</span><br><span class="line">        0x0000:  4500 0034 d240 4000 4006 6a81 7f00 0001  E..4.@@.@.j.....</span><br><span class="line">        0x0010:  7f00 0001 18eb c420 f57a bd66 c0c1 f5d6  .........z.f....</span><br><span class="line">        0x0020:  8010 0200 fe28 0000 0101 080a dcdf ed32  .....(.........2</span><br><span class="line">        0x0030:  dcdf ed32                                ...2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æœåŠ¡ç«¯å›å¤è¯·æ±‚ï¼š<span class="string">&quot;subscribe channel1 1&quot;</span>ï¼Œé‡‡ç”¨RESPåè®®</span></span><br><span class="line">15:36:47.498803 IP localhost.6379 &gt; localhost.50208: Flags [P.], seq 1:38, ack 34, win 512, options [nop,nop,TS val 3705662770 ecr 3705662770], length 37: RESP &quot;subscribe&quot; &quot;channel1&quot; &quot;1&quot;</span><br><span class="line">        0x0000:  4500 0059 d241 4000 4006 6a5b 7f00 0001  E..Y.A@.@.j[....</span><br><span class="line">        0x0010:  7f00 0001 18eb c420 f57a bd66 c0c1 f5d6  .........z.f....</span><br><span class="line">        0x0020:  8018 0200 fe4d 0000 0101 080a dcdf ed32  .....M.........2</span><br><span class="line">        0x0030:  dcdf ed32 2a33 0d0a 2439 0d0a 7375 6273  ...2*3..$9..subs</span><br><span class="line">        0x0040:  6372 6962 650d 0a24 380d 0a63 6861 6e6e  cribe..$8..chann</span><br><span class="line">        0x0050:  656c 310d 0a3a 310d 0a                   el1..:1..</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®¢æˆ·ç«¯çš„ACK</span></span><br><span class="line">15:36:47.499058 IP localhost.50208 &gt; localhost.6379: Flags [.], ack 38, win 512, options [nop,nop,TS val 3705662770 ecr 3705662770], length 0</span><br><span class="line">        0x0000:  4500 0034 84c0 4000 4006 b801 7f00 0001  E..4..@.@.......</span><br><span class="line">        0x0010:  7f00 0001 c420 18eb c0c1 f5d6 f57a bd8b  .............z..</span><br><span class="line">        0x0020:  8010 0200 fe28 0000 0101 080a dcdf ed32  .....(.........2</span><br><span class="line">        0x0030:  dcdf ed32</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä»¥ä¸‹çœç•¥å®¢æˆ·ç«¯å¾ªç¯æ¥å—é¢‘é“æ¶ˆæ¯ï¼Œå››æ¬¡æŒ¥æ‰‹é‡Šæ”¾è¿æ¥çš„è¿‡ç¨‹......</span></span><br></pre></td></tr></table></figure>

<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p>ã€1ã€‘ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹ç¬¬18ç«  å‘å¸ƒä¸è®¢é˜… â€”â€” é»„å¥å®</p>
<p>ã€2ã€‘<a target="_blank" rel="noopener" href="https://www.cnblogs.com/yougewe/p/12349899.html">Redisï¼ˆåï¼‰ï¼špub&#x2F;sub å‘å¸ƒè®¢é˜…æºç è§£æ</a></p>
<p>ã€3ã€‘<a target="_blank" rel="noopener" href="https://blog.huangz.me/diary/2013/redis-pubsub-glob-pattern-example.html">Redis å‘å¸ƒä¸è®¢é˜…æ¨¡å¼åŒ¹é…ç¬¦ç¤ºä¾‹</a></p>
<p>ã€4ã€‘<a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-pub-sub.html">èœé¸Ÿæ•™ç¨‹ Redis å‘å¸ƒè®¢é˜…</a></p>
<p>ã€5ã€‘<a target="_blank" rel="noopener" href="https://redis.io/topics/protocol">Redisåè®®è§„èŒƒï¼ˆRESPï¼‰</a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    æ‰“èµ
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="PC å¾®ä¿¡æ”¯ä»˜">
        <p>å¾®ä¿¡æ”¯ä»˜</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="PC æ”¯ä»˜å®">
        <p>æ”¯ä»˜å®</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>PC
  </li>
  <li class="post-copyright-link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/" title="Rediså‘å¸ƒä¸è®¢é˜…æºç åˆ†æ">https://pcj600.github.io/2022/01/29/2022-01-29-redis-pubsub-study/</a>
  </li>
  <li class="post-copyright-license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/12/30/2021-12-30-redis-note-04-ziplist/" rel="prev" title="Rediså­¦ä¹ ç¬”è®°(å››)â€”â€”ziplist">
      <i class="fa fa-chevron-left"></i> Rediså­¦ä¹ ç¬”è®°(å››)â€”â€”ziplist
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/03/20/2022-03-20-trendmicro-job-interview/" rel="next" title="2022 Trend Micro ç¤¾æ‹›é¢ç»">
      2022 Trend Micro ç¤¾æ‹›é¢ç» <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%97%AE%E9%A2%98"><span class="nav-number">2.</span> <span class="nav-text">æ€è€ƒé—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.</span> <span class="nav-text">å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µä»‹ç»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E9%98%85%E9%A2%91%E9%81%93-%E2%80%94%E2%80%94-SUBSCRIBE%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.2.</span> <span class="nav-text">è®¢é˜…é¢‘é“ â€”â€” SUBSCRIBEå‘½ä»¤çš„å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#GDB%E6%89%93%E5%8D%B0%E9%A2%91%E9%81%93%E5%AD%97%E5%85%B8pubsub-channels%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.0.1.</span> <span class="nav-text">GDBæ‰“å°é¢‘é“å­—å…¸pubsub_channelsçš„æ–¹æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%80%E8%AE%A2%E9%A2%91%E9%81%93-%E2%80%94%E2%80%94-USUBSCRIBE%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.3.</span> <span class="nav-text">é€€è®¢é¢‘é“ â€”â€” USUBSCRIBEå‘½ä»¤çš„å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F-%E2%80%94%E2%80%94-PSUBSCRIBE%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.4.</span> <span class="nav-text">è®¢é˜…æ¨¡å¼ â€”â€” PSUBSCRIBEå‘½ä»¤çš„å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#GDB%E6%89%93%E5%8D%B0%E6%A8%A1%E5%BC%8F%E5%AD%97%E5%85%B8%E5%92%8C%E6%A8%A1%E5%BC%8F%E9%93%BE%E8%A1%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">2.4.0.1.</span> <span class="nav-text">GDBæ‰“å°æ¨¡å¼å­—å…¸å’Œæ¨¡å¼é“¾è¡¨çš„æ–¹æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%80%E8%AE%A2%E6%A8%A1%E5%BC%8F-%E2%80%94%E2%80%94-PUNSUBSCRIBE%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.5.</span> <span class="nav-text">é€€è®¢æ¨¡å¼ â€”â€” PUNSUBSCRIBEå‘½ä»¤çš„å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF-%E2%80%94%E2%80%94-PUBLISH%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.6.</span> <span class="nav-text">å‘é€æ¶ˆæ¯ â€”â€” PUBLISHå‘½ä»¤çš„å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%AE%BE%E8%AE%A1pubsub-patterns-dict%E5%AD%97%E5%85%B8%EF%BC%8C%E6%9C%89%E4%BB%80%E4%B9%88%E5%A5%BD%E5%A4%84%EF%BC%9F"><span class="nav-number">2.6.1.</span> <span class="nav-text">ä¸ºä»€ä¹ˆè®¾è®¡pubsub_patterns_dictå­—å…¸ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84Redis%E8%AE%A2%E9%98%85%E3%80%81%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.7.</span> <span class="nav-text">ä¸€æ¬¡å®Œæ•´çš„Redisè®¢é˜…ã€å‘å¸ƒæµç¨‹åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88redis-cli%E4%B8%AD%E6%89%A7%E8%A1%8C%E4%BA%86subscribe%E5%91%BD%E4%BB%A4%E5%90%8E%E6%97%A0%E6%B3%95%E5%86%8D%E6%89%A7%E8%A1%8Cunsubscribe%E5%91%BD%E4%BB%A4%EF%BC%9F"><span class="nav-number">2.7.1.</span> <span class="nav-text">ä¸ºä»€ä¹ˆredis-cliä¸­æ‰§è¡Œäº†subscribeå‘½ä»¤åæ— æ³•å†æ‰§è¡Œunsubscribeå‘½ä»¤ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCP%E6%98%AF%E6%B2%A1%E6%9C%89%E6%B6%88%E6%81%AF%E8%BE%B9%E7%95%8C%E7%9A%84%EF%BC%8C%E8%AE%A2%E9%98%85%E8%80%85%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%AD%A3%E7%A1%AE%E8%A7%A3%E6%9E%90%E5%8F%91%E5%B8%83%E8%80%85%E7%9A%84%E6%B6%88%E6%81%AF"><span class="nav-number">2.7.2.</span> <span class="nav-text">TCPæ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œè®¢é˜…è€…æ˜¯å¦‚ä½•ä¿è¯æ­£ç¡®è§£æå‘å¸ƒè€…çš„æ¶ˆæ¯?</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%99%84%EF%BC%9A%E4%B8%80%E6%AC%A1%E8%AE%A2%E9%98%85%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%EF%BC%8C%E8%AF%B7%E6%B1%82%E6%B6%88%E6%81%AF%E7%9A%84%E8%BF%87%E7%A8%8B%E6%8A%93%E5%8C%85%E7%BB%93%E6%9E%9C"><span class="nav-number">2.7.2.1.</span> <span class="nav-text">é™„ï¼šä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ï¼Œè¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹æŠ“åŒ…ç»“æœ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A2%E9%98%85%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%96%AD%E7%BA%BF%EF%BC%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%98%AF%E6%80%8E%E4%B9%88%E6%84%9F%E7%9F%A5%E7%9A%84%EF%BC%9F%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E8%BF%99%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E9%A2%91%E9%81%93%E3%80%81%E6%A8%A1%E5%BC%8F%E8%AE%A2%E9%98%85%E4%BF%A1%E6%81%AF%E4%B9%9F%E8%A2%AB%E5%90%8C%E6%AD%A5%E5%88%A0%E9%99%A4%EF%BC%9F"><span class="nav-number">2.7.3.</span> <span class="nav-text">è®¢é˜…çš„å®¢æˆ·ç«¯æ–­çº¿ï¼ŒæœåŠ¡ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥çš„ï¼Ÿå¦‚ä½•ä¿è¯è¿™ä¸ªå®¢æˆ·ç«¯çš„é¢‘é“ã€æ¨¡å¼è®¢é˜…ä¿¡æ¯ä¹Ÿè¢«åŒæ­¥åˆ é™¤ï¼Ÿ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%AD%A3%E5%B8%B8%E5%85%B3%E9%97%AD%E5%9C%BA%E6%99%AF%EF%BC%8C%E6%AD%A3%E5%9C%A8%E8%AE%A2%E9%98%85%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E6%80%8E%E4%B9%88%E6%84%9F%E7%9F%A5%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A6%BB%E7%BA%BF%E7%9A%84%EF%BC%9F"><span class="nav-number">2.7.4.</span> <span class="nav-text">æœåŠ¡å™¨æ­£å¸¸å…³é—­åœºæ™¯ï¼Œæ­£åœ¨è®¢é˜…çš„å®¢æˆ·ç«¯æ˜¯æ€ä¹ˆæ„ŸçŸ¥åˆ°æœåŠ¡å™¨ç¦»çº¿çš„ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95%E5%8F%82%E8%80%83"><span class="nav-number">2.8.</span> <span class="nav-text">è°ƒè¯•æ–¹æ³•å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E3%80%81%E9%A2%91%E9%81%93%E8%AE%A2%E9%98%85%E5%9C%BA%E6%99%AF%EF%BC%8C%E7%94%A8GDB%E6%89%93%E5%8D%B0%E5%AD%97%E5%85%B8pubsub-channels-%E7%9A%84%E6%96%B9%E6%B3%95%E5%8F%82%E8%80%83%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="nav-number">2.8.1.</span> <span class="nav-text">1ã€é¢‘é“è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°å­—å…¸pubsub_channels çš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E3%80%81%E6%A8%A1%E5%BC%8F%E8%AE%A2%E9%98%85%E5%9C%BA%E6%99%AF%EF%BC%8C%E7%94%A8GDB%E6%89%93%E5%8D%B0%E6%A8%A1%E5%BC%8F%E9%93%BE%E8%A1%A8pubsub-patterns%E5%92%8C%E6%A8%A1%E5%BC%8F%E5%AD%97%E5%85%B8pubsub-patterns-dict%E7%9A%84%E6%96%B9%E6%B3%95%E5%8F%82%E8%80%83%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="nav-number">2.8.2.</span> <span class="nav-text">2ã€æ¨¡å¼è®¢é˜…åœºæ™¯ï¼Œç”¨GDBæ‰“å°æ¨¡å¼é“¾è¡¨pubsub_patternså’Œæ¨¡å¼å­—å…¸pubsub_patterns_dictçš„æ–¹æ³•å‚è€ƒå¦‚ä¸‹ï¼š </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E3%80%81%E9%80%9A%E8%BF%87tcpdump%E6%8A%93%E5%8C%85%EF%BC%8C%E5%88%86%E6%9E%90%E4%B8%80%E6%AC%A1%E8%AE%A2%E9%98%85%E4%B8%AD%E7%9A%84%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E3%80%81%E8%AF%B7%E6%B1%82%E6%B6%88%E6%81%AF%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="nav-number">2.8.3.</span> <span class="nav-text">3ã€é€šè¿‡tcpdumpæŠ“åŒ…ï¼Œåˆ†æä¸€æ¬¡è®¢é˜…ä¸­çš„è¿æ¥å»ºç«‹ã€è¯·æ±‚æ¶ˆæ¯çš„è¿‡ç¨‹ </span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">2.9.</span> <span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="PC"
      src="/images/avatar.jpg">
  <!-- <p class="site-author-name" itemprop="name">PC</p> -->
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">126</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="/nju_pc@163.com" title="E-Mail â†’ nju_pc@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        



<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PC</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">354k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">5:22</span>
</div>

<!--
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>
-->

        
  <script async src="/js/busuanzi.js"></script>









      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right"},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2}});</script></body>
</html>

<script type="text/javascript" src="/js/clicklove.js"></script>
